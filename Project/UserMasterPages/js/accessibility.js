/**
 * Enhanced Accessibility Features
 * 
 * This file contains enhanced accessibility features including:
 * 1. Cursor size customization (small, medium, large)
 * 2. Custom cursor colors
 * 3. Reading guide opacity control
 * 4. Reading guide border style options
 * 5. Multiple contrast themes
 * 6. Keyboard shortcuts
 */

/**
 * School Accessibility Enhancement Script
 * @version 3.5.0
 */

// --- START NEW CODE: Define updateSchoolLogoBasedOnMode as an explicitly global function ---
// Function to update the school logo based on dark mode
window.updateSchoolLogoBasedOnMode = function () {
    const logo = document.querySelector('.school-logo'); // Find the logo
    if (logo) {
        const isDarkModeActive = document.documentElement.classList.contains('dark-mode');
        // Corrected paths to use lowercase 'l' consistent with list_dir results
        const lightModeLogo = 'images/logo.png';
        const darkModeLogo = 'images/logo2.png';

        // Get the base URL to construct absolute paths for comparison
        const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);
        const currentSrcAbsolute = new URL(logo.src).pathname; // Get absolute path of current src
        const lightModeLogoAbsolute = new URL(lightModeLogo, baseUrl).pathname;
        const darkModeLogoAbsolute = new URL(darkModeLogo, baseUrl).pathname;

        if (isDarkModeActive) {
            // Compare absolute paths to avoid issues with relative paths
            if (currentSrcAbsolute !== darkModeLogoAbsolute) {
                console.log('Switching logo to dark mode version');
                logo.src = darkModeLogo;
                logo.alt = logo.alt.replace("Light Mode", "Dark Mode"); // Update alt text if needed
            }
        } else {
            if (currentSrcAbsolute !== lightModeLogoAbsolute) {
                console.log('Switching logo to light mode version');
                logo.src = lightModeLogo;
                logo.alt = logo.alt.replace("Dark Mode", "Light Mode"); // Update alt text if needed
            }
        }
    } else {
        console.warn("updateSchoolLogoBasedOnMode: .school-logo element not found.");
    }
};
// --- END NEW CODE ---

// Global state object to track initialization
window.accessibilityState = {
    enhancedFeaturesInitialized: false,
    accessibilityInitialized: false,
    panelInitialized: false
};

// IIFE to prevent global scope pollution and ensure single initialization
(function () {
    // Function to ensure required DOM elements exist
    function ensureAccessibilityElements() {
        const body = document.body;

        // Check for and create accessibility button if needed
        if (!document.getElementById('accessibilityBtn')) {
            const btnDiv = document.createElement('div');
            btnDiv.className = 'accessibility-floating-btn';
            btnDiv.id = 'accessibilityBtn';
            btnDiv.innerHTML = '<button aria-label="Accessibility Options">♿</button>';
            body.appendChild(btnDiv);
        }

        // Check for and create accessibility panel if needed
        if (!document.getElementById('accessibilityPanel')) {
            const panel = document.createElement('div');
            panel.id = 'accessibilityPanel';
            panel.className = 'accessibility-panel';
            panel.innerHTML = '<!-- Panel content will be generated by JS -->';
            body.appendChild(panel);
        }

        // Check for and create reading guide if needed
        if (!document.getElementById('readingGuide')) {
            const guide = document.createElement('div');
            guide.id = 'readingGuide';
            body.appendChild(guide);
        }
    }

    // Function to apply ALL saved settings and sync UI controls
    function applyFullAccessibilitySettings() {
        console.log("Applying FULL accessibility settings and syncing UI...");
        const body = document.body;
        const html = document.documentElement;
        const panel = document.getElementById('accessibilityPanel'); // Find panel

        // Find all panel controls (add null checks)
        const fontSizeSlider = panel?.querySelector('#fontSizeSlider');
        // ... other controls ...
        const highContrastToggle = panel?.querySelector('#highContrastToggle');
        // ... etc ...
        const darkModeToggleBtn = document.getElementById('dark-mode-toggle'); // Find the button

        try {
            // --- Dark Mode State Synchronization ---
            const savedMode = localStorage.getItem('darkMode');
            const isDarkMode = savedMode === 'true';

            // Apply class (might be redundant, but safe)
            if (isDarkMode) {
                html.classList.add('dark-mode');
            } else {
                html.classList.remove('dark-mode');
            }

            // CRITICAL: Update the toggle button emoji to match the actual state
            if (darkModeToggleBtn && typeof updateDarkModeToggleEmoji === 'function') {
                // Use a small timeout to ensure DOM is fully ready if needed
                setTimeout(() => updateDarkModeToggleEmoji(isDarkMode, false), 0);
                console.log(`Synced Dark Mode Toggle: ${isDarkMode}`);
                window.updateSchoolLogoBasedOnMode();
            }
            // --- End Dark Mode Sync ---

            // Apply other settings (Font Size, Contrast, etc.)
            // Font Size
            const savedFontSize = localStorage.getItem('fontSize') || '100';
            body.style.fontSize = savedFontSize + '%';
            if (fontSizeSlider) fontSizeSlider.value = savedFontSize;
            // ... apply other settings from localStorage ...

            // High Contrast
            const highContrastEnabled = localStorage.getItem('highContrastEnabled') === 'true';
            if (highContrastEnabled) {
                body.classList.add('high-contrast');
                if (highContrastToggle) highContrastToggle.checked = true;
            } else {
                body.classList.remove('high-contrast');
                if (highContrastToggle) highContrastToggle.checked = false;
            }
            // ... apply other settings from localStorage ...

            // --- ADDED: Apply saved Reading Guide settings ---
            applySavedReadingGuideSettings();
            // --- END ADDED ---

            // Update panel controls from storage (if panel exists)
            if (typeof updatePanelControlsFromStorage === 'function') {
                updatePanelControlsFromStorage();
            }
        } catch (e) {
            console.error('Error applying settings:', e);
        }
    }

    // Function to apply saved settings
    function applySavedAccessibilitySettings() {
        if (!window.accessibilityState.enhancedFeaturesInitialized) {
            console.log("Enhanced features not initialized yet, deferring settings application...");
            return;
        }

        console.log("Applying saved accessibility settings...");

        try {
            // Apply dark mode directly
            const savedMode = localStorage.getItem('darkMode');
            if (savedMode === 'true') {
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
            }

            // Update dark mode toggle emoji
            const darkModeToggleBtn = document.getElementById('dark-mode-toggle');
            if (darkModeToggleBtn && typeof updateDarkModeToggleEmoji === 'function') {
                updateDarkModeToggleEmoji(savedMode === 'true', false);
            }

            // --- UPDATED: Use window.updateSchoolLogoBasedOnMode instead ---
            if (typeof window.updateSchoolLogoBasedOnMode === 'function') {
                window.updateSchoolLogoBasedOnMode();
            } else {
                console.warn("applySavedAccessibilitySettings: window.updateSchoolLogoBasedOnMode function not found.");
            }
            // --- END UPDATED ---

            // Apply other accessibility settings
            if (typeof window.applyFullAccessibilitySettings === 'function') {
                window.applyFullAccessibilitySettings();
            }
        } catch (e) {
            console.error('Error applying settings:', e);
        }
    }

    // Main initialization function
    function initializeAccessibility() {
        // Prevent multiple initializations if already done
        if (window.accessibilityState && window.accessibilityState.accessibilityInitialized) {
            console.log("Accessibility features already initialized. Skipping.");
            return;
        }
        // Initialize state object if it doesn't exist
        if (!window.accessibilityState) {
            window.accessibilityState = {};
        }

        console.log("Starting accessibility initialization...");

        // Ensure elements exist before trying to attach listeners or manipulate them
        ensureAccessibilityElements();
        applySavedAccessibilitySettings();
        setupAccessibilityKeyboardShortcuts();
        setupInfoIconObserver();

        // Initialize components that might depend on footer elements being present
        initFooterEnhancements();
        initTranslateButtonTooltip();
        // updateSchoolLogoBasedOnMode(); // REMOVED: Moved to applySavedAccessibilitySettings
        // --- ADDED: Apply saved Reading Guide settings early ---
        // Apply reading guide settings as soon as the basic structure is assumed ready
        applySavedReadingGuideSettings();
        // --- END ADDED ---

        // Link Footer "Open Settings" to panel toggle - Check elements exist first
        const footerLink = document.getElementById('openAccessibilityPanelLinkFooter');
        const panelButton = document.getElementById('accessibilityBtn'); // Keep this for potential future use or logging
        const panelElement = document.getElementById('accessibilityPanel'); // Get the panel element directly

        if (footerLink && panelElement) { // Check for footer link and panel
            footerLink.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default link behavior
                console.log('Footer link clicked, directly toggling panel class.');

                panelElement.classList.toggle('open'); // Directly toggle the class

                // --- ADDED: Manually replicate essential logic from button click handler when opening ---
                if (panelElement.classList.contains('open')) {
                    console.log("Panel opened via footer link.");
                    // Perform actions needed when panel opens (similar to button handler)
                    if (!panelContentGenerated) { // Check if content needs generation
                        console.log("Generating panel content for the first time (via footer link)...");
                        if (typeof initEnhancedAccessibility === 'function') {
                            initEnhancedAccessibility();
                        } else {
                            console.error("initEnhancedAccessibility function not found when trying to generate panel content via footer link.");
                        }
                        panelContentGenerated = true; // Mark as generated
                        console.log("Panel content generated and initialized (via footer link).");
                        if (typeof updatePanelControlsFromStorage === 'function') {
                            updatePanelControlsFromStorage(); // Update controls after generation
                        } else {
                            console.error("updatePanelControlsFromStorage function not found after generating panel content via footer link.");
                        }
                    } else {
                        console.log("Panel content already generated. Re-applying settings to controls (via footer link)...");
                        if (typeof updatePanelControlsFromStorage === 'function') {
                            updatePanelControlsFromStorage(); // Ensure controls are up-to-date
                            // Re-run specific enhancements if needed (mirroring button handler logic)
                            if (localStorage.getItem('largeCursorEnabled') === 'true' && typeof enhanceLargeCursorOptions === 'function') {
                                console.log("Re-running enhanceLargeCursorOptions on panel open (via footer).");
                                enhanceLargeCursorOptions();
                            }
                            if (localStorage.getItem('readingGuide') === 'true' && typeof enhanceReadingGuideOptions === 'function') {
                                console.log("Re-running enhanceReadingGuideOptions on panel open (via footer).");
                                enhanceReadingGuideOptions();
                                // --- ADDED: Load and apply settings *after* enhancing options ---
                                applySavedReadingGuideSettings();
                                // --- END ADDED ---
                                if (typeof setupReadingGuideTracking === 'function') {
                                    setupReadingGuideTracking();
                                    console.log("Activated Reading Guide tracking via panel open (via footer).");
                                }
                            }
                            if (localStorage.getItem('highContrastEnabled') === 'true' && typeof enhanceContrastModeOptions === 'function') {
                                console.log("Re-running enhanceContrastModeOptions on panel open (via footer).");
                                enhanceContrastModeOptions();
                            }
                        } else {
                            console.error("updatePanelControlsFromStorage function not found when reopening panel via footer link.");
                        }
                    }
                } else {
                    console.log("Panel closed via footer link toggle.");
                    // Perform actions needed when panel closes (if any)
                }
                // --- END ADDED ---

                // Old logic (commented out):
                // console.log('Footer link clicked, triggering panel button click.');
                // if (panelButton) {
                //     panelButton.click(); // Trigger the main button's click handler
                // } else {
                //     console.error("Cannot trigger main accessibility button click - button not found!");
                // }
            });
            console.log("Footer 'Open Settings' link event listener attached to directly toggle panel.");
        } else {
            // Log warnings only if the elements *should* exist on this page type
            if (!footerLink) console.warn("Footer link #openAccessibilityPanelLinkFooter not found during init.");
            // if (!panelButton) console.warn("Accessibility button #accessibilityBtn not found during init."); // Main button no longer strictly required for this specific listener
            if (!panelElement) console.error("CRITICAL: Accessibility panel #accessibilityPanel not found during init. Footer link cannot function.");
        }

        // Initialize enhanced features only if the function exists
        if (typeof initEnhancedAccessibility === 'function') {
            initEnhancedAccessibility();
        }

        window.accessibilityState.accessibilityInitialized = true;
        console.log("Accessibility features initialization complete.");
    }

    // Make functions globally available
    window.applySavedAccessibilitySettings = applySavedAccessibilitySettings;
    window.initializeAccessibility = initializeAccessibility;
    window.applyFullAccessibilitySettings = applyFullAccessibilitySettings;

    // Execute when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Running MAIN DOMContentLoaded listener...');
            initializeAccessibility();
        });
    } else {
        initializeAccessibility();
    }

    // Re-run initialization after a short delay to ensure everything is properly set up
    window.addEventListener('load', function () {
        setTimeout(initializeAccessibility, 500);
    });

    // Ensure footer enhancements run, even if main init ran earlier
    if (typeof initFooterEnhancements === 'function') {
        initFooterEnhancements();
    }

    // --- ADDED: Click outside listener --- 
    document.addEventListener('click', function (event) {
        const panel = document.getElementById('accessibilityPanel');
        const panelButton = document.getElementById('accessibilityBtn'); // The button DIV
        const chatbotContainer = document.querySelector('.chatbot-container');
        const chatbotTrigger = document.querySelector('.chatbot-trigger'); // The trigger DIV

        // Close Accessibility Panel if clicking outside
        if (panel && panel.classList.contains('open') &&
            !panel.contains(event.target) &&
            !panelButton?.contains(event.target)) { // Check if click is outside panel AND button
            panel.classList.remove('open');
            console.log("Closed accessibility panel by clicking outside.");
        }

        // Close Chatbot if clicking outside
        if (chatbotContainer && chatbotContainer.classList.contains('show-chatbot') &&
            !chatbotContainer.contains(event.target) &&
            !chatbotTrigger?.contains(event.target)) { // Check if click is outside chatbot AND trigger
            chatbotContainer.classList.remove('show-chatbot');
            console.log("Closed chatbot by clicking outside.");
        }
    }, true); // Use capture phase to catch clicks reliably
    // --- END ADDED --- 
})(); // Added missing closing parenthesis and semicolon
// --- ADDED: Function to Apply Saved Settings on Load ---
function applyFullAccessibilitySettings() {
    console.log("Applying full accessibility settings...");
    const body = document.body;
    const html = document.documentElement;

    // Find panel elements (might be null if panel hasn't been generated yet)
    const panel = document.getElementById('accessibilityPanel');
    const fontSizeSlider = panel?.querySelector('#fontSizeSlider');
    const fontSizeValue = panel?.querySelector('#fontSizeValue');
    const highContrastToggle = panel?.querySelector('#highContrastToggle');
    const contrastThemeSelector = panel?.querySelector('#contrastThemeSelector'); // Assuming an ID for theme select
    const focusHighlightToggle = panel?.querySelector('#focusHighlightToggle');
    const linksUnderlineToggle = panel?.querySelector('#linksUnderlineToggle');
    const wordSpacingSlider = panel?.querySelector('#wordSpacingSlider');
    const wordSpacingValue = panel?.querySelector('#wordSpacingValue');
    const dyslexiaFontToggle = panel?.querySelector('#dyslexiaFontToggle');
    const letterSpacingSlider = panel?.querySelector('#letterSpacingSlider');
    const letterSpacingValue = panel?.querySelector('#letterSpacingValue');
    const lineHeightSlider = panel?.querySelector('#lineHeightSlider');
    const lineHeightValue = panel?.querySelector('#lineHeightValue');
    const largeCursorToggle = panel?.querySelector('#largeCursorToggle');
    const cursorSizeSelector = panel?.querySelector('#cursorSizeSelector'); // Assuming an ID for cursor size
    const cursorColorPicker = panel?.querySelector('#cursorColorPicker'); // Assuming an ID for cursor color
    const cursorColorValue = panel?.querySelector('#cursorColorValue');
    const readingGuideToggle = panel?.querySelector('#readingGuideToggle');
    const readingGuideColorPicker = panel?.querySelector('#readingGuideColor');
    const readingGuideColorValue = panel?.querySelector('#readingGuideColorValue');
    const readingGuideHeightSlider = panel?.querySelector('#readingGuideHeightSlider');
    const readingGuideHeightValue = panel?.querySelector('#readingGuideHeightValue');
    const readingGuideOpacitySlider = panel?.querySelector('#readingGuideOpacitySlider'); // Assuming ID
    const readingGuideOpacityValue = panel?.querySelector('#readingGuideOpacityValue'); // Assuming ID
    const readingGuideBorderStyleSelector = panel?.querySelector('#readingGuideBorderStyle'); // Assuming ID


    function processChatbotInput(input) {
        // This function is kept for potential future expansion with more complex NLU.
        // For now, the primary logic is within getBotResponse.
        console.log("Processing input (basic):", input);
        // You could add basic intent recognition here later if needed.
        return getBotResponse(input); // Pass to the main response function
    }
    // 1. Dark Mode
    const savedMode = localStorage.getItem('darkMode');
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isDarkMode = savedMode === 'true' || (savedMode === null && prefersDark);
    if (isDarkMode) {
        body.classList.add('dark-mode');
        console.log("Applied saved setting: Dark Mode ON");
    } else {
        body.classList.remove('dark-mode');
    }
    // Update toggle emoji button regardless of panel existence
    setTimeout(() => updateDarkModeToggleEmoji(isDarkMode, false), 0);
    updateSchoolLogoBasedOnMode();

    // 2. Font Size
    const savedFontSize = localStorage.getItem('fontSize') || '100'; // Default to 100
    body.style.fontSize = savedFontSize + '%';
    console.log(`Applied saved setting: Font Size ${savedFontSize}%`);
    if (fontSizeSlider) fontSizeSlider.value = savedFontSize;
    if (fontSizeValue) fontSizeValue.textContent = savedFontSize + '%';

    // 3. High Contrast & Theme
    const highContrastEnabled = localStorage.getItem('highContrastEnabled') === 'true';
    const savedTheme = localStorage.getItem('contrastTheme') || 'black-white';
    if (highContrastEnabled) {
        body.classList.add('high-contrast', `theme-${savedTheme}`);
        if (savedTheme === 'custom' && typeof applyCustomContrastColors === 'function') {
            applyCustomContrastColors();
        }
        console.log(`Applied saved setting: High Contrast ON (Theme: ${savedTheme})`);
        // If high contrast is on, ensure dark mode is off
        if (body.classList.contains('dark-mode')) {
            body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'false');
            console.log("Corrected: Turned Dark Mode OFF due to High Contrast being ON.");
            setTimeout(() => updateDarkModeToggleEmoji(false, false), 0);
        }
    } else {
        body.classList.remove('high-contrast', 'theme-black-white', 'theme-custom');
    }
    if (highContrastToggle) highContrastToggle.checked = highContrastEnabled;
    if (contrastThemeSelector) contrastThemeSelector.value = savedTheme; // Update panel control

    // 4. Focus Highlight
    const focusHighlightEnabled = localStorage.getItem('focusHighlightEnabled') === 'true';
    if (focusHighlightEnabled) {
        body.classList.add('focus-highlight');
        console.log("Applied saved setting: Focus Highlight ON");
    }
    if (focusHighlightToggle) focusHighlightToggle.checked = focusHighlightEnabled;
    // 5. Links Underline
    const linksUnderlined = localStorage.getItem('linksUnderlined') === 'true';
    if (linksUnderlined) {
        body.classList.add('links-underlined');
        console.log("Applied saved setting: Links Underlined ON");
    }
    if (linksUnderlineToggle) linksUnderlineToggle.checked = linksUnderlined;

    // 6. Text Spacing (Word)
    const savedWordSpacing = localStorage.getItem('wordSpacing') || '0';
    body.style.wordSpacing = savedWordSpacing + 'em';
    console.log(`Applied saved setting: Word Spacing ${savedWordSpacing}em`);
    if (wordSpacingSlider) wordSpacingSlider.value = savedWordSpacing;
    if (wordSpacingValue) wordSpacingValue.textContent = savedWordSpacing + 'em';

    // 7. Dyslexia Font
    const dyslexiaFontEnabled = localStorage.getItem('dyslexiaFont') === 'true';
    if (dyslexiaFontEnabled) {
        body.classList.add('dyslexia-font');
        console.log("Applied saved setting: Dyslexia Font ON");
    }
    if (dyslexiaFontToggle) dyslexiaFontToggle.checked = dyslexiaFontEnabled;

    // 8. Letter Spacing
    const savedLetterSpacing = localStorage.getItem('letterSpacing') || '0';
    body.style.letterSpacing = savedLetterSpacing + 'px';
    console.log(`Applied saved setting: Letter Spacing ${savedLetterSpacing}px`);
    if (letterSpacingSlider) letterSpacingSlider.value = savedLetterSpacing;
    if (letterSpacingValue) letterSpacingValue.textContent = savedLetterSpacing + 'px';

    // 9. Line Height
    const savedLineHeight = localStorage.getItem('lineHeight') || '1.5';
    body.style.lineHeight = savedLineHeight;
    console.log(`Applied saved setting: Line Height ${savedLineHeight}`);
    if (lineHeightSlider) lineHeightSlider.value = savedLineHeight;
    if (lineHeightValue) lineHeightValue.textContent = savedLineHeight;

    // 10. Custom Cursor
    const largeCursorEnabled = localStorage.getItem('largeCursorEnabled') === 'true';
    const savedCursorSize = localStorage.getItem('cursorSize') || 'medium';
    const savedCursorColor = localStorage.getItem('cursorColor');
    if (largeCursorEnabled) {
        html.classList.remove('cursor-small', 'cursor-medium', 'cursor-large'); // Clear old size
        body.classList.remove('cursor-small', 'cursor-medium', 'cursor-large');
        html.classList.add(`cursor-${savedCursorSize}`);
        body.classList.add(`cursor-${savedCursorSize}`);
        console.log(`Applied saved setting: Large Cursor ON (Size: ${savedCursorSize})`);
        if (savedCursorColor && typeof setCursorColor === 'function') {
            setCursorColor(savedCursorColor); // Apply color directly
            console.log(`Applied saved setting: Cursor Color ${savedCursorColor}`);
        }
        // ACTIVATE NEEDED JS? Maybe requires enhanced options init?
        if (typeof enhanceLargeCursorOptions === 'function' && !window.accessibilityState.enhancedFeaturesInitialized) {
            // enhanceLargeCursorOptions(); // Consider if this needs selective activation
        }
    } else {
        html.classList.remove('cursor-small', 'cursor-medium', 'cursor-large');
        body.classList.remove('cursor-small', 'cursor-medium', 'cursor-large');
        if (typeof removeCursorStyles === 'function') removeCursorStyles();
    }
    if (largeCursorToggle) largeCursorToggle.checked = largeCursorEnabled;
    if (cursorSizeSelector) cursorSizeSelector.value = savedCursorSize; // Update panel
    if (cursorColorPicker) cursorColorPicker.value = savedCursorColor || '#000000'; // Default needed?
    if (cursorColorValue) cursorColorValue.textContent = savedCursorColor || '#000000';

    // 11. Reading Guide
    const readingGuideEnabled = localStorage.getItem('readingGuide') === 'true';
    const readingGuideElement = document.getElementById('readingGuide');
    const savedGuideColor = localStorage.getItem('readingGuideColor') || '#FFFF96';
    const savedGuideHeight = localStorage.getItem('readingGuideHeight') || '14';
    const savedGuideOpacity = localStorage.getItem('readingGuideOpacity') || '80';
    const savedGuideBorder = localStorage.getItem('readingGuideBorderStyle') || 'solid';

    if (readingGuideElement) {
        if (readingGuideEnabled) {
            readingGuideElement.style.display = 'block';
            readingGuideElement.style.backgroundColor = savedGuideColor; // Set color directly first
            readingGuideElement.style.height = savedGuideHeight + 'px';
            if (typeof setReadingGuideOpacity === 'function') setReadingGuideOpacity(savedGuideOpacity);
            if (typeof setReadingGuideBorder === 'function') setReadingGuideBorder(savedGuideBorder);
            console.log("Applied saved setting: Reading Guide ON");
            // Ensure tracking is active
            if (typeof setupReadingGuideTracking === 'function') {
                setupReadingGuideTracking(); // Call setup on load if enabled
                console.log("Activated Reading Guide tracking.");
            } else {
                console.warn("setupReadingGuideTracking function not found!");
            }
        } else {
            readingGuideElement.style.display = 'none';
            // Remove event listener if it exists and guide is disabled?
            // document.removeEventListener('mousemove', moveReadingGuide);
        }
    }
    // Update panel controls
    if (readingGuideToggle) readingGuideToggle.checked = readingGuideEnabled;
    if (readingGuideColorPicker) readingGuideColorPicker.value = savedGuideColor;
    if (readingGuideColorValue) readingGuideColorValue.textContent = savedGuideColor;
    if (readingGuideHeightSlider) readingGuideHeightSlider.value = savedGuideHeight;
    if (readingGuideHeightValue) readingGuideHeightValue.textContent = savedGuideHeight + 'px';
    if (readingGuideOpacitySlider) readingGuideOpacitySlider.value = savedGuideOpacity;
    if (readingGuideOpacityValue) readingGuideOpacityValue.textContent = savedGuideOpacity + '%';
    if (readingGuideBorderStyleSelector) readingGuideBorderStyleSelector.value = savedGuideBorder;

    console.log("Finished applying saved accessibility settings and updating panel controls (if found).");
}
// --- END MODIFIED Function ---

// --- END ADDED Function ---

// Ensure large cursor persists on page load - This part CAN run early
// Check localStorage and apply cursor class if needed.
(function () { // IIFE to avoid polluting global scope immediately
    const savedCursorSize = localStorage.getItem('cursorSize');
    if (savedCursorSize && ['small', 'medium', 'large'].includes(savedCursorSize)) {
        document.body.classList.add(`cursor-${savedCursorSize}`);
        document.documentElement.classList.add(`cursor-${savedCursorSize}`);
    }
    const savedCursorColor = localStorage.getItem('cursorColor');
    if (savedCursorColor) {
        document.documentElement.style.setProperty('--cursor-color', savedCursorColor);
    }
})(); // End IIFE

let mainInitializationDone = false; // Run once flag

// MAIN Document ready handler - SINGLE ENTRY POINT
document.addEventListener('DOMContentLoaded', function () {
    if (mainInitializationDone) {
        console.log("Main DOMContentLoaded listener already ran. Skipping.");
        return;
    }
    mainInitializationDone = true;
    console.log("Running MAIN DOMContentLoaded listener...");

    // --- Declare panel generated flag ---
    let panelContentGenerated = false;
    // --- End Declaration ---

    // --- Call the function to apply saved page settings EARLY ---
    applySavedAccessibilitySettings();
    // --- END Call ---

    const body = document.body;

    // --- Core Button Listeners START ---

    // Dark Mode Toggle Listener
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    if (darkModeToggle) {
        // Set initial state (already done by applySavedAccessibilitySettings, but let's sync the button)
        // const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        // const savedMode = localStorage.getItem('darkMode');
        // if (savedMode === 'true' || (savedMode === null && prefersDark)) {
        //    body.classList.add('dark-mode');
        // }
        updateDarkModeToggleEmoji(body.classList.contains('dark-mode'), false); // Update emoji based on applied state

        darkModeToggle.addEventListener('click', function () {
            const isDarkMode = body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            updateDarkModeToggleEmoji(isDarkMode, true);

            if (isDarkMode && body.classList.contains('high-contrast')) {
                const highContrastToggle = document.getElementById('highContrastToggle');
                if (highContrastToggle && highContrastToggle.checked) {
                    showTooltip('Disabling high contrast for dark mode compatibility', 3000);
                    highContrastToggle.checked = false;
                    const event = new Event('change');
                    highContrastToggle.dispatchEvent(event);
                }
            }
        }
        )

            ;
    } else {
        console.warn("Main DOMContentLoaded: Dark mode toggle button not found.");
    }

    // Accessibility Panel Listeners
    const accessibilityBtnDiv = document.getElementById('accessibilityBtn');
    const accessibilityPanelElement = document.getElementById('accessibilityPanel');

    if (accessibilityBtnDiv && accessibilityPanelElement) {
        const accessibilityBtn = accessibilityBtnDiv.querySelector('button'); // Find the button INSIDE the div
        if (accessibilityBtn) { // Check if the button exists
            accessibilityBtn.addEventListener('click', function () { // Attach listener to the BUTTON
                console.log("Accessibility button clicked.");
                // loadAccessibilityCSS(); // <-- Keep this removed

                const panel = document.getElementById('accessibilityPanel');
                if (!panel) {
                    console.error("Accessibility panel element not found after button click!");
                    return;
                }

                panel.classList.toggle('open');

                if (panel.classList.contains('open')) {
                    console.log("Panel opened.");
                    // Generate panel content only if it hasn't been generated before
                    if (!panelContentGenerated) {
                        console.log("Generating panel content for the first time...");
                        initEnhancedAccessibility(); // Initialize sliders, toggles etc.
                        panelContentGenerated = true;
                        console.log("Panel content generated and initialized.");
                        // --- ADDED: Update panel controls AFTER generating content ---
                        updatePanelControlsFromStorage();
                        // --- END ADDED ---
                    } else {
                        console.log("Panel content already generated. Re-applying settings to controls...");
                        // --- ADDED: Update panel controls every time panel opens ---
                        updatePanelControlsFromStorage();
                        // If enhanced features need re-initialization or specific updates on reopen, add here.
                        // For example, re-attach listeners if they were removed, or ensure dynamic elements are correct.
                        // Might need to call parts of initEnhancedAccessibility again selectively.
                        // Example: If cursor options need re-init
                        if (localStorage.getItem('largeCursorEnabled') === 'true' && typeof enhanceLargeCursorOptions === 'function') {
                            console.log("Re-running enhanceLargeCursorOptions on panel open.");
                            enhanceLargeCursorOptions();
                        }
                        if (localStorage.getItem('readingGuide') === 'true' && typeof enhanceReadingGuideOptions === 'function') {
                            console.log("Re-running enhanceReadingGuideOptions on panel open.");
                            enhanceReadingGuideOptions();
                            // --- ADDED: Activate tracking AFTER options are enhanced ---
                            if (typeof setupReadingGuideTracking === 'function') {
                                setupReadingGuideTracking();
                                console.log("Activated Reading Guide tracking via panel open.");
                            } else {
                                console.warn("setupReadingGuideTracking function not found!");
                            }
                            // --- END ADDED ---
                        }
                        if (localStorage.getItem('highContrastEnabled') === 'true' && typeof enhanceContrastModeOptions === 'function') {
                            console.log("Re-running enhanceContrastModeOptions on panel open.");
                            enhanceContrastModeOptions();
                        }

                    }
                } else {
                    console.log("Panel closed.");
                }
            });
        } else {
            console.warn("Main DOMContentLoaded: Accessibility trigger button (inside div #accessibilityBtn) not found.");
        }

    } else {
        // Updated warning message
        console.warn("Main DOMContentLoaded: Accessibility panel elements (#accessibilityBtn or #accessibilityPanel) not found.");
    }
    // --- Core Button Listeners END ---

    // Initialize other page elements that should run once on DOM load
    console.log("Attempting to initialize other components..."); // Debug log
    if (typeof initChatbot === 'function') {
        console.log("Calling initChatbot()..."); // Debug log
        initChatbot();
    } else {
        console.warn("initChatbot function not found during main init."); // Add warning
    }
    if (typeof initVirtualTour === 'function') initVirtualTour();
    if (typeof initEventsSection === 'function') initEventsSection();
    if (typeof initAchievementsCarousel === 'function') initAchievementsCarousel();
    if (typeof initNewsletterForm === 'function') initNewsletterForm();
    if (typeof initSocialMediaFeeds === 'function') initSocialMediaFeeds();
    if (typeof initTestimonialsCarousel === 'function') initTestimonialsCarousel();
    if (typeof initMapConnectivityCheck === 'function') initMapConnectivityCheck();

    console.log("MAIN DOMContentLoaded listener finished.");

    // --- ADDED: Initialize Footer Enhancements ---
    if (typeof initFooterEnhancements === 'function') {
        initFooterEnhancements();
    } else {
        console.warn('initFooterEnhancements function not found.');
    }
    // --- END ADDED ---

    // Initial large cursor application (remains from original logic)
    setTimeout(function () {
        const isLargeCursorEnabled = localStorage.getItem('largeCursorEnabled') === 'true';
        if (isLargeCursorEnabled) {
            const cursorSize = localStorage.getItem('cursorSize') || 'medium';
            const largeCursorToggle = document.getElementById('largeCursorToggle');
            if (largeCursorToggle) largeCursorToggle.checked = true;
            if (typeof setCursorSize === 'function') setCursorSize(cursorSize);
            console.log('Initial load: Applied large cursor: ' + cursorSize);
        }
    }, 500);

    // --- ADDED: Delayed re-initialization for potentially problematic pages --- 
    setTimeout(function () {
        console.log("Running delayed re-initialization check...");
        // Re-run core initialization if the main flag isn't set yet OR 
        // if enhanced features haven't initialized (might help on specific pages)
        if (!window.accessibilityState?.accessibilityInitialized || !window.accessibilityState?.enhancedFeaturesInitialized) {
            console.log("Attempting delayed initializeAccessibility()...");
            if (typeof initializeAccessibility === 'function') {
                initializeAccessibility();
            } else {
                console.error("Delayed Init: initializeAccessibility function not found!");
            }
        } else {
            console.log("Delayed Init: Main initialization seems complete.");
        }
        // Ensure dark mode toggle emoji is correct after potential delay
        const savedMode = localStorage.getItem('darkMode');
        if (typeof updateDarkModeToggleEmoji === 'function') {
            updateDarkModeToggleEmoji(savedMode === 'true', false);
        }
    }, 1200); // Increased delay (e.g., 1.2 seconds)
    // --- END ADDED ---
});

/**
 * Initializes THE INTERNAL accessibility features ONCE.
 * Called only when the panel is first opened.
 */
function initEnhancedAccessibility() {
    // --- MODIFIED: Check flag earlier and more robustly ---
    if (window.accessibilityState.enhancedFeaturesInitialized) {
        console.log("Enhanced features already initialized. Re-syncing controls and re-enhancing if needed.");
        const panelContent = document.querySelector('#accessibilityPanel .accessibility-panel-content');
        if (panelContent) {
            // Re-sync controls first
            if (typeof updatePanelControlsFromStorage === 'function') {
                updatePanelControlsFromStorage();
            }
            // Re-run enhance functions safely (they should have internal checks)
            console.log("Re-running enhance options for existing panel content.");
            if (typeof enhanceContrastModeOptions === 'function') enhanceContrastModeOptions();
            if (typeof enhanceReadingGuideOptions === 'function') enhanceReadingGuideOptions();
            if (typeof enhanceLargeCursorOptions === 'function') enhanceLargeCursorOptions();
            if (typeof setupInfoIcons === 'function') setupInfoIcons(panelContent); // Re-run tooltip setup scoped
        } else {
            console.warn("Panel content not found during re-initialization check.");
        }
        return; // Prevent re-running the full init and attaching core listeners again
    }
    console.log("Initializing ENHANCED accessibility features (generating panel content)...");

    const body = document.body;
    const accessibilityPanelElement = document.getElementById('accessibilityPanel');
    if (!accessibilityPanelElement) {
        console.error("Internal Init: Accessibility panel element (#accessibilityPanel) not found! Cannot initialize enhanced features.");
        return;
    }

    // --- Ensure Panel Structure (Header and Content Div) --- 
    let panelHeader = accessibilityPanelElement.querySelector('.accessibility-panel-header');
    if (!panelHeader) {
        panelHeader = document.createElement('div');
        panelHeader.className = 'accessibility-panel-header';
        panelHeader.innerHTML = `
            <h3>Accessibility Options</h3>
            <button class="close-btn" id="closeAccessibilityPanel">×</button>
        `;
        accessibilityPanelElement.insertBefore(panelHeader, accessibilityPanelElement.firstChild);

        const newCloseBtn = panelHeader.querySelector('#closeAccessibilityPanel');
        if (newCloseBtn) {
            newCloseBtn.addEventListener('click', function () {
                accessibilityPanelElement.classList.remove('open');
                console.log("Accessibility panel closed via dynamically added button.");
            });
        } else {
            console.warn("Could not find dynamically added close button to attach listener.");
        }
    }

    let panelContent = accessibilityPanelElement.querySelector('.accessibility-panel-content');
    if (!panelContent) {
        panelContent = document.createElement('div');
        panelContent.className = 'accessibility-panel-content';
        accessibilityPanelElement.appendChild(panelContent);
    }

    // --- Populate Panel Content if it's empty --- 
    if (panelContent.innerHTML.trim() === '') {
        console.log("Panel content is empty, populating with default HTML...");
        // (Keep the existing innerHTML content here from your file)
        panelContent.innerHTML = `
            <!-- Text Size -->
            <div class="accessibility-option text-size">
                <h4>Text Size</h4>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <input type="range" id="fontSizeSlider" min="70" max="150" step="5" value="100">
                        <span class="slider-value" id="fontSizeValue">100%</span>
                    </div>
                    <button class="reset-button" id="resetFontSize">Reset</button>
                </div>
            </div>
            
            <!-- Contrast Mode -->
            <div class="accessibility-option contrast">
                <h4>Contrast Mode <span class="info-icon" data-tooltip="High contrast mode makes text more visible with dark background and bright text">ⓘ</span></h4>
                <div class="toggle-container">
                    <label for="highContrastToggle">High Contrast</label>
                    <div style="width: 60px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="highContrastToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <!-- Contrast Theme Options will be added by enhanceContrastModeOptions -->
            </div>
            
            <!-- Reading Guide -->
            <div class="accessibility-option reading">
                <h4>Reading Guide <span class="info-icon" data-tooltip="Reading guide helps track text with a colored bar that follows your cursor">ⓘ</span></h4>
                <div class="toggle-container">
                    <label for="readingGuideToggle">Enable Reading Guide</label>
                    <div style="width: 60px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="readingGuideToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                <div class="color-picker-container" style="margin-top: 10px;">
                    <div class="color-picker-label">Guide Color:</div>
                    <div class="color-picker-wrapper">
                        <input type="color" id="readingGuideColor" class="color-picker" value="#FFFF96">
                        <span class="color-value" id="readingGuideColorValue">#FFFF96</span>
                    </div>
                </div>
                <div class="slider-container">
                    <label for="readingGuideHeightSlider">Guide Height: <span id="readingGuideHeightValue">14px</span></label>
                    <div class="slider-wrapper">
                        <input type="range" id="readingGuideHeightSlider" min="6" max="30" step="1" value="14">
                    </div>
                </div>
                 <!-- Opacity/Border options will be added by enhanceReadingGuideOptions -->
            </div>
            
            <!-- Focus Highlight -->
            <div class="accessibility-option focus">
                <h4>Focus Highlight <span class="info-icon" data-tooltip="Highlights focused elements when navigating with keyboard Tab key">ⓘ</span></h4>
                <div class="toggle-container">
                    <label for="focusHighlightToggle">Highlight Focused Elements</label>
                    <div style="width: 60px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="focusHighlightToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Links Underline -->
            <div class="accessibility-option links">
                <h4>Links Underline <span class="info-icon" data-tooltip="Makes all links underlined and colored for better visibility">ⓘ</span></h4>
                <div class="toggle-container">
                    <label for="linksUnderlineToggle">Underline All Links</label>
                    <div style="width: 60px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="linksUnderlineToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Text Spacing -->
            <div class="accessibility-option spacing">
                <h4>Text Spacing <span class="info-icon" data-tooltip="Increases space between words for easier reading">ⓘ</span></h4>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <input type="range" id="wordSpacingSlider" min="0" max="2" step="0.1" value="0">
                        <span class="slider-value" id="wordSpacingValue">0em</span>
                    </div>
                    <button class="reset-button" id="resetWordSpacing">Reset</button>
                </div>
            </div>
            
            <!-- Dyslexia-Friendly Font -->
            <div class="accessibility-option dyslexia">
                <h4>Dyslexia-Friendly Font <span class="info-icon" data-tooltip="Special font designed to help people with dyslexia read more easily">ⓘ</span></h4>
                <div class="toggle-container">
                    <label for="dyslexiaFontToggle">Enable Dyslexia Font</label>
                    <div style="width: 60px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="dyslexiaFontToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Letter Spacing -->
            <div class="accessibility-option letter-spacing">
                <h4>Letter Spacing <span class="info-icon" data-tooltip="Adds space between letters for improved readability">ⓘ</span></h4>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <input type="range" id="letterSpacingSlider" min="0" max="5" step="0.5" value="0">
                        <span class="slider-value" id="letterSpacingValue">0px</span>
                    </div>
                    <button class="reset-button" id="resetLetterSpacing">Reset</button>
                </div>
            </div>
            
            <!-- Line Height -->
            <div class="accessibility-option line-height">
                <h4>Line Height <span class="info-icon" data-tooltip="Increases space between lines of text for better readability">ⓘ</span></h4>
                <div class="slider-container">
                    <div class="slider-wrapper">
                        <input type="range" id="lineHeightSlider" min="1" max="2.5" step="0.1" value="1.5">
                        <span class="slider-value" id="lineHeightValue">1.5</span>
                    </div>
                    <button class="reset-button" id="resetLineHeight">Reset</button>
                </div>
            </div>
            
            <!-- Custom Cursor -->
            <div class="accessibility-option cursor">
                <h4>Custom Cursor <span class="info-icon" data-tooltip="Makes your mouse cursor larger for easier tracking">ⓘ</span></h4>
                <div class="toggle-container">
                    <label for="largeCursorToggle">Large Cursor</label>
                    <div style="width: 60px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="largeCursorToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                 <!-- Size/Color options will be added by enhanceLargeCursorOptions -->
            </div>
            
            <!-- Screen Reader -->
            <div class="accessibility-option screen-reader">
                <h4>Screen Reader</h4>
                <p>Screen reader compatibility is enabled by default.</p>
                <p><small>Use your preferred screen reader software.</small></p>
            </div>

             <!-- Reset Button -->
             <div class="accessibility-option reset-all">
                 <button id="resetAllSettings" class="reset-button" style="width: 100%; margin-top: 15px;">Reset All Settings</button>
             </div>
        `;
    } else {
        console.log("Panel content already exists.");
    }

    // --- Initialize Individual INTERNAL Panel Features within panelContent --- 
    console.log("Panel HTML populated/verified. Now initializing control listeners...");

    // 1. Text Size
    const fontSizeSlider = panelContent.querySelector('#fontSizeSlider');
    const fontSizeValue = panelContent.querySelector('#fontSizeValue');
    const resetFontSize = panelContent.querySelector('#resetFontSize');
    if (fontSizeSlider && fontSizeValue && resetFontSize) {
        // Initialize
        const savedFontSize = localStorage.getItem('fontSize') || '100';
        fontSizeSlider.value = savedFontSize;
        fontSizeValue.textContent = savedFontSize + '%';
        // Apply initial size (handled globally by applySavedAccessibilitySettings)

        // Add listener (only if not already attached)
        // --- MODIFIED: Added check --- 
        if (!fontSizeSlider.dataset.listenerAttached) {
            fontSizeSlider.addEventListener('input', function () {
                const size = this.value;
                // --- ADDED: Null check --- 
                if (fontSizeValue) fontSizeValue.textContent = size + '%';
                body.style.fontSize = size + '%';
                localStorage.setItem('fontSize', size);
            });
            resetFontSize.addEventListener('click', function () {
                fontSizeSlider.value = 100;
                // --- ADDED: Null check --- 
                if (fontSizeValue) fontSizeValue.textContent = '100%';
                body.style.fontSize = ''; // Reset to default
                localStorage.removeItem('fontSize');
            });
            // --- ADDED: Mark as attached --- 
            fontSizeSlider.dataset.listenerAttached = 'true';
            resetFontSize.dataset.listenerAttached = 'true'; // Mark both related elements
            console.log("Attached font size listeners.");
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Font size elements not found.');
    }

    // 2. High Contrast Mode (Toggles and Theme Options)
    if (typeof enhanceContrastModeOptions === 'function') {
        enhanceContrastModeOptions();
    } else {
        console.warn('Internal Init: enhanceContrastModeOptions function not found.');
    }

    // 3. Reading Guide (Toggle, Color, Height, Opacity, Border)
    if (typeof enhanceReadingGuideOptions === 'function') {
        enhanceReadingGuideOptions();
    } else {
        console.warn('Internal Init: enhanceReadingGuideOptions function not found.');
    }

    // 4. Focus Highlight
    const focusHighlightToggle = panelContent.querySelector('#focusHighlightToggle');
    if (focusHighlightToggle) {
        const savedFocusHighlight = localStorage.getItem('focusHighlightEnabled') === 'true';
        focusHighlightToggle.checked = savedFocusHighlight;
        // Apply initial state (already handled by applyFullAccessibilitySettings)

        // --- MODIFIED: Added check --- 
        if (!focusHighlightToggle.dataset.listenerAttached) {
            focusHighlightToggle.addEventListener('change', function () {
                if (typeof handleFocusHighlightToggle === 'function') {
                    handleFocusHighlightToggle(this.checked);
                }
            });
            // --- ADDED: Mark as attached --- 
            focusHighlightToggle.dataset.listenerAttached = 'true';
            console.log("Attached focus highlight listener.");
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Focus highlight toggle not found.');
    }

    // 5. Links Underline
    const linksUnderlineToggle = panelContent.querySelector('#linksUnderlineToggle');
    if (linksUnderlineToggle) {
        const savedLinksUnderlined = localStorage.getItem('linksUnderlined') === 'true';
        linksUnderlineToggle.checked = savedLinksUnderlined;
        // Apply initial state (already handled by applyFullAccessibilitySettings)

        // --- MODIFIED: Added check --- 
        if (!linksUnderlineToggle.dataset.listenerAttached) {
            linksUnderlineToggle.addEventListener('change', function () {
                if (typeof handleLinksUnderlineToggle === 'function') {
                    handleLinksUnderlineToggle(this.checked);
                }
            });
            // --- ADDED: Mark as attached --- 
            linksUnderlineToggle.dataset.listenerAttached = 'true';
            console.log("Attached links underline listener.");
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Links underline toggle not found.');
    }

    // 6. Text Spacing (Word)
    const wordSpacingSlider = panelContent.querySelector('#wordSpacingSlider');
    const wordSpacingValue = panelContent.querySelector('#wordSpacingValue');
    const resetWordSpacing = panelContent.querySelector('#resetWordSpacing');
    if (wordSpacingSlider && wordSpacingValue && resetWordSpacing) {
        // Initialize
        const savedWordSpacing = localStorage.getItem('wordSpacing') || '0';
        wordSpacingSlider.value = savedWordSpacing;
        wordSpacingValue.textContent = savedWordSpacing + 'em';
        // Add listener
        // --- MODIFIED: Added check --- 
        if (!wordSpacingSlider.dataset.listenerAttached) {
            wordSpacingSlider.addEventListener('input', function () {
                const spacing = this.value;
                // --- ADDED: Null check --- 
                if (wordSpacingValue) wordSpacingValue.textContent = spacing + 'em';
                body.style.wordSpacing = spacing + 'em';
                localStorage.setItem('wordSpacing', spacing);
            });
            resetWordSpacing.addEventListener('click', function () {
                wordSpacingSlider.value = 0;
                // --- ADDED: Null check --- 
                if (wordSpacingValue) wordSpacingValue.textContent = '0em';
                body.style.wordSpacing = '';
                localStorage.removeItem('wordSpacing');
            });
            // --- ADDED: Mark as attached --- 
            wordSpacingSlider.dataset.listenerAttached = 'true';
            resetWordSpacing.dataset.listenerAttached = 'true';
            console.log("Attached word spacing listeners.");
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Word spacing elements not found.');
    }

    // 7. Dyslexia Font
    const dyslexiaFontToggle = panelContent.querySelector('#dyslexiaFontToggle');
    if (dyslexiaFontToggle) {
        const dyslexiaFontEnabled = localStorage.getItem('dyslexiaFont') === 'true';
        dyslexiaFontToggle.checked = dyslexiaFontEnabled;
        // Apply initial state (already handled by applyFullAccessibilitySettings)
        // --- MODIFIED: Added check --- 
        if (!dyslexiaFontToggle.dataset.listenerAttached) {
            dyslexiaFontToggle.addEventListener('change', function () {
                if (typeof handleDyslexiaFontToggle === 'function') handleDyslexiaFontToggle(this.checked);
            });
            // --- ADDED: Mark as attached --- 
            dyslexiaFontToggle.dataset.listenerAttached = 'true';
            console.log("Attached dyslexia font listener.");
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Dyslexia font toggle not found.');
    }

    // 8. Letter Spacing
    const letterSpacingSlider = panelContent.querySelector('#letterSpacingSlider');
    const letterSpacingValue = panelContent.querySelector('#letterSpacingValue');
    const resetLetterSpacing = panelContent.querySelector('#resetLetterSpacing');
    if (letterSpacingSlider && letterSpacingValue && resetLetterSpacing) {
        // Initialize
        const savedLetterSpacing = localStorage.getItem('letterSpacing') || '0';
        letterSpacingSlider.value = savedLetterSpacing;
        letterSpacingValue.textContent = savedLetterSpacing + 'px';
        // Add listener
        // --- MODIFIED: Added check --- 
        if (!letterSpacingSlider.dataset.listenerAttached) {
            letterSpacingSlider.addEventListener('input', function () {
                const spacing = this.value;
                // --- ADDED: Null check --- 
                if (letterSpacingValue) letterSpacingValue.textContent = spacing + 'px';
                body.style.letterSpacing = spacing + 'px';
                localStorage.setItem('letterSpacing', spacing);
            });
            resetLetterSpacing.addEventListener('click', function () {
                letterSpacingSlider.value = 0;
                // --- ADDED: Null check --- 
                if (letterSpacingValue) letterSpacingValue.textContent = '0px';
                body.style.letterSpacing = '';
                localStorage.removeItem('letterSpacing');
            });
            // --- ADDED: Mark as attached --- 
            letterSpacingSlider.dataset.listenerAttached = 'true';
            resetLetterSpacing.dataset.listenerAttached = 'true';
            console.log("Attached letter spacing listeners.");
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Letter spacing elements not found.');
    }

    // 9. Line Height
    const lineHeightSlider = panelContent.querySelector('#lineHeightSlider');
    const lineHeightValue = panelContent.querySelector('#lineHeightValue');
    const resetLineHeight = panelContent.querySelector('#resetLineHeight');
    if (lineHeightSlider && lineHeightValue && resetLineHeight) {
        // Initialize
        const savedLineHeight = localStorage.getItem('lineHeight') || '1.5';
        lineHeightSlider.value = savedLineHeight;
        lineHeightValue.textContent = savedLineHeight;
        // Add listener
        // --- MODIFIED: Added check --- 
        if (!lineHeightSlider.dataset.listenerAttached) {
            lineHeightSlider.addEventListener('input', function () {
                const height = this.value;
                // --- ADDED: Null check --- 
                if (lineHeightValue) lineHeightValue.textContent = height;
                body.style.lineHeight = height;
                localStorage.setItem('lineHeight', height);
            });
            resetLineHeight.addEventListener('click', function () {
                const defaultLineHeight = 1.5;
                lineHeightSlider.value = defaultLineHeight;
                // --- ADDED: Null check --- 
                if (lineHeightValue) lineHeightValue.textContent = defaultLineHeight;
                body.style.lineHeight = '';
                localStorage.removeItem('lineHeight');
            });
            // --- ADDED: Mark as attached --- 
            lineHeightSlider.dataset.listenerAttached = 'true';
            resetLineHeight.dataset.listenerAttached = 'true';
            console.log("Attached line height listeners.");
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Line height elements not found.');
    }

    // 10. Custom Cursor (Size and Color Options)
    if (typeof enhanceLargeCursorOptions === 'function') {
        enhanceLargeCursorOptions();
    } else {
        console.warn('Internal Init: enhanceLargeCursorOptions function not found.');
    }

    // 11. Reset All Settings Button
    const resetAllButton = panelContent.querySelector('#resetAllSettings');
    if (resetAllButton) {
        // --- MODIFIED: Added check --- 
        if (!resetAllButton.dataset.listenerAttached) {
            if (typeof resetAllAccessibilitySettings === 'function') {
                resetAllButton.addEventListener('click', resetAllAccessibilitySettings);
                // --- ADDED: Mark as attached --- 
                resetAllButton.dataset.listenerAttached = 'true';
                console.log("Attached reset all listener.");
            } else {
                console.warn('Internal Init: resetAllAccessibilitySettings function missing for button.');
            }
        }
        // --- END MODIFICATION --- 
    } else {
        console.warn('Internal Init: Reset all button not found.');
    }

    // 12. Setup Info Icons Tooltips
    if (typeof setupInfoIcons === 'function') {
        setupInfoIcons(panelContent); // Pass panelContent to scope the search
    } else {
        console.warn('Internal Init: setupInfoIcons function not found.');
    }

    // 13. Setup Keyboard Shortcuts (Should only be setup once globally, check if already done)
    if (!window.accessibilityKeyboardShortcutsInitialized && typeof setupAccessibilityKeyboardShortcuts === 'function') {
        setupAccessibilityKeyboardShortcuts();
        window.accessibilityKeyboardShortcutsInitialized = true;
    }

    // 14. Reading Guide Tracking setup is handled within enhanceReadingGuideOptions

    console.log("INTERNAL accessibility features initialization complete.");

    // Update panel controls from storage AFTER attaching listeners
    updatePanelControlsFromStorage();

    // Set flag only after successful initialization
    window.accessibilityState.enhancedFeaturesInitialized = true;
    console.log("Enhanced features initialization flag set to true.");
}

// Explicitly expose to window
window.initEnhancedAccessibility = initEnhancedAccessibility;

// --- NEW HELPER FUNCTIONS ---

// Function to handle focus highlight toggle
function handleFocusHighlightToggle(isEnabled) {
    if (isEnabled) {
        document.body.classList.add('focus-highlight');
        localStorage.setItem('focusHighlightEnabled', 'true');
        showTooltip('Focus Highlight Enabled', 2000);
    } else {
        document.body.classList.remove('focus-highlight');
        localStorage.setItem('focusHighlightEnabled', 'false');
        showTooltip('Focus Highlight Disabled', 2000);
    }
}

// Function to handle links underline toggle
function handleLinksUnderlineToggle(isEnabled) {
    if (isEnabled) {
        document.body.classList.add('links-underlined');
        localStorage.setItem('linksUnderlined', 'true');
        showTooltip('Links Underlined Enabled', 2000);
    } else {
        document.body.classList.remove('links-underlined');
        localStorage.setItem('linksUnderlined', 'false');
        showTooltip('Links Underlined Disabled', 2000);
    }
}

// --- END NEW HELPER FUNCTIONS ---

// Fix for the panel toggle bug
function fixPanelToggleBug() {
    // Get the accessibility floating button and panel
    const accessibilityBtn = document.querySelector('.accessibility-floating-btn button');
    const accessibilityPanel = document.getElementById('accessibilityPanel');

    if (accessibilityBtn && accessibilityPanel) {
        accessibilityBtn.addEventListener('click', function () {
            // This runs when opening the panel

            // Check if the large cursor toggle exists
            const largeCursorToggle = document.getElementById('largeCursorToggle');
            if (largeCursorToggle) {
                // Get the current state from local storage or default to false
                const isLargeCursorEnabled = localStorage.getItem('largeCursorEnabled') === 'true';

                // Make sure the toggle matches the stored state
                largeCursorToggle.checked = isLargeCursorEnabled;

                // Force apply cursor styles based on the toggle state
                if (isLargeCursorEnabled) {
                    const cursorSize = localStorage.getItem('cursorSize') || 'medium';
                    setCursorSize(cursorSize);
                } else {
                    removeCursorStyles();
                }
            }
        });
    }

    // When the panel is closed, make sure the cursor persists if enabled
    const closeBtn = document.querySelector('.close-btn');
    if (closeBtn) {
        closeBtn.addEventListener('click', function () {
            // Check if the large cursor is enabled
            const isLargeCursorEnabled = localStorage.getItem('largeCursorEnabled') === 'true';
            if (isLargeCursorEnabled) {
                // Reapply the cursor after a small delay (after panel close animation)
                setTimeout(function () {
                    const cursorSize = localStorage.getItem('cursorSize') || 'medium';
                    setCursorSize(cursorSize);
                }, 300);
            }
        });
    }
}

// 1. LARGE CURSOR ENHANCEMENT
function enhanceLargeCursorOptions() {
    const cursorOption = document.querySelector('.accessibility-option.cursor');
    if (!cursorOption) {
        console.warn("enhanceLargeCursorOptions: Cursor option section not found.");
        return;
    }
    const panelContent = cursorOption.closest('.accessibility-panel-content');
    if (!panelContent) {
        console.warn("enhanceLargeCursorOptions: Could not find parent panel content.");
        return;
    }

    // Check if controls already exist
    let sizeControls = cursorOption.querySelector('.cursor-size-controls');
    let colorPickerContainer = cursorOption.querySelector('.color-picker-container');

    if (!sizeControls) {
        console.log("Creating large cursor size controls.");
        const cursorSizeHtml = `
        <div class="button-group cursor-size-controls">
            <button class="cursor-size-btn" data-size="small">Small</button>
            <button class="cursor-size-btn" data-size="medium">Medium</button>
            <button class="cursor-size-btn" data-size="large">Large</button>
        </div>
    `;
        const toggleContainer = cursorOption.querySelector('.toggle-container');
        if (toggleContainer) {
            toggleContainer.insertAdjacentHTML('afterend', cursorSizeHtml);
            sizeControls = cursorOption.querySelector('.cursor-size-controls'); // Re-select
        } else {
            console.error("enhanceLargeCursorOptions: Could not find toggle container to insert size controls.");
            return;
        }
    } else {
        console.log("Large cursor size controls already exist.");
    }

    if (!colorPickerContainer) {
        console.log("Creating large cursor color picker.");
        const cursorColorHtml = `
        <div class="color-picker-container">
            <div class="color-picker-label">Cursor Color:</div>
            <div class="color-picker-wrapper">
                <input type="color" id="cursorColorPicker" class="color-picker" value="${localStorage.getItem('cursorColor') || '#85C0FF'}">
                <span class="color-value" id="cursorColorValue">${localStorage.getItem('cursorColor') || '#85C0FF'}</span>
            </div>
        </div>
    `;
        // Insert after size controls (or toggle if size controls failed to insert)
        const insertAfterElement = sizeControls || cursorOption.querySelector('.toggle-container');
        if (insertAfterElement) {
            insertAfterElement.insertAdjacentHTML('afterend', cursorColorHtml);
            colorPickerContainer = cursorOption.querySelector('.color-picker-container'); // Re-select
        } else {
            console.error("enhanceLargeCursorOptions: Could not find element to insert color picker after.");
            return;
        }
    } else {
        console.log("Large cursor color picker already exists.");
    }

    // Add event listeners (ensure idempotency or single call)
    // Size Buttons Listener
    const cursorSizeButtons = cursorOption.querySelectorAll('.cursor-size-btn');
    if (cursorSizeButtons.length > 0 && !cursorSizeButtons[0].dataset.listenerAttached) {
        cursorSizeButtons.forEach(button => {
            button.addEventListener('click', function () {
                cursorSizeButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                const size = this.getAttribute('data-size');
                // --- ADDED: Check function exists --- 
                if (typeof setCursorSize === 'function') {
                    setCursorSize(size); // Saves size to localStorage
                } else {
                    console.warn("setCursorSize function not found.");
                }
                showTooltip(`Cursor size set to ${size}`, 2000, 'cursor-notification');
                const largeCursorToggle = panelContent.querySelector('#largeCursorToggle');
                // --- ADDED: Null check --- 
                if (largeCursorToggle && !largeCursorToggle.checked) {
                    setTimeout(() => {
                        showTooltip('Enable the custom cursor toggle to activate this setting', 3000, 'cursor-notification');
                    }, 2200);
                }
            });
            button.dataset.listenerAttached = 'true'; // Mark as attached
        });
        console.log("Attached listeners to large cursor size buttons.");
    } else if (cursorSizeButtons.length === 0) {
        console.warn("enhanceLargeCursorOptions: Size buttons not found, cannot attach listeners.");
    }

    // Color Picker Listener
    const cursorColorPicker = cursorOption.querySelector('#cursorColorPicker');
    const cursorColorValue = cursorOption.querySelector('#cursorColorValue');
    // --- MODIFIED: Combined null check --- 
    if (cursorColorPicker && cursorColorValue && !cursorColorPicker.dataset.listenerAttached) {
        cursorColorPicker.addEventListener('input', function () {
            // --- ADDED: Null check --- 
            if (cursorColorValue) cursorColorValue.textContent = this.value;
            // --- ADDED: Check function exists --- 
            if (typeof setCursorColor === 'function') {
                setCursorColor(this.value); // Saves color to localStorage
            } else {
                console.warn("setCursorColor function not found.");
            }
            const largeCursorToggle = panelContent.querySelector('#largeCursorToggle');
            // --- ADDED: Null check --- 
            if (largeCursorToggle && !largeCursorToggle.checked) {
                showTooltip('Enable the custom cursor toggle to see your color changes', 3000, 'cursor-notification');
            } else {
                showTooltip(`Cursor color updated to ${this.value}`, 2000, 'cursor-notification');
            }
        });
        cursorColorPicker.dataset.listenerAttached = 'true'; // Mark as attached
        console.log("Attached listener to large cursor color picker.");
    } else if (!cursorColorPicker || !cursorColorValue) {
        console.warn("enhanceLargeCursorOptions: Color picker or value span not found, cannot attach listener.");
    }

    // Toggle Listener
    const largeCursorToggle = panelContent.querySelector('#largeCursorToggle');
    // --- MODIFIED: Null check before attaching listener --- 
    if (largeCursorToggle && !largeCursorToggle.dataset.listenerAttached) {
        largeCursorToggle.addEventListener('change', function () {
            localStorage.setItem('largeCursorEnabled', this.checked); // Save state first
            if (this.checked) {
                const currentSize = localStorage.getItem('cursorSize') || 'medium';
                // --- ADDED: Check function exists --- 
                if (typeof setCursorSize === 'function') {
                    setCursorSize(currentSize); // Apply size (implicitly applies color)
                } else {
                    console.warn("setCursorSize function not found.");
                }
                showTooltip(`Custom cursor enabled (Size: ${currentSize})`, 2000);
                // Ensure button active state is correct
                const sizeButtons = cursorOption.querySelectorAll('.cursor-size-btn');
                // --- ADDED: Null check --- 
                if (sizeButtons.length > 0) {
                    sizeButtons.forEach(btn => btn.classList.remove('active'));
                    const activeBtn = cursorOption.querySelector(`.cursor-size-btn[data-size="${currentSize}"]`);
                    // --- ADDED: Null check --- 
                    if (activeBtn) activeBtn.classList.add('active');
                } else {
                    console.warn("Could not find size buttons to update active state.");
                }

            } else {
                // --- ADDED: Check function exists --- 
                if (typeof removeCursorStyles === 'function') {
                    removeCursorStyles();
                } else {
                    console.warn("removeCursorStyles function not found.");
                }
                showTooltip('Custom cursor disabled', 2000);
            }
        });
        largeCursorToggle.dataset.listenerAttached = 'true'; // Mark as attached
        console.log("Attached listener to large cursor toggle.");
    } else if (!largeCursorToggle) {
        console.warn("enhanceLargeCursorOptions: Large cursor toggle not found, cannot attach listener.");
    }

    // Set initial state (already handled by updatePanelControlsFromStorage)
    console.log("enhanceLargeCursorOptions finished.");
}

// Function to remove cursor styles
function removeCursorStyles() {
    // Remove cursor classes from document and body
    document.documentElement.classList.remove('cursor-small', 'cursor-medium', 'cursor-large');
    document.body.classList.remove('cursor-small', 'cursor-medium', 'cursor-large');

    // Remove custom cursor style tag if it exists
    const styleTag = document.getElementById('custom-cursor-style');
    if (styleTag) {
        styleTag.textContent = '';
    }

    console.log('Enhanced accessibility: Custom cursor disabled');
}

// Helper function to set cursor size
function setCursorSize(size) {
    console.log(`Attempting to set cursor size to ${size}`);
    localStorage.setItem('cursorSize', size); // Save preference immediately

    // Only apply cursor size if large cursor toggle is checked
    // --- MODIFIED: Query within function context if possible, or use global --- 
    const largeCursorToggle = document.getElementById('largeCursorToggle'); // Assuming global ID is reliable here
    // --- ADDED: Null check --- 
    if (largeCursorToggle && largeCursorToggle.checked) {
        console.log(`Applying cursor size ${size} because toggle is checked.`);
        // Remove any existing cursor size classes
        document.documentElement.classList.remove('cursor-small', 'cursor-medium', 'cursor-large');
        document.body.classList.remove('cursor-small', 'cursor-medium', 'cursor-large');

        // Add appropriate class based on size
        document.documentElement.classList.add(`cursor-${size}`);
        document.body.classList.add(`cursor-${size}`);

        // Apply the custom cursor color immediately
        const savedColor = localStorage.getItem('cursorColor') || '#85C0FF'; // Default blue
        // --- ADDED: Check function exists --- 
        if (typeof setCursorColor === 'function') {
            setCursorColor(savedColor); // This function should handle applying the actual cursor style
        } else {
            console.warn("setCursorColor function not found when setting size.");
        }
    } else {
        console.log(`Cursor size ${size} NOT applied because toggle is unchecked or missing.`);
        // If toggle is not checked, remove all cursor classes
        // --- ADDED: Check function exists --- 
        if (typeof removeCursorStyles === 'function') {
            removeCursorStyles();
        } else {
            console.warn("removeCursorStyles function not found when setting size.");
        }
    }

    // Activate the right button visually in the panel
    // --- MODIFIED: More robust check for panel elements --- 
    const panelContent = document.querySelector('#accessibilityPanel .accessibility-panel-content');
    if (panelContent) {
        const cursorOption = panelContent.querySelector('.accessibility-option.cursor');
        if (cursorOption) {
            const cursorSizeButtons = cursorOption.querySelectorAll('.cursor-size-btn');
            // --- ADDED: Null check --- 
            if (cursorSizeButtons.length > 0) {
                cursorSizeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-size') === size) {
                        btn.classList.add('active');
                    }
                });
            } else {
                console.warn("setCursorSize: Could not find size buttons within cursor option.");
            }
        } else {
            console.warn("setCursorSize: Could not find cursor option section within panel content.");
        }
    } else {
        console.warn("setCursorSize: Could not find panel content to update buttons.");
    }

    console.log(`Enhanced accessibility: Cursor size preference set to ${size}`);
}

// Helper function to set cursor color
function setCursorColor(color) {
    console.log(`Attempting to set cursor color to ${color}`);
    localStorage.setItem('cursorColor', color); // Save preference immediately

    // Check if large cursor toggle is enabled
    // --- MODIFIED: Query within function context if possible, or use global --- 
    const largeCursorToggle = document.getElementById('largeCursorToggle'); // Assuming global ID is reliable here
    // --- ADDED: Null check --- 
    if (!(largeCursorToggle && largeCursorToggle.checked)) {
        console.log('Cursor color NOT applied because large cursor is disabled or toggle missing');
        return; // Don't apply if disabled
    }

    // We need to create or update a style tag with the custom cursor
    let styleTag = document.getElementById('custom-cursor-style');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'custom-cursor-style';
        document.head.appendChild(styleTag);
        console.log('Created custom cursor style tag');
    }

    // Encode color for SVG data URL
    const encodedColor = encodeURIComponent(color);
    const strokeColor = encodeURIComponent('#000000'); // Black outline for visibility

    // --- MODIFIED: Simplified CSS rules, apply based on existing body class ---
    // Determine current size from body class (assume setCursorSize ran first)
    let currentSizeClass = '';
    if (document.body.classList.contains('cursor-small')) currentSizeClass = 'body.cursor-small';
    else if (document.body.classList.contains('cursor-medium')) currentSizeClass = 'body.cursor-medium';
    else if (document.body.classList.contains('cursor-large')) currentSizeClass = 'body.cursor-large';
    else {
        console.warn("setCursorColor: No cursor size class found on body. Cannot apply color.");
        styleTag.textContent = ''; // Clear styles if no size class
        return;
    }

    let cursorUrlDefault = '';
    let cursorUrlPointer = '';
    let cursorWidth = 60; // Default medium

    if (currentSizeClass === 'body.cursor-small') {
        cursorWidth = 40;
        cursorUrlDefault = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${cursorWidth}" height="${cursorWidth}" viewBox="0 0 24 24"><path fill="${encodedColor}" stroke="${strokeColor}" stroke-width="1.75" d="M5.5 3.21V20.8c0 .45.54.67.85.35l4.86-4.86a.5.5 0 0 1 .35-.15h6.87a.5.5 0 0 0 .35-.85L6.35 2.85a.5.5 0 0 0-.85.35Z"></path></svg>') 5 5, auto !important`;
        cursorUrlPointer = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${cursorWidth}" height="${cursorWidth}" viewBox="0 0 24 24"><path fill="${encodedColor}" stroke="${strokeColor}" stroke-width="1.75" stroke-linejoin="round" d="M10 11V8.99c0-.88.59-1.64 1.44-1.86h.05A1.99 1.99 0 0 1 14 9.05V12v-2c0-.88.6-1.65 1.46-1.87h.05A1.98 1.98 0 0 1 18 10.06V13v-1.94a2 2 0 0 1 1.51-1.94h0A2 2 0 0 1 22 11.06V14c0 .6-.08 1.27-.21 1.97a7.96 7.96 0 0 1-7.55 6.48 54.98 54.98 0 0 1-4.48 0 7.96 7.96 0 0 1-7.55-6.48C2.08 15.27 2 14.59 2 14v-1.49c0-1.11.9-2.01 2.01-2.01h0a2 2 0 0 1 2.01 2.03l-.01.97v-10c0-1.1.9-2 2-2h0a2 2 0 0 1 2 2V11Z"></path></svg>') 5 5, pointer !important`;
    } else if (currentSizeClass === 'body.cursor-large') {
        cursorWidth = 80;
        cursorUrlDefault = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${cursorWidth}" height="${cursorWidth}" viewBox="0 0 24 24"><path fill="${encodedColor}" stroke="${strokeColor}" stroke-width="1.75" d="M5.5 3.21V20.8c0 .45.54.67.85.35l4.86-4.86a.5.5 0 0 1 .35-.15h6.87a.5.5 0 0 0 .35-.85L6.35 2.85a.5.5 0 0 0-.85.35Z"></path></svg>') 5 5, auto !important`;
        cursorUrlPointer = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${cursorWidth}" height="${cursorWidth}" viewBox="0 0 24 24"><path fill="${encodedColor}" stroke="${strokeColor}" stroke-width="1.75" stroke-linejoin="round" d="M10 11V8.99c0-.88.59-1.64 1.44-1.86h.05A1.99 1.99 0 0 1 14 9.05V12v-2c0-.88.6-1.65 1.46-1.87h.05A1.98 1.98 0 0 1 18 10.06V13v-1.94a2 2 0 0 1 1.51-1.94h0A2 2 0 0 1 22 11.06V14c0 .6-.08 1.27-.21 1.97a7.96 7.96 0 0 1-7.55 6.48 54.98 54.98 0 0 1-4.48 0 7.96 7.96 0 0 1-7.55-6.48C2.08 15.27 2 14.59 2 14v-1.49c0-1.11.9-2.01 2.01-2.01h0a2 2 0 0 1 2.01 2.03l-.01.97v-10c0-1.1.9-2 2-2h0a2 2 0 0 1 2 2V11Z"></path></svg>') 5 5, pointer !important`;
    } else { // Medium default
        cursorUrlDefault = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${cursorWidth}" height="${cursorWidth}" viewBox="0 0 24 24"><path fill="${encodedColor}" stroke="${strokeColor}" stroke-width="1.75" d="M5.5 3.21V20.8c0 .45.54.67.85.35l4.86-4.86a.5.5 0 0 1 .35-.15h6.87a.5.5 0 0 0 .35-.85L6.35 2.85a.5.5 0 0 0-.85.35Z"></path></svg>') 5 5, auto !important`;
        cursorUrlPointer = `url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${cursorWidth}" height="${cursorWidth}" viewBox="0 0 24 24"><path fill="${encodedColor}" stroke="${strokeColor}" stroke-width="1.75" stroke-linejoin="round" d="M10 11V8.99c0-.88.59-1.64 1.44-1.86h.05A1.99 1.99 0 0 1 14 9.05V12v-2c0-.88.6-1.65 1.46-1.87h.05A1.98 1.98 0 0 1 18 10.06V13v-1.94a2 2 0 0 1 1.51-1.94h0A2 2 0 0 1 22 11.06V14c0 .6-.08 1.27-.21 1.97a7.96 7.96 0 0 1-7.55 6.48 54.98 54.98 0 0 1-4.48 0 7.96 7.96 0 0 1-7.55-6.48C2.08 15.27 2 14.59 2 14v-1.49c0-1.11.9-2.01 2.01-2.01h0a2 2 0 0 1 2.01 2.03l-.01.97v-10c0-1.1.9-2 2-2h0a2 2 0 0 1 2 2V11Z"></path></svg>') 5 5, pointer !important`;
    }

    // Create CSS rules for custom cursor for the current size class
    styleTag.textContent = `
        ${currentSizeClass}, ${currentSizeClass} * { cursor: ${cursorUrlDefault}; }
        ${currentSizeClass} a, ${currentSizeClass} button, ${currentSizeClass} [role="button"],
        ${currentSizeClass} input[type="submit"], ${currentSizeClass} input[type="button"] { cursor: ${cursorUrlPointer}; }
    `;
    // --- END MODIFIED ---

    console.log(`Applied cursor color ${color} for size class ${currentSizeClass}`);
}

// 2. READING GUIDE ENHANCEMENT
function enhanceReadingGuideOptions() {
    const readingOption = document.querySelector('.accessibility-option.reading');
    if (!readingOption) {
        console.warn("enhanceReadingGuideOptions: Reading guide option section not found.");
        return;
    }
    const panelContent = readingOption.closest('.accessibility-panel-content');
    if (!panelContent) {
        console.warn("enhanceReadingGuideOptions: Could not find parent panel content.");
        return;
    }

    // ---- Get Existing Elements (Scoped) ----
    const readingGuideToggle = readingOption.querySelector('#readingGuideToggle');
    const readingGuideColorPicker = readingOption.querySelector('#readingGuideColor');
    const readingGuideColorValue = readingOption.querySelector('#readingGuideColorValue');
    const readingGuideHeightSlider = readingOption.querySelector('#readingGuideHeightSlider');
    const readingGuideHeightValue = readingOption.querySelector('#readingGuideHeightValue');
    const readingGuideElement = document.getElementById('readingGuide'); // The actual guide div is global

    if (!readingGuideToggle || !readingGuideColorPicker || !readingGuideColorValue || !readingGuideHeightSlider || !readingGuideHeightValue) {
        console.error("enhanceReadingGuideOptions: One or more CORE reading guide control elements (toggle, color, height) not found. Cannot enhance.");
        return;
    }
    if (!readingGuideElement) {
        console.warn("enhanceReadingGuideOptions: Reading guide element (#readingGuide) not found in DOM.");
        // Allow proceeding but log warning
    }

    // ---- Create Opacity Slider & Border Buttons (if not already present) ----
    let opacitySliderContainer = readingOption.querySelector('.opacity-slider-container');
    let borderStyleControls = readingOption.querySelector('.border-style-controls');

    if (!opacitySliderContainer) {
        console.log("Creating reading guide opacity controls.");
        const opacitySliderHtml = `
            <div class="slider-container opacity-slider-container">
            <label for="readingGuideOpacitySlider">Opacity: <span id="readingGuideOpacityValue">${localStorage.getItem('readingGuideOpacity') || '70'}%</span></label>
            <div class="slider-wrapper">
                <input type="range" id="readingGuideOpacitySlider" min="20" max="100" step="5" value="${localStorage.getItem('readingGuideOpacity') || '70'}">
             </div>
        </div>
    `;
        const heightSliderContainer = readingOption.querySelector('.slider-container:not(.opacity-slider-container)');
        if (heightSliderContainer) {
            heightSliderContainer.insertAdjacentHTML('afterend', opacitySliderHtml);
            opacitySliderContainer = readingOption.querySelector('.opacity-slider-container');
        } else { console.warn("Could not find height slider to insert opacity slider after."); }
    } else {
        console.log("Reading guide opacity controls already exist.");
    }

    if (!borderStyleControls) {
        console.log("Creating reading guide border controls.");
        const borderStyleHtml = `
        <div class="button-group border-style-controls">
            <button class="border-style-btn" data-style="none">No Border</button>
            <button class="border-style-btn" data-style="solid">Solid</button>
            <button class="border-style-btn" data-style="dashed">Dashed</button>
        </div>
    `;
        const insertAfter = opacitySliderContainer || readingOption.querySelector('.slider-container'); // Insert after opacity or height
        if (insertAfter) {
            insertAfter.insertAdjacentHTML('afterend', borderStyleHtml);
            borderStyleControls = readingOption.querySelector('.border-style-controls');
        } else { console.warn("Could not find element to insert border controls after."); }
    } else {
        console.log("Reading guide border controls already exist.");
    }

    // --- Re-select Opacity and Border elements after potential insertion --- 
    const opacitySlider = readingOption.querySelector('#readingGuideOpacitySlider');
    const opacityValue = readingOption.querySelector('#readingGuideOpacityValue');
    let borderStyleButtons = readingOption.querySelectorAll('.border-style-btn');

    // --- Add Event Listeners (with null checks and idempotency) ---

    // TOGGLE Listener
    if (readingGuideToggle && !readingGuideToggle.dataset.listenerAttached) {
        // Initial state (sync checkbox with localStorage)
        const isEnabled = localStorage.getItem('readingGuide') === 'true';
        readingGuideToggle.checked = isEnabled;
        // Apply initial display/settings via applySavedReadingGuideSettings called elsewhere

        readingGuideToggle.addEventListener('change', function () {
            const enabled = this.checked;
            localStorage.setItem('readingGuide', enabled); // Save state
            console.log(`Reading guide ${enabled ? 'enabled' : 'disabled'} and state saved.`);
            // --- ADDED: Check function exists --- 
            if (typeof applySavedReadingGuideSettings === 'function') {
                applySavedReadingGuideSettings(); // Apply/remove styles and tracking
            } else {
                console.warn("applySavedReadingGuideSettings function not found.");
            }

            // Show/hide options container (Needs a dedicated container div)
            const optionsContainer = readingOption.querySelector('.reading-guide-options-wrapper'); // Hypothetical wrapper
            // --- ADDED: Null check --- 
            if (optionsContainer) optionsContainer.style.display = enabled ? 'block' : 'none';
            else console.warn("Reading guide options wrapper not found to toggle display.");

            showTooltip(`Reading guide ${enabled ? 'enabled' : 'disabled'}`);
        });
        readingGuideToggle.dataset.listenerAttached = 'true';
        console.log("Attached listener to reading guide toggle.");
    } else if (!readingGuideToggle) {
        console.error("Reading Guide Toggle element not found. Cannot attach listener or set initial state.");
    }

    // COLOR PICKER Listener
    if (readingGuideColorPicker && readingGuideColorValue && !readingGuideColorPicker.dataset.listenerAttached) {
        // Initial state
        readingGuideColorPicker.value = localStorage.getItem('readingGuideColor') || '#FFFF96';
        readingGuideColorValue.textContent = readingGuideColorPicker.value;

        readingGuideColorPicker.addEventListener('input', function () {
            const newColor = this.value;
            // --- ADDED: Null check --- 
            if (readingGuideColorValue) readingGuideColorValue.textContent = newColor;
            localStorage.setItem('readingGuideColor', newColor); // Save color preference
            // --- ADDED: Check function exists --- 
            if (typeof applyReadingGuideColor === 'function') {
                applyReadingGuideColor(newColor); // Apply color (respects current opacity)
            } else {
                console.warn("applyReadingGuideColor function not found.");
            }
        });
        readingGuideColorPicker.dataset.listenerAttached = 'true';
        console.log("Attached listener to reading guide color picker.");
    } else if (!readingGuideColorPicker || !readingGuideColorValue) {
        console.warn("Reading guide color picker/value missing, listener not added.");
    }

    // HEIGHT SLIDER Listener
    if (readingGuideHeightSlider && readingGuideHeightValue && !readingGuideHeightSlider.dataset.listenerAttached) {
        // Initial State
        const savedHeight = localStorage.getItem('readingGuideHeight') || '14';
        readingGuideHeightSlider.value = savedHeight;
        readingGuideHeightValue.textContent = savedHeight + 'px';

        readingGuideHeightSlider.addEventListener('input', function () {
            const newHeight = this.value;
            // --- ADDED: Null check --- 
            if (readingGuideHeightValue) readingGuideHeightValue.textContent = newHeight + 'px';
            localStorage.setItem('readingGuideHeight', newHeight); // Save height preference

            // --- MODIFIED: Added null check for readingGuideElement & readingGuideToggle --- 
            const currentReadingGuideElement = document.getElementById('readingGuide'); // Re-fetch element
            const currentReadingGuideToggle = readingOption.querySelector('#readingGuideToggle'); // Re-fetch toggle
            if (currentReadingGuideElement && currentReadingGuideToggle?.checked) { // Apply only if enabled
                currentReadingGuideElement.style.height = newHeight + 'px';
            }
        });
        readingGuideHeightSlider.dataset.listenerAttached = 'true';
        console.log("Attached listener to reading guide height slider.");
    } else if (!readingGuideHeightSlider || !readingGuideHeightValue) {
        console.warn("Reading guide height slider/value missing, listener not added.");
    }

    // OPACITY SLIDER Listener
    if (opacitySlider && opacityValue && !opacitySlider.dataset.listenerAttached) {
        // Initial State
        const savedOpacity = localStorage.getItem('readingGuideOpacity') || '70';
        opacitySlider.value = savedOpacity;
        opacityValue.textContent = savedOpacity + '%';

        opacitySlider.addEventListener('input', function () {
            const value = this.value;
            // --- ADDED: Null check --- 
            if (opacityValue) opacityValue.textContent = `${value}%`;
            // --- ADDED: Check function exists --- 
            if (typeof setReadingGuideOpacity === 'function') {
                setReadingGuideOpacity(value); // Saves opacity to localStorage & applies style
            } else {
                console.warn("setReadingGuideOpacity function not found.");
            }
        });
        opacitySlider.dataset.listenerAttached = 'true';
        console.log("Attached listener to reading guide opacity slider.");
    } else if (!opacitySlider || !opacityValue) {
        console.warn("Reading guide opacity slider/value missing or not created, listener not added.");
    }

    // BORDER STYLE Listener
    if (borderStyleButtons.length > 0 && !borderStyleButtons[0].dataset.listenerAttached) {
        borderStyleButtons.forEach(button => {
            // --- MODIFIED: Check button exists before adding listener --- 
            if (button) {
                button.addEventListener('click', function () {
                    borderStyleButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const style = this.getAttribute('data-style');
                    localStorage.setItem('readingGuideBorderStyle', style); // Save style preference
                    // --- ADDED: Check function exists --- 
                    if (typeof setReadingGuideBorder === 'function') {
                        setReadingGuideBorder(style); // Apply style
                    } else {
                        console.warn("setReadingGuideBorder function not found.");
                    }
                    showTooltip(`Reading guide border set to ${style}`);
                });
                button.dataset.listenerAttached = 'true'; // Mark as attached
            } else {
                console.warn("Null button found in borderStyleButtons list.");
            }
        });
        console.log("Attached listeners to reading guide border buttons.");

        // Set initial active button state (handled by updatePanelControlsFromStorage)

    } else if (borderStyleButtons.length === 0) {
        console.warn("Reading guide border style buttons missing or not created, listeners not added.");
    }

    // Setup mouse tracking (ensure it's only added once)
    if (typeof setupReadingGuideTracking === 'function' && !window.readingGuideTrackingInitialized) {
        setupReadingGuideTracking();
        window.readingGuideTrackingInitialized = true;
        console.log("Initialized reading guide mouse tracking.");
    } else if (!window.readingGuideTrackingInitialized) {
        console.warn("enhanceReadingGuideOptions: setupReadingGuideTracking function not found.");
    } else {
        console.log("Reading guide tracking already initialized."); // Log if already done
    }

    console.log("Enhanced Reading Guide Options Initialized/Listeners Attached.");
}

// 3. CONTRAST MODE ENHANCEMENT
function enhanceContrastModeOptions() {
    const contrastOption = document.querySelector('.accessibility-option.contrast');
    if (!contrastOption) {
        console.warn("enhanceContrastModeOptions: Contrast option section not found.");
        return;
    }
    const panelContent = contrastOption.closest('.accessibility-panel-content');
    if (!panelContent) {
        console.warn("enhanceContrastModeOptions: Could not find parent panel content.");
        return;
    }

    // ---- Get Existing Elements (Scoped) ----
    const highContrastToggle = contrastOption.querySelector('#highContrastToggle');
    const toggleContainer = contrastOption.querySelector('.toggle-container'); // Find the toggle container

    if (!highContrastToggle || !toggleContainer) {
        console.error("enhanceContrastModeOptions: High contrast toggle or its container not found. Cannot enhance.");
        return;
    }

    // ---- Create Theme Buttons (if not already present) ----
    let themeButtonsContainer = contrastOption.querySelector('.theme-buttons-container');
    let customColorsDiv = contrastOption.querySelector('.custom-contrast-colors');

    if (!themeButtonsContainer) {
        console.log("Creating contrast theme buttons.");
        const themeButtonsHtml = `
            <div class="button-group theme-buttons-container" style="margin-top: 10px; display: none;"> 
                <label style="width: 100%; font-weight: 500; margin-bottom: 5px;">Theme:</label>
                <button class="contrast-theme-btn accessibility-option-button" data-theme="black-white">Black/White</button>
                <button class="contrast-theme-btn accessibility-option-button" data-theme="custom">Custom</button>
        </div>
    `;
        // Insert after the main toggle container
        toggleContainer.insertAdjacentHTML('afterend', themeButtonsHtml);
        themeButtonsContainer = contrastOption.querySelector('.theme-buttons-container'); // Re-select
    } else {
        console.log("Contrast theme buttons container already exists.");
    }

    // ---- Create Custom Colors Div (if not already present) ----
    if (!customColorsDiv) {
        console.log("Creating custom contrast colors container.");
        const customColorsHtml = `
            <div class="color-picker-container custom-contrast-colors" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                <div style="margin-bottom: 10px; font-weight: 500;">Custom Theme Colors:</div>
            <div class="color-picker-label">Background Color:</div>
            <div class="color-picker-wrapper">
                <input type="color" id="contrastBgColorPicker" class="color-picker" value="${localStorage.getItem('contrastBgColor') || '#000000'}">
                <span class="color-value" id="contrastBgColorValue">${localStorage.getItem('contrastBgColor') || '#000000'}</span>
            </div>
            <div class="color-picker-label" style="margin-top:10px;">Text Color:</div>
            <div class="color-picker-wrapper">
                <input type="color" id="contrastTextColorPicker" class="color-picker" value="${localStorage.getItem('contrastTextColor') || '#FFFFFF'}">
                <span class="color-value" id="contrastTextColorValue">${localStorage.getItem('contrastTextColor') || '#FFFFFF'}</span>
            </div>
            <div class="color-picker-label" style="margin-top:10px;">Link Color:</div>
            <div class="color-picker-wrapper">
                <input type="color" id="contrastLinkColorPicker" class="color-picker" value="${localStorage.getItem('contrastLinkColor') || '#FFFF00'}">
                <span class="color-value" id="contrastLinkColorValue">${localStorage.getItem('contrastLinkColor') || '#FFFF00'}</span>
            </div>
        </div>
    `;
        // Insert after the theme buttons container
        if (themeButtonsContainer) {
            themeButtonsContainer.insertAdjacentHTML('afterend', customColorsHtml);
            customColorsDiv = contrastOption.querySelector('.custom-contrast-colors'); // Re-select
        } else {
            console.error("Could not find theme buttons container to insert custom colors div after.");
        }
    } else {
        console.log("Custom contrast colors container already exists.");
    }

    // --- Add Event Listeners (with idempotency) ---

    // High Contrast Toggle Listener
    if (highContrastToggle && !highContrastToggle.dataset.listenerAttached) {
        highContrastToggle.addEventListener('change', function () {
            const isChecked = this.checked;
            if (typeof handleHighContrastToggle === 'function') {
                handleHighContrastToggle(isChecked);
            } else {
                console.warn("handleHighContrastToggle function not found.");
            }
            // Update visibility of theme buttons container
            const currentThemeButtonsContainer = contrastOption.querySelector('.theme-buttons-container');
            if (currentThemeButtonsContainer) {
                currentThemeButtonsContainer.style.display = isChecked ? 'flex' : 'none';
            }
            // Update visibility of custom colors div based on toggle AND selected theme
            const currentCustomColorsDiv = contrastOption.querySelector('.custom-contrast-colors');
            const currentTheme = localStorage.getItem('contrastTheme') || 'black-white';
            if (currentCustomColorsDiv) {
                currentCustomColorsDiv.style.display = (isChecked && currentTheme === 'custom') ? 'block' : 'none';
            } else {
                console.warn("Custom contrast colors div not found for show/hide.");
            }
        });
        highContrastToggle.dataset.listenerAttached = 'true';
        console.log("Attached listener to high contrast toggle.");
    }

    // --- MODIFIED: Theme BUTTONS Listener ---
    const themeButtons = contrastOption.querySelectorAll('.contrast-theme-btn');
    if (themeButtonsContainer && themeButtons.length > 0 && !themeButtonsContainer.dataset.listenerAttached) {
        themeButtons.forEach(button => {
            button.addEventListener('click', function () {
                // Update active button style
                themeButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                const theme = this.getAttribute('data-theme');
                localStorage.setItem('contrastTheme', theme); // Save preference

                // Show/hide custom colors div
                const currentCustomColorsDiv = contrastOption.querySelector('.custom-contrast-colors');
                if (currentCustomColorsDiv) {
                    currentCustomColorsDiv.style.display = theme === 'custom' ? 'block' : 'none';
                } else {
                    console.warn("Custom contrast colors div not found for show/hide.");
                }

                // Apply theme only if high contrast is currently enabled
                const currentHighContrastToggle = contrastOption.querySelector('#highContrastToggle');
                if (currentHighContrastToggle?.checked) {
                    if (typeof setContrastTheme === 'function') {
                        setContrastTheme(theme); // Apply theme styles
                    } else {
                        console.warn("setContrastTheme function not found.");
                    }
                } else {
                    console.log("High contrast not enabled, theme preference saved but not applied yet.");
                }
                showTooltip(`Contrast theme set to ${theme}`);
            });
        });
        themeButtonsContainer.dataset.listenerAttached = 'true'; // Mark container once
        console.log("Attached listeners to contrast theme buttons.");
    } else if (themeButtons.length === 0) {
        console.warn("Contrast theme buttons not found or not created, cannot attach listeners.");
    }
    // --- END MODIFICATION ---

    // Custom Color Pickers Listeners (Ensure they exist after potential creation)
    const bgColorPicker = contrastOption.querySelector('#contrastBgColorPicker');
    const bgColorValue = contrastOption.querySelector('#contrastBgColorValue');
    if (bgColorPicker && bgColorValue && !bgColorPicker.dataset.listenerAttached) {
        bgColorPicker.addEventListener('input', function () {
            if (bgColorValue) bgColorValue.textContent = this.value;
            localStorage.setItem('contrastBgColor', this.value);
            // Apply immediately only if high contrast is on and theme is custom
            const currentHighContrastToggle = contrastOption.querySelector('#highContrastToggle');
            const currentTheme = localStorage.getItem('contrastTheme') || 'black-white';
            if (currentHighContrastToggle?.checked && currentTheme === 'custom') {
                if (typeof applyCustomContrastColors === 'function') {
                    applyCustomContrastColors();
                } else {
                    console.warn("applyCustomContrastColors function not found.");
                }
            }
        });
        bgColorPicker.dataset.listenerAttached = 'true';
    } else if (!bgColorPicker || !bgColorValue) {
        console.warn("enhanceContrastModeOptions: BG Color picker or value span not found or not created.");
    }

    const textColorPicker = contrastOption.querySelector('#contrastTextColorPicker');
    const textColorValue = contrastOption.querySelector('#contrastTextColorValue');
    if (textColorPicker && textColorValue && !textColorPicker.dataset.listenerAttached) {
        textColorPicker.addEventListener('input', function () {
            if (textColorValue) textColorValue.textContent = this.value;
            localStorage.setItem('contrastTextColor', this.value);
            // Apply immediately only if high contrast is on and theme is custom
            const currentHighContrastToggle = contrastOption.querySelector('#highContrastToggle');
            const currentTheme = localStorage.getItem('contrastTheme') || 'black-white';
            if (currentHighContrastToggle?.checked && currentTheme === 'custom') {
                if (typeof applyCustomContrastColors === 'function') {
                    applyCustomContrastColors();
                } else {
                    console.warn("applyCustomContrastColors function not found.");
                }
            }
        });
        textColorPicker.dataset.listenerAttached = 'true';
    } else if (!textColorPicker || !textColorValue) {
        console.warn("enhanceContrastModeOptions: Text Color picker or value span not found or not created.");
    }

    const linkColorPicker = contrastOption.querySelector('#contrastLinkColorPicker');
    const linkColorValue = contrastOption.querySelector('#contrastLinkColorValue');
    if (linkColorPicker && linkColorValue && !linkColorPicker.dataset.listenerAttached) {
        linkColorPicker.addEventListener('input', function () {
            if (linkColorValue) linkColorValue.textContent = this.value;
            localStorage.setItem('contrastLinkColor', this.value);
            // Apply immediately only if high contrast is on and theme is custom
            const currentHighContrastToggle = contrastOption.querySelector('#highContrastToggle');
            const currentTheme = localStorage.getItem('contrastTheme') || 'black-white';
            if (currentHighContrastToggle?.checked && currentTheme === 'custom') {
                if (typeof applyCustomContrastColors === 'function') {
                    applyCustomContrastColors();
                } else {
                    console.warn("applyCustomContrastColors function not found.");
                }
            }
        });
        linkColorPicker.dataset.listenerAttached = 'true';
        console.log("Attached listeners to custom contrast color pickers.");
    } else if (!linkColorPicker || !linkColorValue) {
        console.warn("enhanceContrastModeOptions: Link Color picker or value span not found or not created.");
    }

    // --- Set initial visibility and active states based on localStorage --- 
    const isEnabledOnLoad = highContrastToggle?.checked;
    const currentThemeButtonsContainer = contrastOption.querySelector('.theme-buttons-container');
    const currentThemeOnLoad = localStorage.getItem('contrastTheme') || 'black-white';
    const currentCustomColorsDivOnLoad = contrastOption.querySelector('.custom-contrast-colors');
    const currentThemeButtons = contrastOption.querySelectorAll('.contrast-theme-btn');

    if (currentThemeButtonsContainer) {
        currentThemeButtonsContainer.style.display = isEnabledOnLoad ? 'flex' : 'none';
    }
    if (currentCustomColorsDivOnLoad) {
        currentCustomColorsDivOnLoad.style.display = (isEnabledOnLoad && currentThemeOnLoad === 'custom') ? 'block' : 'none';
    }
    if (currentThemeButtons.length > 0) {
        currentThemeButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-theme') === currentThemeOnLoad) {
                btn.classList.add('active');
            }
        });
    }
    // Initial state values for color pickers are handled by updatePanelControlsFromStorage called elsewhere

    console.log("enhanceContrastModeOptions finished.");
}

// Helper function to set contrast theme
function setContrastTheme(theme) {
    // Only apply if high contrast is enabled
    if (!document.body || !document.body.classList.contains('high-contrast')) return;

    const root = document.documentElement;
    if (!root) return;

    // Remove existing theme classes
    document.body.classList.remove('theme-black-white', 'theme-custom');

    // Add the selected theme class
    document.body.classList.add(`theme-${theme}`);

    // Apply text color to all text elements except links
    let styleTag = document.getElementById('high-contrast-text-style');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'high-contrast-text-style';
        document.head.appendChild(styleTag);
    }

    // Apply text color to all text elements except links
    styleTag.textContent = `
        body.high-contrast p, 
        body.high-contrast h1:not(a), 
        body.high-contrast h2:not(a), 
        body.high-contrast h3:not(a), 
        body.high-contrast h4:not(a), 
        body.high-contrast h5:not(a), 
        body.high-contrast h6:not(a), 
        body.high-contrast span:not(a), 
        body.high-contrast label, 
        body.high-contrast button:not(a),
        body.high-contrast input,
        body.high-contrast textarea,
        body.high-contrast select,
        body.high-contrast div:not(a),
        body.high-contrast li:not(a),
        body.high-contrast td,
        body.high-contrast th {
            color: var(--contrast-text) !important;
        }
        
        /* Fix for images in high contrast mode */
        body.high-contrast img, 
        body.high-contrast svg,
        body.high-contrast .icon,
        body.high-contrast [class*="icon-"] {
            filter: none !important;
        }
    `;

    // Check if in dark mode, switch to light mode if needed for any high contrast mode
    if (document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');

        // Update dark mode toggle emoji
        updateDarkModeToggleEmoji(false);

        // Show toast message
        if (theme === 'custom') {
            showTooltip('Switching to light mode for better custom contrast experience', 4000);
        } else {
            showTooltip('Switching to light mode for better high contrast experience', 4000);
        }

        // Save preference
        localStorage.setItem('darkMode', 'false');
    }

    switch (theme) {
        case 'custom':
            applyCustomContrastColors();
            break;

        case 'black-white':
        default:
            root.style.setProperty('--contrast-bg', '#000000');
            root.style.setProperty('--contrast-text', '#FFFFFF');
            root.style.setProperty('--contrast-link', '#FFFF00');
            root.style.setProperty('--contrast-hover', '#444444');
            break;
    }
}

// Helper function to apply custom contrast colors
function applyCustomContrastColors() {
    const root = document.documentElement;

    // Get saved custom colors or use defaults
    const bgColor = localStorage.getItem('contrastBgColor') || '#000000';
    const textColor = localStorage.getItem('contrastTextColor') || '#FFFFFF';
    const linkColor = localStorage.getItem('contrastLinkColor') || '#FFFF00';

    // Apply custom colors
    root.style.setProperty('--contrast-bg', bgColor);
    root.style.setProperty('--contrast-text', textColor);
    root.style.setProperty('--contrast-link', linkColor);
    root.style.setProperty('--contrast-hover', '#444444'); // Keep default hover color

    // Apply custom styles for better image visibility
    let imageStyleTag = document.getElementById('contrast-image-style');
    if (!imageStyleTag) {
        imageStyleTag = document.createElement('style');
        imageStyleTag.id = 'contrast-image-style';
        document.head.appendChild(imageStyleTag);
    }

    imageStyleTag.textContent = `
        body.high-contrast.theme-custom img,
        body.high-contrast.theme-custom svg,
        body.high-contrast.theme-custom .icon,
        body.high-contrast.theme-custom [class*="icon-"] {
            filter: none !important;
            /* Add a subtle border to help distinguish images in custom contrast mode */
            border: 1px solid ${textColor};
        }
    `;
}

// Setup keyboard shortcuts for accessibility features
function setupAccessibilityKeyboardShortcuts() {
    document.addEventListener('keydown', function (e) {
        // Only trigger if Alt key is pressed
        if (!e.altKey) return;

        switch (e.key) {
            // Alt+R: Toggle Reading Guide
            case 'r':
            case 'R':
                const readingGuideToggle = document.getElementById('readingGuideToggle');
                if (readingGuideToggle) {
                    readingGuideToggle.checked = !readingGuideToggle.checked;

                    // Trigger the change event
                    const event = new Event('change');
                    readingGuideToggle.dispatchEvent(event);

                    // Show feedback
                    showTooltip(`Reading guide ${readingGuideToggle.checked ? 'enabled' : 'disabled'} (Alt+R)`);
                }
                break;

            // Alt+C: Toggle High Contrast
            case 'c':
            case 'C':
                const highContrastToggle = document.getElementById('highContrastToggle');
                if (highContrastToggle) {
                    highContrastToggle.checked = !highContrastToggle.checked;

                    // Trigger the change event
                    const event = new Event('change');
                    highContrastToggle.dispatchEvent(event);

                    // Show feedback
                    showTooltip(`High contrast mode ${highContrastToggle.checked ? 'enabled' : 'disabled'} (Alt+C)`);
                }
                break;

            // Alt+L: Toggle Large Cursor
            case 'l':
            case 'L':
                const largeCursorToggle = document.getElementById('largeCursorToggle');
                if (largeCursorToggle) {
                    largeCursorToggle.checked = !largeCursorToggle.checked;

                    // Trigger the change event
                    const event = new Event('change');
                    largeCursorToggle.dispatchEvent(event);

                    // Show feedback
                    showTooltip(`Large cursor ${largeCursorToggle.checked ? 'enabled' : 'disabled'} (Alt+L)`);
                }
                break;
        }
    });
}


// Create tooltip element for user feedback
function createTooltipElement() {
    // Create tooltip element if it doesn't exist
    if (!document.getElementById('accessibilityTooltip')) {
        const tooltip = document.createElement('div');
        tooltip.id = 'accessibilityTooltip';
        tooltip.className = 'accessibility-tooltip';
        document.body.appendChild(tooltip);

        // Make tooltip stay visible when hovered
        tooltip.addEventListener('mouseenter', () => {
            clearTimeout(window.tooltipTimeout);
            tooltip.classList.remove('fade-out');
        });

        tooltip.addEventListener('mouseleave', () => {
            tooltip.classList.add('fade-out');
            setTimeout(() => {
                tooltip.classList.remove('show', 'extended', 'fade-out');
            }, 300);
        });
    }

    // Set up info icon tooltips
    setupInfoIcons();
}

// Set up info icons throughout the page
function setupInfoIcons() {
    const infoIcons = document.querySelectorAll('.info-icon');

    if (infoIcons.length === 0) {
        console.log('Enhanced accessibility: No info icons found on the page');
        return;
    }

    console.log(`Enhanced accessibility: Setting up ${infoIcons.length} info icons`);

    infoIcons.forEach(icon => {
        // Remove any existing click listeners to prevent duplicates
        icon.removeEventListener('click', handleInfoIconClick);

        // Add click listener
        icon.addEventListener('click', handleInfoIconClick);

        // Add hover functionality for desktop users
        icon.addEventListener('mouseenter', () => {
            const tooltipText = icon.getAttribute('data-tooltip');
            if (tooltipText) {
                showTooltip(tooltipText, 3000, 'info-hover');
            }
        });

        // Make sure the icon is accessible for keyboard users
        if (!icon.hasAttribute('tabindex')) {
            icon.setAttribute('tabindex', '0');
        }

        // Add keyboard support (Enter key)
        icon.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleInfoIconClick.call(icon);
            }
        });
    });
}

// Handle info icon click events
function handleInfoIconClick() {
    const tooltipText = this.getAttribute('data-tooltip');
    if (tooltipText) {
        // Use longer duration for clicked tooltips
        showTooltip(tooltipText, 6000, 'info-click');
    }
}

// Show tooltip with message
function showTooltip(message, duration = 3000, type = '') {
    const tooltip = document.getElementById('accessibilityTooltip');
    if (!tooltip) {
        console.log('Enhanced accessibility: Tooltip element not found, creating it');
        createTooltipElement();
        return showTooltip(message, duration, type); // Retry after creating
    }

    console.log(`Enhanced accessibility: Showing tooltip with message: ${message}`);

    // Set message
    tooltip.textContent = message;

    // Clear any existing classes and animations
    tooltip.className = 'accessibility-tooltip';
    tooltip.style.animation = 'none';

    // Trigger reflow to restart animations
    void tooltip.offsetWidth;

    // Show tooltip with appropriate class
    tooltip.classList.add('show');

    // If duration is longer, add a special class
    if (duration > 5000) { // Adjust threshold if needed
        tooltip.classList.add('extended');
    }

    // Add type-specific class if provided (e.g., 'success', 'error', 'info')
    if (type) {
        tooltip.classList.add(type);
    }

    // Position the tooltip centered near the bottom of the screen
    tooltip.style.bottom = '20px';
    tooltip.style.left = '50%';
    tooltip.style.transform = 'translateX(-50%)';

    // Add listener to close on background click (only if it doesn't exist)
    const closeHandler = (e) => {
        if (tooltip.classList.contains('show') && !tooltip.contains(e.target)) {
            clearTimeout(window.tooltipTimeout);
            tooltip.classList.add('fade-out');
            setTimeout(() => {
                const classesToRemove = ['show', 'extended', 'fade-out'];
                if (type) classesToRemove.push(type);
                tooltip.classList.remove(...classesToRemove);
            }, 300); // Animation duration
            document.removeEventListener('click', closeHandler, true); // Remove listener after use
        }
    };

    // Remove any previous listener before adding a new one
    if (window.tooltipCloseHandler) {
        document.removeEventListener('click', window.tooltipCloseHandler, true);
    }
    window.tooltipCloseHandler = closeHandler;
    document.addEventListener('click', closeHandler, true);

    // Hide tooltip after duration
    clearTimeout(window.tooltipTimeout);
    window.tooltipTimeout = setTimeout(() => {
        tooltip.classList.add('fade-out');

        // Reset state after animation completes
        setTimeout(() => {
            const classesToRemove = ['show', 'extended', 'fade-out'];
            if (type) classesToRemove.push(type);
            tooltip.classList.remove(...classesToRemove);
            document.removeEventListener('click', closeHandler, true); // Ensure listener is removed if timeout completes
        }, 300); // Animation duration
    }, duration);
}


// AI Chatbot Functionality
function initChatbot() {
    // --- Prevent multiple initializations --- 
    if (window.chatbotInitialized) {
        console.log("Chatbot already initialized. Skipping.");
        return;
    }
    window.chatbotInitialized = true; // Set global flag
    console.log("Initializing Chatbot...");

    const chatbotTrigger = document.querySelector('.chatbot-trigger button');
    const chatbotContainer = document.querySelector('.chatbot-container');
    const chatbotClose = document.querySelector('.chatbot-close');
    const chatInput = document.querySelector('.chatbot-input input');
    const chatSendBtn = document.querySelector('.chatbot-input button');
    const chatMessages = document.querySelector('.chatbot-messages');

    if (!chatbotTrigger) {
        console.error("Chatbot trigger button not found.");
        // Optionally return here if the trigger is essential
    }
    if (!chatbotContainer) {
        console.error("Chatbot container not found.");
        // Optionally return here if the container is essential
    }
    if (!chatbotClose) {
        console.error("Chatbot close button not found.");
    }
    if (!chatInput) {
        console.error("Chatbot input field not found.");
    }
    if (!chatSendBtn) {
        console.error("Chatbot send button not found.");
    }
    if (!chatMessages) {
        console.error("Chatbot messages container not found.");
    }

    // Add emoji to chatbot button
    if (chatbotTrigger) {
        chatbotTrigger.innerHTML = '💬'; // Chat emoji
    }

    // Add send emoji to send button
    if (chatSendBtn) {
        chatSendBtn.innerHTML = '➤'; // Send emoji
    }

    // Toggle chatbot visibility
    if (chatbotTrigger && chatbotContainer && chatMessages) { // Add null check for chatMessages
        chatbotTrigger.addEventListener('click', function () {
            chatbotContainer.classList.toggle('show-chatbot');
            // If opening the chatbot for the first time, show welcome message
            // Check if chatMessages exists before accessing children
            if (chatbotContainer.classList.contains('show-chatbot') && chatMessages && chatMessages.children.length === 0) {
                addBotMessage("Hello! I'm your school assistant. How can I help you today?");
                // Also show suggestions when opening
                showChatbotSuggestions(chatMessages);
            }
        });
    } else {
        console.error("Could not attach chatbot trigger listener: required elements missing.");
    }

    // Close chatbot
    if (chatbotClose && chatbotContainer) { // Add null check
        chatbotClose.addEventListener('click', function () {
            chatbotContainer.classList.remove('show-chatbot');
        });
    } else {
        console.error("Could not attach chatbot close listener: required elements missing.");
    }

    // Send message function
    function sendMessage() {
        // Add null checks inside the function
        if (!chatInput || !chatMessages) {
            console.error("Chat input or messages container missing in sendMessage.");
            return;
        }
        const userMessage = chatInput.value.trim();
        if (userMessage === '') return;

        // Add user message to chat
        addUserMessage(userMessage);
        chatInput.value = '';

        // Show typing indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'bot-message typing-indicator-container';
        typingIndicator.innerHTML = `
            <div class="bot-avatar">🤖</div>
            <div class="message-content typing-indicator">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </div>
        `;
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Generate bot response with delay for natural feel
        setTimeout(() => {
            // Remove typing indicator
            typingIndicator.remove();

            // Get and add actual response
            const botResponse = getBotResponse(userMessage.toLowerCase());
            addBotMessage(botResponse);
            // Auto-scroll to bottom of chat
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 800 + Math.random() * 700); // Random delay between 800-1500ms
    }

    // Send message on button click
    if (chatSendBtn) { // Add null check
        chatSendBtn.addEventListener('click', sendMessage);
    } else {
        console.error("Could not attach send button listener: button missing.");
    }

    // Send message on Enter key
    if (chatInput) { // Add null check
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }

    // Add user message to chat
    function addUserMessage(message) {
        if (!chatMessages) {
            console.error("Chat messages container not found in addUserMessage");
            return; // Prevent error if chatMessages is null
        }
        const msgElement = document.createElement('div');
        msgElement.className = 'user-message'; // Ensure this is user-message
        msgElement.innerHTML = `<div class="message-content">${message}</div>`;
        chatMessages.appendChild(msgElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Add bot message to chat
    function addBotMessage(message) {
        if (!chatMessages) {
            console.error("Chat messages container not found in addBotMessage");
            return; // Prevent error if chatMessages is null
        }
        const msgElement = document.createElement('div');
        msgElement.className = 'bot-message';

        // Create unique ID for this message
        const msgId = 'msg-' + Date.now();

        // Strip HTML for TTS
        const textForTTS = message.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, '');

        msgElement.innerHTML = `
            <div class="bot-avatar">🤖</div>
            <div class="message-content">${message}</div>
            <div class="message-actions">
                <button class="msg-action-btn tts-btn" title="Read aloud" data-text="${textForTTS.replace(/"/g, '&quot;')}">🔊</button>
                <button class="msg-action-btn reaction-btn" data-reaction="helpful" title="Helpful">👍</button>
                <button class="msg-action-btn reaction-btn" data-reaction="not-helpful" title="Not helpful">👎</button>
            </div>
        `;

        chatMessages.appendChild(msgElement);

        // Add event listeners for action buttons
        const ttsBtn = msgElement.querySelector('.tts-btn');
        if (ttsBtn) {
            ttsBtn.addEventListener('click', function () {
                speakText(this.dataset.text);
                this.classList.add('active');
                setTimeout(() => this.classList.remove('active'), 2000);
            });
        }

        // Reaction buttons
        const reactionBtns = msgElement.querySelectorAll('.reaction-btn');
        reactionBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                // Remove active from sibling
                reactionBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Show feedback
                const feedback = this.dataset.reaction === 'helpful' ?
                    'Thanks for the feedback! 😊' :
                    'Sorry I couldn\'t help better. Try rephrasing your question!';
                showQuickFeedback(feedback);
            });
        });

        // Ensure suggestions are below new bot message
        const existingSuggestions = chatMessages.querySelector('.suggestion-container');
        if (existingSuggestions && existingSuggestions.style.display !== 'none') {
            chatMessages.appendChild(existingSuggestions);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Text-to-Speech function
    function speakText(text) {
        if ('speechSynthesis' in window) {
            // Stop any ongoing speech
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;

            // Try to get an English voice
            const voices = window.speechSynthesis.getVoices();
            const englishVoice = voices.find(v => v.lang.startsWith('en'));
            if (englishVoice) utterance.voice = englishVoice;

            window.speechSynthesis.speak(utterance);
        } else {
            console.warn('Text-to-speech not supported in this browser');
        }
    }

    // Show quick feedback toast
    function showQuickFeedback(message) {
        let toast = document.querySelector('.chatbot-toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.className = 'chatbot-toast';
            document.querySelector('.chatbot-container')?.appendChild(toast);
        }
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // ============================================
    // CHATBOT AI - ENHANCED VERSION
    // School: SUPRAPA High School (SHS)
    // Features: Dynamic dates, time greetings, fun facts,
    // typing indicator, page detection, better fuzzy matching
    // ============================================

    // --- Helper Functions ---

    // Get current academic year (e.g., "2025-26")
    function getAcademicYear() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth(); // 0-11
        // Academic year typically starts in April in India
        if (month >= 3) { // April onwards
            return `${year}-${(year + 1).toString().slice(-2)}`;
        }
        return `${year - 1}-${year.toString().slice(-2)}`;
    }

    // Get time-based greeting
    function getTimeGreeting() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return "Good morning";
        if (hour >= 12 && hour < 17) return "Good afternoon";
        if (hour >= 17 && hour < 21) return "Good evening";
        return "Hello"; // Late night
    }

    // Calculate days until an event
    function daysUntilEvent(eventMonth, eventDay) {
        const now = new Date();
        const currentYear = now.getFullYear();
        let eventDate = new Date(currentYear, eventMonth - 1, eventDay);

        // If event already passed this year, use next year
        if (eventDate < now) {
            eventDate = new Date(currentYear + 1, eventMonth - 1, eventDay);
        }

        const diffTime = eventDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }

    // Get current page name
    function getCurrentPage() {
        const path = window.location.pathname;
        const filename = path.substring(path.lastIndexOf('/') + 1).toLowerCase();
        return filename || 'homepage2.html';
    }

    // Fun facts about the school
    const funFacts = [
        "🎓 Did you know? SUPRAPA High School was established in 1884, making it over 140 years old!",
        "📚 Fun fact: Our library has over 15,000 books across all subjects!",
        "🏆 Proud moment: We have produced numerous district toppers over the years!",
        "🌳 Our campus features beautiful greenery and a serene learning environment!",
        "👨‍🏫 We have 50+ dedicated faculty members guiding our students!",
        "🎨 SUPRAPA High has won multiple awards in arts and cultural competitions!",
        "⚽ Our football team has won inter-school tournaments multiple times!",
        "🔬 Our science labs are equipped with modern apparatus for hands-on learning!",
        "📖 SUPRAPA stands for excellence - we're affiliated with WBBSE & WBCHSE!",
        "💡 We embrace technology with smart classrooms and digital teaching aids!"
    ];

    // Dynamic upcoming events (calculated from current date)
    function getUpcomingEvents() {
        const now = new Date();
        const currentMonth = now.getMonth() + 1; // 1-12

        // Define events with month and day - MUST MATCH FOOTER EVENTS!
        // Footer shows: Annual Sports Day - Feb 5, Science Fair - Feb 12, Cultural Fest - Feb 25
        const events = [
            { name: "Annual Sports Day", month: 2, day: 5 },
            { name: "Science Fair", month: 2, day: 12 },
            { name: "Cultural Fest", month: 2, day: 25 },
            { name: "Annual Day", month: 3, day: 15 },
            { name: "Summer Vacation Starts", month: 5, day: 1 },
            { name: "Independence Day", month: 8, day: 15 }
        ];

        // Calculate days for each event and filter future ones
        return events.map(e => ({
            ...e,
            daysLeft: daysUntilEvent(e.month, e.day)
        })).sort((a, b) => a.daysLeft - b.daysLeft).slice(0, 3);
    }

    // Get page-specific context for better responses
    function getPageContext() {
        const page = getCurrentPage();
        const pageDescriptions = {
            'virtual-tour.html': 'the Virtual Tour page where you can explore our campus facilities like classrooms, library, science labs, and sports areas. Scroll down to see each facility or click on the navigation buttons!',
            'homepage2.html': 'the Home page of SUPRAPA High School. You can find quick links, news, events, and an overview of our school here.',
            'gallery.html': 'the Gallery page with photos from school events and activities.',
            'contact-us.html': 'the Contact Us page with our address, phone, email, and map.',
            'about.html': 'the About Us page with our school history, mission, and infrastructure details.',
            'events.html': 'the Events page showing all upcoming school activities and celebrations.',
            'notice.html': 'the Notices page with the latest announcements and updates.',
            'alumni.html': 'the Alumni page showcasing our successful former students.',
            'achievements.html': 'the Achievements page displaying student awards and school recognitions.',
            'ourfaculty.html': 'the Our Faculty page introducing our dedicated teachers.',
            'fun-learning-games.html': 'the Fun Learning Games Hub where you can play educational games!'
        };
        return pageDescriptions[page] || `the ${page.replace('.html', '').replace(/-/g, ' ')} page.`;
    }

    // --- Global variable to store sitemap data (with expanded keywords) ---
    const sitemapData = {
        'home': { url: 'Homepage2.html', title: 'Home - SUPRAPA High School', keywords: ['home', 'main', 'homepage', 'school home', 'shs', 'suprapa'] },
        'about': { url: 'about.html', title: 'About Us - SUPRAPA High School', keywords: ['about', 'history', 'mission', 'vision', 'school info', 'facility', 'facilities', 'infrastructure', 'lab', 'library', 'sports', 'established', 'founded'] },
        'notices': { url: 'Notice.html', title: 'Notices - SUPRAPA High School', keywords: ['notice', 'notices', 'announcement', 'news', 'update', 'updates', 'admission', 'admissions', 'apply', 'enroll', 'timing', 'hour', 'hours', 'school day'] },
        'academics': { url: 'academic-structure.html', title: 'Academic Structure - SUPRAPA High School', keywords: ['academic', 'academics', 'structure', 'curriculum', 'course', 'courses', 'subjects', 'class', 'classes', 'stream', 'streams'] },
        'exams': { url: 'exam-schedule.html', title: 'Exam Schedule - SUPRAPA High School', keywords: ['exam', 'exams', 'schedule', 'routine', 'test', 'tests', 'examination', 'exam info', 'datesheet'] },
        'books': { url: 'book-list.html', title: `Book List ${getAcademicYear()} - SUPRAPA High School`, keywords: ['book', 'books', 'list', 'textbook', 'textbooks'] },
        'gallery': { url: 'Gallery.html', title: 'Gallery - SUPRAPA High School', keywords: ['gallery', 'photo', 'photos', 'image', 'images', 'picture', 'pictures'] },
        'contact': { url: 'contact-us.html', title: 'Contact Us - SUPRAPA High School', keywords: ['contact', 'reach', 'address', 'phone', 'email', 'map', 'location', 'fee', 'fees', 'tuition', 'cost', 'payment', 'uniform', 'dress code', 'transport', 'bus', 'route', 'routes'] },
        'login': { url: 'login.html', title: 'Login - SHS', keywords: ['login', 'signin', 'sign in', 'log in', 'access'] },
        'student-portal': { url: 'student-portal.html', title: 'Student Portal - SUPRAPA High School', keywords: ['student', 'students', 'portal', 'student login'] },
        'admin-dashboard': { url: 'admin-dashboard.html', title: 'Admin Dashboard - SHS', keywords: ['admin', 'administration', 'dashboard', 'admin login'] },
        'student-dashboard': { url: 'student-dashboard.html', title: 'Student Dashboard - SHS', keywords: ['student dashboard', 'student area'] },
        'tenders': { url: 'tender.html', title: 'Tenders - SUPRAPA High School', keywords: ['tender', 'tenders', 'procurement', 'bid', 'bids'] },
        'syllabus': { url: 'syllabus.html', title: 'Syllabus - SUPRAPA High School', keywords: ['syllabus', 'curriculum details', 'subjects'] },
        'exam-info': { url: 'exam-info.html', title: 'Examination Information - SUPRAPA High School', keywords: ['exam info', 'examination rules', 'exam details', 'grading'] },
        'games': { url: 'fun-learning-games.html', title: 'Fun Learning Games Hub', keywords: ['game', 'games', 'fun', 'learning', 'puzzle', 'brain', 'play'] },
        'resources': { url: 'free-resources.html', title: 'Free Educational Resources - SHS', keywords: ['resource', 'resources', 'study', 'material', 'jee', 'neet', 'ndl', 'swayam', 'diksha'] },
        'faculty': { url: 'OurFaculty.html', title: 'Our Faculty - SUPRAPA High School', keywords: ['faculty', 'teacher', 'teachers', 'staff', 'educator', 'educators', 'principal'] },
        'virtual-tour': { url: 'virtual-tour.html', title: 'Virtual Tour - SUPRAPA High School', keywords: ['virtual', 'tour', 'campus view', '360', 'explore'] },
        'events': { url: 'events.html', title: 'Events - SUPRAPA High School', keywords: ['event', 'events', 'activity', 'activities', 'calendar', 'celebration', 'upcoming'] },
        'achievements': { url: 'achievements.html', title: 'Achievements - SUPRAPA High School', keywords: ['achievement', 'achievements', 'award', 'awards', 'success', 'recognition', 'topper'] },
        'alumni': { url: 'alumni.html', title: 'Alumni - SUPRAPA High School', keywords: ['alumni', 'former student', 'former students', 'graduate', 'graduates'] },
        'privacy': { url: 'privacy-policy.html', title: 'Privacy Policy - SUPRAPA High School', keywords: ['privacy', 'policy', 'data', 'cookies'] },
        'terms': { url: 'terms-of-service.html', title: 'Terms of Service - SUPRAPA High School', keywords: ['terms', 'service', 'conditions', 'rules'] },
        'payment': { url: 'payment.html', title: 'Secure Payment Page', keywords: ['payment', 'donate', 'support', 'fee payment'] },
        'sitemap': { url: 'sitemap.html', title: 'Sitemap', keywords: ['sitemap', 'site map', 'page list', 'navigation'] },
    };


    // Enhanced bot responses with personality and links
    const botResponses = {
        'hello': [
            `${getTimeGreeting()}! 👋 How can I assist you with SUPRAPA High School today?`,
            `${getTimeGreeting()}! 😊 I'm the SHS assistant bot. Ask me anything about SUPRAPA High!`,
            'Namaste! 🙏 Ready to help you explore SUPRAPA High School. What\'s on your mind?'
        ],
        'hi': [
            `${getTimeGreeting()}! Glad to chat. What information are you looking for? 🤔`,
            `${getTimeGreeting()}! How can I make your day brighter with some school info? ✨`,
            `${getTimeGreeting()}! 👋 I'm the virtual assistant for SUPRAPA High School. How may I help?`
        ],
        'admission': [
            `Thinking of joining SUPRAPA High School? Great choice! 🎉 Admissions for ${getAcademicYear()} are available. Check our <a href="Notice.html">Notices page</a> or contact the office directly!`,
            `Admissions for the ${getAcademicYear()} session are handled through the office. Check the <a href="Notice.html">Notices</a> for the latest updates!`
        ],
        'fees': [
            `Fee structures for ${getAcademicYear()} can be specific! For the most up-to-date details, please contact our accounts department via the <a href='contact-us.html'>Contact Us page</a>. ✨`,
            `Fee information is best obtained directly from our dedicated accounts team! Please connect with them via the <a href='contact-us.html'>Contact Us page</a>. 👍`
        ],
        'contact': [
            'Want to get in touch with SUPRAPA High? 📞 All our contact details (phone, email, address, and map!) are on the <a href="contact-us.html">Contact Us page</a>.',
            'You can find all the ways to reach us on the <a href="contact-us.html">Contact Us page</a>. We look forward to hearing from you!'
        ],
        'faculty': [
            'We have a fantastic team of 50+ educators at SUPRAPA High! 👨‍🏫👩‍🏫 Meet them on our <a href="ourfaculty.html">Our Faculty page</a>.',
            'Our teachers are the heart of SUPRAPA High School! Learn more about them here: <a href="ourfaculty.html">Our Faculty</a>.'
        ],
        'timing': [
            `Our usual school day runs from 8:00 AM to 3:00 PM, Monday to Friday. ⏰ For any specific changes or holidays, check the <a href='Notice.html'>Notices page</a>!`
        ],
        'facilities': [
            'SUPRAPA High offers great facilities including modern classrooms, labs, a library with 15,000+ books, and sports grounds! 🏫 Take a <a href="virtual-tour.html">Virtual Tour</a>!',
            'From science labs to our spacious library, we\'ve got it covered! Explore our <a href="virtual-tour.html">Virtual Tour</a> for a peek. ✨'
        ],
        'events': () => {
            const events = getUpcomingEvents();
            let response = 'Here are the upcoming events at SUPRAPA High! 🎉<br><br>';
            events.forEach(e => {
                response += `📅 <strong>${e.name}</strong> - in ${e.daysLeft} days!<br>`;
            });
            response += `<br>Check the <a href="events.html">Events page</a> for more details!`;
            return response;
        },
        'holiday': [
            `Looking for breaks? 🏖️ Holiday information for ${getAcademicYear()} is announced on the <a href="Notice.html">Notices page</a> or in the academic calendar.`
        ],
        'uniform': [
            'Uniform guidelines for SUPRAPA High are provided during admission. You can also inquire at the school office via the <a href="contact-us.html">Contact Us page</a>.'
        ],
        'transport': [
            `Need a ride? 🚌 We offer bus services on various routes around Cooch Behar! For specifics, please contact our transport department via the <a href='contact-us.html'>Contact Us page</a>.`
        ],
        'syllabus': [
            `You can find the class-wise syllabus for ${getAcademicYear()} on the <a href="syllabus.html">Syllabus page</a>. 📚`
        ],
        'book list': [
            `The book list for ${getAcademicYear()} session is available! Check it out on the <a href="book-list.html">Book List page</a>. 📖`
        ],
        'exam schedule': [
            'Exam routines are posted on the <a href="exam-schedule.html">Exam Schedule page</a>. Good luck with your preparation! 🤞'
        ],
        'gallery': [
            'Want to see some SUPRAPA High moments? 📸 Head over to our <a href="Gallery.html">Gallery page</a>!'
        ],
        'resources': [
            'Looking for study material? We have a <a href="free-resources.html">Free Resources</a> section with links for JEE, NEET, and study hubs like NDL and DIKSHA. Happy learning! 🧠'
        ],
        'games': [
            'Time for some fun? 🎮 Check out our <a href="fun-learning-games.html">Fun Learning Games Hub</a>!'
        ],
        'sitemap': [
            'Lost? 🤔 You can find a map of all our website pages here: <a href="sitemap.html">Sitemap</a>.'
        ],
        'fun fact': () => {
            return funFacts[Math.floor(Math.random() * funFacts.length)];
        },
        'tell me more': [
            'Sure! What specific topic would you like to know more about? You can ask about admissions, facilities, events, academics, or anything else! 😊',
            'I\'d love to tell you more! Try asking about specific things like "facilities", "events", or "faculty".',
            'Of course! Feel free to ask about any specific topic - exams, events, sports, library, or anything else about SUPRAPA High!'
        ],
        'thank you': [
            'You\'re very welcome! Happy to help at SUPRAPA High. 😊 Is there anything else?',
            'My pleasure! Let me know if you need more info about our school. 👍',
            `${getTimeGreeting()}! You're most welcome! I'm always happy to help. 😊 Anything else?`
        ],
        'bye': [
            `Goodbye! Have a great ${new Date().getHours() < 12 ? 'day' : new Date().getHours() < 17 ? 'afternoon' : 'evening'}! 👋`,
            'See you later! Feel free to come back anytime you have questions about SUPRAPA High. 🙂',
            'Goodbye for now! Stay curious and keep learning! 👋 ✨'
        ],
        'what page': () => {
            return `You're currently on ${getPageContext()} 📄`;
        },
        'this page': () => {
            return `You're on ${getPageContext()} Let me know if you have specific questions about this page! 😊`;
        },
        'default': [
            'That\'s a good question! 🤔 For the most accurate answer, I recommend checking the relevant page or contacting SUPRAPA High School via the <a href="contact-us.html">Contact Us page</a>.',
            'Hmm, I\'m still learning! 🤖 For detailed info on that, it\'s best to reach out to SUPRAPA High directly through the <a href="contact-us.html">Contact Us page</a>.',
            'I couldn\'t quite grasp that. Could you try phrasing it differently? Or, you might find your answer on the <a href="sitemap.html">Sitemap</a>! 😊'
        ]
    }; // This is the correct end of the botResponses object

    // ============================================
    // ADVANCED CHATBOT FEATURES
    // ============================================

    // --- Language Detection (Hindi/Bengali) - EXPANDED ---
    const hindiKeywords = ['namaste', 'kya', 'hai', 'kaise', 'ho', 'mujhe', 'batao', 'kab', 'kitna', 'padhna', 'karein', 'iska', 'karo', 'bolo', 'aap', 'tum', 'main', 'hum', 'yahan', 'wahan', 'kaun', 'konsa', 'kahan', 'kyun', 'chahiye', 'dijiye', 'bataiye', 'suniye'];
    const bengaliKeywords = ['ki', 'kemon', 'achen', 'kothay', 'kobe', 'porte', 'chai', 'janao', 'bol', 'amake', 'eta', 'ache', 'tumi', 'tui', 'apni', 'ami', 'amra', 'ke', 'kon', 'keno', 'kokhon', 'koto', 'dao', 'den', 'bolo', 'bolun', 'janaben', 'dekhao', 'ekhane', 'okhane', 'hobe', 'korbe', 'korbo', 'jabo', 'asbo', 'achi', 'acho', 'thako', 'thaki'];

    const hindiResponses = {
        greeting: 'Namaste! 🙏 Main SUPRAPA High School ka assistant hoon. Aapki kya madad kar sakta hoon?',
        whoami: 'Main SUPRAPA High School ka virtual assistant hoon! 🤖 Main aapko school ke baare mein jaankari de sakta hoon - admission, fees, events, ya kuch bhi poochhein!',
        admission: 'Admission ke liye, kripya hamare <a href="Notice.html">Notices page</a> dekhein ya office se sampark karein. Dhanyavaad!',
        fees: 'Fees ki jaankari ke liye, kripya <a href="contact-us.html">Contact Us page</a> par office se baat karein.',
        contact: 'Sampark: Phone - +91-9876543210, Email - info@suprapahighschool.com. <a href="contact-us.html">Contact page</a> dekhein!',
        form: 'Admission form ke liye, kripya <a href="contact-us.html">Contact Us page</a> dekhein ya office mein sampark karein.',
        default: 'Dhanyavaad! Zyada jaankari ke liye, kripya <a href="contact-us.html">Contact Us page</a> dekhein ya school office se baat karein. 😊'
    };

    const bengaliResponses = {
        greeting: 'Namaskar! 🙏 Ami SUPRAPA High School-er assistant. Apnake ki sahajyo korte pari?',
        whoami: 'Ami SUPRAPA High School-er virtual assistant! 🤖 Ami apnake school-er bishoy-e tothyo dite pari - admission, fees, events, ba onno kichhu jigges korun!',
        admission: 'Admission-er jonno, dayakore amader <a href="Notice.html">Notices page</a> dekhun ba office-e jogajog korun.',
        fees: 'Fees-er tothyo-r jonno, dayakore <a href="contact-us.html">Contact Us page</a> theke office-e kotha bolun.',
        contact: 'Jogajog: Phone - +91-9876543210, Email - info@suprapahighschool.com. <a href="contact-us.html">Contact page</a> dekhun!',
        form: 'Admission form-er jonno, dayakore <a href="contact-us.html">Contact Us page</a> dekhun ba office-e jogajog korun.',
        default: 'Dhonnobad! Aro tothyo-r jonno, dayakore <a href="contact-us.html">Contact Us page</a> dekhun ba school office-e kotha bolun. 😊'
    };

    function detectLanguage(input) {
        const words = input.toLowerCase().split(/\s+/);
        let hindiScore = 0, bengaliScore = 0;

        words.forEach(word => {
            if (hindiKeywords.some(k => word === k || word.includes(k))) hindiScore++;
            if (bengaliKeywords.some(k => word === k || word.includes(k))) bengaliScore++;
        });

        // Lowered threshold to 1 for single-word queries
        if (hindiScore > bengaliScore && hindiScore >= 1) return 'hindi';
        if (bengaliScore > hindiScore && bengaliScore >= 1) return 'bengali';
        return 'english';
    }

    function getLanguageResponse(lang, type) {
        if (lang === 'hindi') return hindiResponses[type] || hindiResponses.default;
        if (lang === 'bengali') return bengaliResponses[type] || bengaliResponses.default;
        return null;
    }

    // --- Profanity Filter ---
    const profanityWords = ['fuck', 'fck', 'shit', 'damn', 'ass', 'bitch', 'bastard', 'crap', 'wtf', 'stfu'];

    function containsProfanity(input) {
        const lowerInput = input.toLowerCase();
        return profanityWords.some(word => lowerInput.includes(word));
    }

    const profanityResponses = [
        "I understand you might be frustrated, but I'm here to help! 😊 Let's start fresh - what would you like to know about SUPRAPA High School?",
        "Let's keep things friendly! 🙏 I'm just a bot trying to help. Ask me about admission, events, or contact info!",
        "I appreciate your patience! 😅 How about we try a different question? I can help with school info, events, or contact details."
    ];

    // --- Sentiment Analysis - EXPANDED ---
    const frustratedWords = ['not working', 'useless', 'stupid', 'dumb', 'hate', 'worst', 'terrible', 'annoying', 'frustrated', 'angry', 'bad bot', 'doesnt work', "doesn't work", 'broken', 'ugh', 'argh', 'waste', 'wrong', 'incorrect', 'fail', 'sucks', 'horrible'];
    const happyWords = ['thanks', 'thank you', 'great', 'awesome', 'perfect', 'love', 'excellent', 'amazing', 'helpful', 'good job', 'nice', 'wonderful', 'fantastic'];

    function detectSentiment(input) {
        const lowerInput = input.toLowerCase();
        let frustrationScore = 0, happinessScore = 0;

        frustratedWords.forEach(w => { if (lowerInput.includes(w)) frustrationScore++; });
        happyWords.forEach(w => { if (lowerInput.includes(w)) happinessScore++; });

        if (frustrationScore > 0) return 'frustrated';
        if (happinessScore > 0) return 'happy';
        return 'neutral';
    }

    const sentimentResponses = {
        frustrated: [
            "I'm really sorry I couldn't help you better. 😔 Let me try differently - what specifically are you looking for? Or you can always reach our helpful staff at <a href='contact-us.html'>Contact Us</a>.",
            "I apologize for the confusion! 🙏 Sometimes I need things phrased simply. Try asking about: admission, fees, events, or contact. Or reach us at +91-9876543210.",
            "I understand your frustration and I'm sorry. 😞 Please try asking one simple question, or contact our office directly for immediate help: <a href='contact-us.html'>Contact Us</a>"
        ],
        happy: [
            "I'm so glad I could help! 😊 Is there anything else you'd like to know about SUPRAPA High School?",
            "Wonderful! It makes me happy to be helpful! 🌟 Feel free to ask more questions anytime!",
            "Thank you for the kind words! 💖 Let me know if there's anything else I can assist with!"
        ]
    };

    // --- Search Integration ---
    function handleSearch(query) {
        const searchTerm = query.replace(/^(search for|search|find|look for|show me)\s*/i, '').trim();
        if (!searchTerm || searchTerm.length < 2) {
            return "What would you like me to search for? Try: 'search for admission' or 'search for events'";
        }

        // Search through sitemapData
        const results = [];
        for (const pageName in sitemapData) {
            const page = sitemapData[pageName];
            const keywords = page.keywords.join(' ');
            if (keywords.includes(searchTerm.toLowerCase()) || pageName.includes(searchTerm.toLowerCase())) {
                results.push({ name: pageName, url: page.url, title: page.title });
            }
        }

        if (results.length === 0) {
            return `No results found for "${searchTerm}". 🔍 Try searching for: admission, events, faculty, gallery, or contact.`;
        }

        let response = `🔍 <strong>Search results for "${searchTerm}":</strong><br><br>`;
        results.slice(0, 5).forEach((r, i) => {
            response += `${i + 1}. <a href="${r.url}">${r.title || r.name}</a><br>`;
        });
        return response;
    }

    // --- Appointment Booking ---
    function handleAppointment() {
        return `
            <strong>📅 Book a School Visit</strong><br><br>
            We'd love to show you around SUPRAPA High School! To schedule a visit:<br><br>
            📞 <strong>Call:</strong> +91-9876543210<br>
            📧 <strong>Email:</strong> info@suprapahighschool.com<br>
            🏫 <strong>Address:</strong> Cooch Behar, West Bengal 736101<br><br>
            <strong>Visiting Hours:</strong><br>
            Mon-Fri: 9:00 AM - 3:00 PM<br>
            Sat: 10:00 AM - 1:00 PM<br><br>
            Or fill out our <a href="contact-us.html">Contact Form</a> and we'll get back to you! 😊
        `;
    }

    // Get bot response based on user input
    function getBotResponse(input) {
        // Clean input for matching
        const lowerInput = input.toLowerCase().trim().replace(/[?.,!]/g, '');

        // === PRIORITY CHECKS (before normal matching) ===

        // 0. Profanity Check - Handle inappropriate language first
        if (containsProfanity(input)) {
            return profanityResponses[Math.floor(Math.random() * profanityResponses.length)];
        }

        // 0a. Sentiment Analysis - Check if user is frustrated
        const sentiment = detectSentiment(input);
        if (sentiment === 'frustrated') {
            return sentimentResponses.frustrated[Math.floor(Math.random() * sentimentResponses.frustrated.length)];
        }

        // 0b. "Who are you?" detection (works in all languages)
        if (lowerInput.includes('who are you') || lowerInput.includes('what are you') ||
            lowerInput.includes('tumi ke') || lowerInput.includes('tui ke') || lowerInput.includes('apni ke') ||
            lowerInput.includes('kaun ho') || lowerInput.includes('aap kaun') || lowerInput.includes('tum kaun') ||
            lowerInput.includes('your name') || lowerInput.includes('whats your name')) {
            const detectedLang = detectLanguage(input);
            if (detectedLang === 'bengali') {
                return getLanguageResponse('bengali', 'whoami');
            } else if (detectedLang === 'hindi') {
                return getLanguageResponse('hindi', 'whoami');
            }
            return "I'm SUPRAPA High School's virtual assistant! 🤖 I can help you with information about admission, fees, events, facilities, and more. Just ask away!";
        }

        // 0c. Language Detection - Respond in Hindi/Bengali if detected
        const detectedLang = detectLanguage(input);
        if (detectedLang !== 'english') {
            // Detect topic for language-specific response
            if (lowerInput.includes('admission') || lowerInput.includes('padhna') || lowerInput.includes('porte') || lowerInput.includes('bhrti')) {
                return getLanguageResponse(detectedLang, 'admission');
            }
            if (lowerInput.includes('fees') || lowerInput.includes('kitna') || lowerInput.includes('koto') || lowerInput.includes('paisa')) {
                return getLanguageResponse(detectedLang, 'fees');
            }
            if (lowerInput.includes('contact') || lowerInput.includes('sampark') || lowerInput.includes('jogajog') || lowerInput.includes('phone')) {
                return getLanguageResponse(detectedLang, 'contact');
            }
            if (lowerInput.includes('form')) {
                return getLanguageResponse(detectedLang, 'form');
            }
            // Default greeting for the detected language
            return getLanguageResponse(detectedLang, 'greeting');
        }

        // 0d. Search Command
        if (lowerInput.startsWith('search') || lowerInput.startsWith('find') || lowerInput.startsWith('look for') || lowerInput.startsWith('show me')) {
            return handleSearch(input);
        }

        // 0e. Appointment Booking (with typo handling)
        if (lowerInput.includes('visit') || lowerInput.includes('appointment') || lowerInput.includes('appoimtment') ||
            lowerInput.includes('appoitment') || lowerInput.includes('book') || lowerInput.includes('schedule visit') ||
            lowerInput.includes('come to school') || lowerInput.includes('tour booking')) {
            return handleAppointment();
        }

        // 0f. Form Request
        if (lowerInput.includes('form') || lowerInput.includes('application') || lowerInput.includes('apply')) {
            return `Looking for a form? 📝<br><br>
                <strong>Admission Form:</strong> Available at school office or during admission period on <a href="Notice.html">Notices page</a><br>
                <strong>Contact Form:</strong> Fill out our <a href="contact-us.html">Contact Us form</a> for inquiries<br><br>
                For specific forms, please contact the school office!`;
        }

        // Enhanced fuzzy matching (handles typos better)
        function fuzzyMatch(keyword, input) {
            // Handle simple plurals (add 's')
            if (keyword.slice(-1) !== 's' && input.includes(keyword + 's')) return true;
            // Handle common typo removing one char (e.g., noticess -> notices)
            if (keyword.length > 4 && input.includes(keyword.slice(0, -1))) return true;
            // Handle double letters (e.g., addmission -> admission)
            const dedoubled = input.replace(/(.)\1+/g, '$1');
            if (dedoubled.includes(keyword)) return true;
            // Handle missing letters in middle (e.g., admision -> admission)
            for (let i = 1; i < keyword.length - 1; i++) {
                const shortened = keyword.slice(0, i) + keyword.slice(i + 1);
                if (input.includes(shortened) && shortened.length >= 4) return true;
            }
            // Handle swapped letters for short words
            if (keyword.length > 3 && keyword.length <= 10) {
                for (let i = 0; i < keyword.length - 1; i++) {
                    const swapped = keyword.slice(0, i) + keyword[i + 1] + keyword[i] + keyword.slice(i + 2);
                    if (input.includes(swapped)) return true;
                }
            }
            return false;
        }

        // Helper to get response (handles both arrays and functions)
        function getResponse(responseData) {
            if (typeof responseData === 'function') {
                return responseData();
            } else if (Array.isArray(responseData) && responseData.length > 0) {
                return responseData[Math.floor(Math.random() * responseData.length)];
            }
            return null;
        }

        // 1. Check for Fun Facts
        if (lowerInput.includes('fun fact') || lowerInput.includes('tell me something') || lowerInput.includes('trivia') || lowerInput.includes('did you know')) {
            return getResponse(botResponses['fun fact']) || getResponse(botResponses.default);
        }

        // 2. Check for "Tell me more" (multi-turn conversation)
        if (lowerInput.includes('tell me more') || lowerInput.includes('more info') || lowerInput.includes('more about') || lowerInput.includes('elaborate')) {
            return getResponse(botResponses['tell me more']) || getResponse(botResponses.default);
        }

        // 3. Check for "This page" (page context)
        if (lowerInput.includes('this page') || lowerInput.includes('about this') || lowerInput.includes('about here')) {
            return getResponse(botResponses['this page']) || getResponse(botResponses.default);
        }

        // 4. Check for "What page am I on?"
        if (lowerInput.includes('what page') || lowerInput.includes('which page') || lowerInput.includes('where am i') || lowerInput.includes('current page')) {
            return getResponse(botResponses['what page']) || getResponse(botResponses.default);
        }

        // 4. Check for Greetings
        if (['hello', 'hi', 'hey', 'heya', 'good morning', 'good afternoon', 'good evening', 'namaste'].some(g => lowerInput.startsWith(g) || lowerInput === g)) {
            const responses = (botResponses.hello || []).concat(botResponses.hi || []);
            if (Array.isArray(responses) && responses.length > 0) {
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        // 5. Check for Farewells
        if (['bye', 'goodbye', 'see ya', 'later', 'farewell', 'good night'].some(f => lowerInput.includes(f))) {
            return getResponse(botResponses.bye) || getResponse(botResponses.default);
        }

        // 6. Check for Thanks
        if (lowerInput.includes('thank') || lowerInput.includes('thanks') || lowerInput.includes('ty') || lowerInput.includes('appreciate')) {
            return getResponse(botResponses['thank you']) || getResponse(botResponses.default);
        }

        // 7. Check for Events specifically (to trigger countdown)
        if (lowerInput.includes('event') || lowerInput.includes('upcoming') || lowerInput.includes('whats happening') || lowerInput.includes("what's happening")) {
            return getResponse(botResponses.events) || getResponse(botResponses.default);
        }

        // 8. Check Sitemap Keywords (Exact and Fuzzy)
        let bestMatch = null;
        let matchType = 0; // 0: No Match, 1: Fuzzy, 2: Exact

        for (const pageName in sitemapData) {
            for (const keyword of sitemapData[pageName].keywords) {
                // Prioritize exact matches first
                if (lowerInput.includes(keyword)) {
                    if (matchType < 2) {
                        bestMatch = pageName;
                        matchType = 2;
                    } else if (matchType === 2 && keyword.length > sitemapData[bestMatch].keywords.find(k => lowerInput.includes(k)).length) {
                        bestMatch = pageName;
                    }
                }
                // Check fuzzy match only if no exact match found yet
                else if (matchType < 1 && fuzzyMatch(keyword, lowerInput)) {
                    bestMatch = pageName;
                    matchType = 1;
                }
            }
        }


        if (bestMatch) {
            const pageInfo = sitemapData[bestMatch];
            console.log(`Matched input '${input}' to page '${bestMatch}' (Type: ${matchType === 2 ? 'Exact' : 'Fuzzy'})`);
            // Provide specific canned responses for certain pages
            switch (bestMatch) {
                case 'contact':
                    return `Absolutely! You can find all SUPRAPA High's contact details (phone, email, address, map!) right here on the <a href="${pageInfo.url}">Contact Us page</a>. We look forward to hearing from you! 📞💖`;
                case 'faculty':
                    return `We have such a wonderful team of 50+ educators at SUPRAPA High! 👨‍🏫👩‍🏫 You can learn more about them on our <a href="${pageInfo.url}">Our Faculty page</a>.`;
                case 'gallery':
                    return `Want to see some lovely moments from SUPRAPA High? 📸 Head over to our <a href="${pageInfo.url}">Gallery page</a>! ✨`;
                case 'notices':
                    return `For all the latest news, announcements, and updates from SUPRAPA High, the <a href="${pageInfo.url}">Notices page</a> is your go-to place! 📢😊`;
                case 'events':
                    return getResponse(botResponses.events);
                case 'resources':
                    return `Looking for study materials? 📚 Check out our <a href="${pageInfo.url}">Free Resources page</a>. It has helpful links for JEE, NEET, and general study hubs! Happy learning! 🧠🌸`;
                case 'games':
                    return `Time for a fun break? 🎮 Why not check out our <a href="${pageInfo.url}">Fun Learning Games Hub</a>! Enjoy!`;
                case 'sitemap':
                    return `Looking for the sitemap? You've found it! 😉 This page lists all our website sections: <a href="${pageInfo.url}">Sitemap</a>.`;
                case 'about':
                    return `SUPRAPA High School was established in 1884 and has a rich history! For all the details about our values, infrastructure, and story, please visit the <a href="${pageInfo.url}">About Us page</a>. ✨`;
                case 'syllabus':
                    return `Certainly! You can find the class-wise syllabus for ${getAcademicYear()} right here: <a href="${pageInfo.url}">Syllabus page</a>. 📚`;
                case 'academics':
                    return `SUPRAPA High offers courses for Secondary (IX-X) and Higher Secondary (XI-XII) including Science, Commerce, and Humanities streams. More details on the <a href="${pageInfo.url}">Academic Structure page</a>. 🏫`;
                case 'exams':
                    return `Exam schedules are posted here: <a href="${pageInfo.url}">Exam Schedule page</a>. Wishing you the best! 🤞`;
                case 'virtual-tour':
                    return `Want to explore our campus? 🏫 Take a look at our modern classrooms, library, labs, and sports facilities on the <a href="${pageInfo.url}">Virtual Tour page</a>! ✨`;
                case 'achievements':
                    return `SUPRAPA High has a proud history of achievements! 🏆 Check out our awards and student successes on the <a href="${pageInfo.url}">Achievements page</a>.`;
                case 'alumni':
                    return `Want to see where SUPRAPA High alumni are now? 🎓 Visit our <a href="${pageInfo.url}">Alumni page</a> to learn about their success stories!`;
                default:
                    const friendlyPageName = bestMatch.replace(/-/g, ' ');
                    const linkText = pageInfo.title || friendlyPageName;
                    return `I believe you're asking about ${friendlyPageName}. You can find more information here: <a href="${pageInfo.url}">${linkText}</a> Let me know if that helps! 😊`;
            }
        }

        // 9. Check Specific Hardcoded Keywords (if not caught by sitemap)
        if (lowerInput.includes('admission') || lowerInput.includes('enroll') || lowerInput.includes('join')) {
            return getResponse(botResponses.admission) || getResponse(botResponses.default);
        }
        if (lowerInput.includes('fee') || lowerInput.includes('tuition') || lowerInput.includes('cost')) {
            return getResponse(botResponses.fees) || getResponse(botResponses.default);
        }
        if ((lowerInput.includes('timing') || lowerInput.includes('hour') || lowerInput.includes('schedule')) && !lowerInput.includes('exam')) {
            return getResponse(botResponses.timing) || getResponse(botResponses.default);
        }
        if (lowerInput.includes('uniform') || lowerInput.includes('dress code')) {
            return getResponse(botResponses.uniform) || getResponse(botResponses.default);
        }
        if (lowerInput.includes('transport') || lowerInput.includes('bus')) {
            return getResponse(botResponses.transport) || getResponse(botResponses.default);
        }
        if (lowerInput.includes('facility') || lowerInput.includes('infrastructure') || lowerInput.includes('lab') || lowerInput.includes('library')) {
            return getResponse(botResponses.facilities) || getResponse(botResponses.default);
        }
        if (lowerInput.includes('holiday') || lowerInput.includes('vacation') || lowerInput.includes('break')) {
            return getResponse(botResponses.holiday) || getResponse(botResponses.default);
        }

        // 10. Default Fallback
        return getResponse(botResponses.default) || "Sorry, I seem to be having trouble thinking right now. Please try again later or contact SUPRAPA High School directly.";
    }

}





// Enhance chatbot natural language understanding
// --- MODIFIED: Simple NLU - focuses on keywords ---
function processChatbotInput(input) {
    // This function is kept for potential future expansion with more complex NLU.
    // For now, the primary logic is within getBotResponse.
    console.log("Processing input (basic):", input);
    // You could add basic intent recognition here later if needed.
    return getBotResponse(input); // Pass to the main response function
}

// Add chatbot suggestions
function showChatbotSuggestions() {
    const suggestions = [
        "Tell me about the school",
        "What courses do you offer?",
        "How can I contact the school?",
        "What are the upcoming events?"
    ];
    const suggestionContainer = document.createElement('div');
    // --- MODIFIED: Use correct class name for container --- 
    suggestionContainer.className = 'chatbot-suggestions'; // Use the class name targeted by CSS

    // --- ADDED: Optional title for the suggestions --- 
    const titleElement = document.createElement('p');
    titleElement.textContent = 'Try asking:';
    suggestionContainer.appendChild(titleElement);
    // --- END ADDED ---

    suggestions.forEach(suggestion => {
        const button = document.createElement('button');
        button.textContent = suggestion;
        // --- ADDED: Add the correct class to the button --- 
        button.className = 'suggestion-button';
        button.addEventListener('click', () => {
            const chatInput = document.querySelector('.chatbot-input input');
            const sendButton = document.querySelector('.chatbot-input button');
            if (chatInput) {
                chatInput.value = suggestion;
            }
            if (sendButton) {
                sendButton.click(); // Simulate clicking the send button
            }
            // Hide suggestions after clicking one
            suggestionContainer.style.display = 'none';
        });
        suggestionContainer.appendChild(button);
    });

    // Prepend to messages area for better layout flow
    const messagesContainer = document.querySelector('.chatbot-messages');
    if (messagesContainer) {
        messagesContainer.appendChild(suggestionContainer); // Append to keep it at the bottom
    } else {
        // Fallback to prepending to the main container if messages area isn't found
        const mainContainer = document.querySelector('.chatbot-container');
        if (mainContainer) {
            mainContainer.prepend(suggestionContainer);
        } else {
            console.error("Chatbot container not found to add suggestions.");
        }
    }
}

// Initialize chatbot suggestions on first open
// --- MODIFIED: Ensure elements exist before adding listener --- 
const chatbotTriggerButton = document.querySelector('.chatbot-trigger button');
if (chatbotTriggerButton) {
    chatbotTriggerButton.addEventListener('click', function () {
        // Ensure suggestions are shown or re-shown when opening
        let suggestionContainer = document.querySelector('.chatbot-suggestions');
        if (!suggestionContainer) {
            showChatbotSuggestions();
        } else {
            // If it exists but was hidden, show it again
            suggestionContainer.style.display = 'flex'; // Use flex to re-apply display style
        }
    });
} else {
    console.warn("Chatbot trigger button not found.");
}
// --- END MODIFICATION ---
// ====================================================================
// HELPER FUNCTIONS (Keep these available globally or within scope)
// ====================================================================
// ... (rest of helper functions)

// Virtual Tour Functionality
function initVirtualTour() {
    const tourLocations = document.querySelectorAll('.tour-location');
    const tourCta = document.querySelector('.tour-cta .btn-primary');

    if (tourLocations) {
        tourLocations.forEach(location => {
            location.addEventListener('click', function () {
                const locationName = this.querySelector('h4').textContent;
                const locationImg = this.querySelector('img').src;

                // Would typically open a modal or redirect to a detailed view
                console.log(`Virtual tour of ${locationName} requested`);

                // Placeholder for actual virtual tour functionality
                // Could implement a lightbox gallery or 360° viewer here
            });
        });
    }

    if (tourCta) {
        tourCta.addEventListener('click', function (e) {
            e.preventDefault();
            window.location.href = this.getAttribute('href');
        });
    }
}

// Events Section Functionality
function initEventsSection() {
    const eventItems = document.querySelectorAll('.event-item');
    const eventsCtaBtn = document.querySelector('.events-cta .btn-primary');

    if (eventItems) {
        eventItems.forEach(item => {
            item.addEventListener('click', function () {
                const eventTitle = this.querySelector('h4').textContent;
                const eventUrl = this.getAttribute('data-event-url');

                if (eventUrl) {
                    window.location.href = eventUrl;
                } else {
                    console.log(`Event details for ${eventTitle} requested`);
                }
            });
        });
    }

    if (eventsCtaBtn) {
        eventsCtaBtn.addEventListener('click', function (e) {
            e.preventDefault();
            window.location.href = this.getAttribute('href');
        });
    }
}

// Student Achievements Carousel
function initAchievementsCarousel() {
    const achievementsCarousel = document.querySelector('.achievements-carousel');
    if (!achievementsCarousel) return;

    // This would typically use a carousel library like Slick or Swiper
    // Placeholder for carousel initialization
    console.log('Achievements carousel would be initialized here');

    // Example implementation with a simple auto-scrolling mechanism
    const achievementCards = achievementsCarousel.querySelectorAll('.achievement-card');
    let currentIndex = 0;

    if (achievementCards.length > 1) {
        // Hide all but the first card
        achievementCards.forEach((card, index) => {
            if (index !== 0) card.style.display = 'none';
        });

        // Rotate cards every 5 seconds
        setInterval(() => {
            achievementCards[currentIndex].style.display = 'none';
            currentIndex = (currentIndex + 1) % achievementCards.length;
            achievementCards[currentIndex].style.display = 'block';
        }, 5000);
    }
}

// Helper function to validate email
function isValidEmail(email) {
    // Simple regex for email validation
    const emailRegex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return emailRegex.test(String(email).toLowerCase());
}

// Newsletter Form Submission
function initNewsletterForm() {
    console.log("Initializing Newsletter Form...");
    const footer = document.querySelector('.site-footer');
    // Add check to ensure footer exists before querying within it
    if (!footer) {
        console.warn("Footer element not found when initializing newsletter form.");
        return;
    }
    const newsletterForm = footer.querySelector('form.newsletter-signup');

    if (newsletterForm) {
        const emailInput = newsletterForm.querySelector('input[type="email"]');
        const submitButton = newsletterForm.querySelector('button[type="submit"]');

        if (emailInput && submitButton) {
            newsletterForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const email = emailInput.value;

                if (isValidEmail(email)) {
                    // Simulate subscription process
                    submitButton.textContent = 'Subscribing...';
                    submitButton.disabled = true;

                    setTimeout(() => {
                        // Show success message using tooltip
                        showTooltip(`Thank you for subscribing, ${email}!`, 3000, 'success');
                        emailInput.value = ''; // Clear input
                        submitButton.textContent = 'Subscribe';
                        submitButton.disabled = false;
                    }, 1500); // Simulate network delay
                } else {
                    // Show error message using tooltip
                    showTooltip('Please enter a valid email address.', 3000, 'error');
                    // Optionally, add visual feedback to the input field
                    emailInput.focus(); // Bring focus back to email input
                    // emailInput.style.border = '2px solid red'; // Example visual cue
                }
            });
            console.log("Newsletter form initialized successfully.");
        } else {
            console.warn("Newsletter email input or submit button not found.");
        }
    } else {
        console.warn("Newsletter form not found in the footer."); // Keep warning for debugging
    }
}

// Social Media Feeds Integration
function initSocialMediaFeeds() {
    const socialFeedContainer = document.querySelector('.social-feed-container');
    if (!socialFeedContainer) return;

    // This would typically use the respective social media platform APIs
    // Placeholder for social media feed integration
    console.log('Social media feeds would be loaded here');

    // Example implementation - simulate loading social media content
    socialFeedContainer.innerHTML = '<div class="loading">Loading social media feeds...</div>';

    // Simulate API call delay
    setTimeout(() => {
        // Example of what would be returned from social media APIs
        const mockSocialPosts = [
            {
                platform: 'facebook',
                content: 'Congratulations to our students for their excellent performance in the district science competition!',
                date: '2 days ago',
                likes: 45
            },
            {
                platform: 'twitter',
                content: 'Registration for the upcoming summer camp is now open. Limited seats available!',
                date: '5 hours ago',
                likes: 23
            },
            {
                platform: 'instagram',
                content: 'Glimpses from our annual sports day celebration. Swipe to see more photos!',
                date: 'Yesterday',
                likes: 89
            }
        ];

        // Render mock social posts
        socialFeedContainer.innerHTML = '';
        mockSocialPosts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.className = `social-post ${post.platform}`;
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="platform-icon ${post.platform}">${getPlatformIcon(post.platform)}</div>
                    <div class="post-date">${post.date}</div>
                </div>
                <div class="post-content">${post.content}</div>
                <div class="post-footer">
                    <div class="post-likes">❤️ ${post.likes} likes</div>
                </div>
            `;
            socialFeedContainer.appendChild(postElement);
        });
    }, 1500);

    // Helper function to get platform icons
    function getPlatformIcon(platform) {
        const icons = {
            'facebook': 'F',
            'twitter': 'X',
            'instagram': 'I'
        };
        return icons[platform] || '';
    }
}

// Testimonials Carousel
function initTestimonialsCarousel() {
    const testimonialsWrapper = document.querySelector('.testimonials-wrapper');
    if (!testimonialsWrapper) return;

    // This would typically use a carousel library like Slick or Swiper
    // Placeholder for testimonials carousel initialization
    console.log('Testimonials carousel would be initialized here');

    // Example implementation with a simple auto-scrolling mechanism
    const testimonialCards = testimonialsWrapper.querySelectorAll('.testimonial-card');
    let currentIndex = 0;

    if (testimonialCards.length > 1) {
        // Hide all but the first testimonial
        testimonialCards.forEach((card, index) => {
            if (index !== 0) card.style.display = 'none';
        });

        // Rotate testimonials every 8 seconds
        setInterval(() => {
            testimonialCards[currentIndex].style.display = 'none';
            currentIndex = (currentIndex + 1) % testimonialCards.length;
            testimonialCards[currentIndex].style.display = 'block';
        }, 8000);
    }
}

// Helper function to find and update dark mode toggle emoji
function updateDarkModeToggleEmoji(isDarkMode, showNotification = false) {
    const toggle = document.getElementById('dark-mode-toggle');
    if (toggle) {
        // Correct the emoji based on mode (sun for light, moon for dark)
        toggle.textContent = isDarkMode ? '🌙' : '☀️';
        toggle.setAttribute('aria-label', isDarkMode ? 'Currently in Dark Mode' : 'Currently in Light Mode');

        // Show notification about current mode
        if (showNotification) {
            showTooltip(`Currently in ${isDarkMode ? 'Dark' : 'Light'} Mode`, 3000);
        }
    }
}

// Add event listener to dark mode toggle to handle custom contrast mode
document.addEventListener('DOMContentLoaded', function () {
    const toggle = document.getElementById('dark-mode-toggle');
    if (toggle) {
        // Update the emoji initially based on the saved dark mode setting 
        const savedMode = localStorage.getItem('darkMode');
        const isDarkMode = savedMode === 'true'; // Don't use body class here, use localStorage directly
        updateDarkModeToggleEmoji(isDarkMode, false);

        // Add custom event handler
        toggle.addEventListener('click', function () {
            // Toggle the dark mode in localStorage and apply immediately
            const currentDarkMode = document.documentElement.classList.contains('dark-mode');
            const newDarkMode = !currentDarkMode;

            // Update localStorage
            localStorage.setItem('darkMode', newDarkMode ? 'true' : 'false');

            // Apply class to HTML and body elements
            if (newDarkMode) {
                document.documentElement.classList.add('dark-mode');
                document.body.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
                document.body.classList.remove('dark-mode');
            }

            // If switching TO dark mode, disable high contrast mode if active
            if (newDarkMode) {
                if (document.body.classList.contains('high-contrast')) {
                    // Find and trigger the high contrast toggle to disable it
                    const highContrastToggle = document.getElementById('highContrastToggle');
                    if (highContrastToggle && highContrastToggle.checked) {
                        // Show notification first
                        showTooltip('Disabling high contrast for dark mode compatibility', 3000);

                        // Uncheck the toggle
                        highContrastToggle.checked = false;

                        // Trigger the change event to apply changes
                        const event = new Event('change');
                        highContrastToggle.dispatchEvent(event);
                    }
                }
            }

            // Update emoji immediately
            updateDarkModeToggleEmoji(newDarkMode, true);

            // --- ADDED: Update logo based on new theme ---
            if (typeof window.updateSchoolLogoBasedOnMode === 'function') {
                window.updateSchoolLogoBasedOnMode();
            } else {
                console.warn("Dark Mode Toggle: window.updateSchoolLogoBasedOnMode function not found.");
            }
            // --- END ADDED ---
        });
    }
});

// Function to handle high contrast toggle on/off
function handleHighContrastToggle(isEnabled) {
    // --- ADDED: Save state consistently ---
    localStorage.setItem('highContrastEnabled', isEnabled ? 'true' : 'false');
    // --- END ADDED ---

    // If enabling high contrast while in dark mode, switch to light mode first
    if (isEnabled && document.body.classList.contains('dark-mode')) {
        // Switch to light mode
        document.body.classList.remove('dark-mode');

        // Update dark mode toggle emoji
        updateDarkModeToggleEmoji(false);

        // Save preference
        localStorage.setItem('darkMode', 'false');

        // Show toast message
        showTooltip('Switching to light mode for better high contrast experience', 4000);
    }

    // Add/remove high contrast class
    if (isEnabled) {
        document.body.classList.add('high-contrast');

        // Apply theme based on stored preference
        const theme = localStorage.getItem('contrastTheme') || 'black-white';
        setContrastTheme(theme);

        // Change accessibility panel to dark style for better visibility
        const accessibilityPanel = document.querySelector('.accessibility-panel');
        if (accessibilityPanel) {
            accessibilityPanel.classList.add('custom-contrast-panel');
        }
    } else {
        document.body.classList.remove('high-contrast');
        document.body.classList.remove('theme-black-white', 'theme-custom');

        // Remove custom panel style if exists
        const accessibilityPanel = document.querySelector('.accessibility-panel');
        if (accessibilityPanel) {
            accessibilityPanel.classList.remove('custom-contrast-panel');
        }

        // Remove any custom styles for high contrast
        const styleTag = document.getElementById('high-contrast-text-style');
        if (styleTag) {
            styleTag.textContent = '';
        }
        const imageStyleTag = document.getElementById('contrast-image-style');
        if (imageStyleTag) {
            imageStyleTag.textContent = '';
        }
    }
}

// Check if map is loading and provide placeholder if not
function initMapConnectivityCheck() {
    // Add internal initialization flag
    if (window.mapConnectivityInitialized) {
        // console.log("Map connectivity check already initialized.");
        return;
    }
    window.mapConnectivityInitialized = true;
    console.log("Initializing Map Connectivity Check...");

    const mapContainers = document.querySelectorAll('.map-container');
    if (mapContainers.length === 0) return; // No maps on this page

    console.log('Enhanced accessibility: Found ' + mapContainers.length + ' map containers to handle');

    mapContainers.forEach((container, index) => {
        const existingIframe = container.querySelector('iframe');
        if (!existingIframe) return;

        const originalSrc = existingIframe.getAttribute('src'); // Get original source
        const iframeAttributes = {};
        Array.from(existingIframe.attributes).forEach(attr => {
            if (attr.name !== 'src') iframeAttributes[attr.name] = attr.value;
        });

        // Use a wrapper div to manage content switching
        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'map-wrapper';
        wrapperDiv.style.width = iframeAttributes.width || '100%';
        wrapperDiv.style.height = iframeAttributes.height || '300px';
        wrapperDiv.style.position = 'relative'; // For positioning placeholder/iframe

        // Create placeholder
        const placeholderDiv = document.createElement('div');
        placeholderDiv.className = 'map-placeholder';
        placeholderDiv.style.width = '100%';
        placeholderDiv.style.height = '100%';
        placeholderDiv.style.display = 'flex'; // Start visible
        placeholderDiv.style.alignItems = 'center';
        placeholderDiv.style.justifyContent = 'center';
        placeholderDiv.style.backgroundColor = '#f0f0f0';
        placeholderDiv.style.border = '1px solid #ddd';
        placeholderDiv.style.borderRadius = iframeAttributes.style?.includes('border-radius: 8px') ? '8px' : '0';
        placeholderDiv.style.textAlign = 'center';
        placeholderDiv.innerHTML = '<p style="margin:0; color:#777;">Checking map connectivity...</p>';
        wrapperDiv.appendChild(placeholderDiv);

        // Replace original iframe with the wrapper
        existingIframe.parentNode.replaceChild(wrapperDiv, existingIframe);

        let currentIframe = null;
        let loadTimeout = null;

        function createAndLoadIframe() {
            // Remove previous iframe if exists
            if (currentIframe && wrapperDiv.contains(currentIframe)) {
                wrapperDiv.removeChild(currentIframe);
            }
            clearTimeout(loadTimeout); // Clear previous timeout

            currentIframe = document.createElement('iframe');
            Object.keys(iframeAttributes).forEach(attrName => {
                currentIframe.setAttribute(attrName, iframeAttributes[attrName]);
            });
            currentIframe.id = 'map-iframe-' + index;
            currentIframe.style.width = '100%';
            currentIframe.style.height = '100%';
            currentIframe.style.border = '0';
            currentIframe.style.display = 'none'; // Start hidden
            currentIframe.setAttribute('loading', 'lazy'); // Ensure lazy loading

            let loaded = false;
            currentIframe.onload = () => {
                if (loaded) return; // Prevent double execution
                loaded = true;
                clearTimeout(loadTimeout);
                console.log(`Map ${index} iframe onload event fired.`);
                placeholderDiv.style.display = 'none';
                currentIframe.style.display = 'block';
            };
            currentIframe.onerror = (e) => {
                console.error(`Map ${index} iframe onerror event fired:`, e);
                clearTimeout(loadTimeout);
                showPlaceholderContent('Map failed to load. Check connection or browser settings.');
            };

            wrapperDiv.appendChild(currentIframe);
            currentIframe.setAttribute('src', originalSrc); // Set src AFTER appending and setting listeners

            // Fallback timeout in case onload doesn't fire (e.g., due to network issues)
            loadTimeout = setTimeout(() => {
                if (!loaded) {
                    console.warn(`Map ${index} load timeout reached. Assuming loaded if still online.`);
                    // Check online status again before showing map
                    if (navigator.onLine) {
                        placeholderDiv.style.display = 'none';
                        currentIframe.style.display = 'block';
                    } else {
                        showPlaceholderContent('Map timed out. Check connection.');
                    }
                }
            }, 10000); // 10 seconds timeout
        }

        function showPlaceholderContent(message) {
            console.log(`Map ${index}: Showing placeholder - ${message}`);
            placeholderDiv.innerHTML = `<p style="margin:0; color:#777;">${message}</p>`;
            placeholderDiv.style.display = 'flex';
            if (currentIframe && wrapperDiv.contains(currentIframe)) {
                currentIframe.style.display = 'none'; // Hide iframe
            }
        }

        function checkAndLoad() {
            if (navigator.onLine) {
                showPlaceholderContent('Loading map...');
                createAndLoadIframe();
            } else {
                showPlaceholderContent('Offline. Map cannot be loaded.');
            }
        }

        // Initial check
        checkAndLoad();

        // Listen for online/offline events
        window.addEventListener('online', checkAndLoad);
        window.addEventListener('offline', () => showPlaceholderContent('Connection lost. Map cannot be loaded.'));
    });
}

// Set up an observer to watch for dynamically added info icons
function setupInfoIconObserver() {
    if (!window.MutationObserver) {
        console.log('Enhanced accessibility: MutationObserver not supported in this browser');
        return;
    }

    const observer = new MutationObserver(function (mutations) {
        let shouldSetupIcons = false;

        mutations.forEach(function (mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Check if any of the added nodes contain info icons
                for (let i = 0; i < mutation.addedNodes.length; i++) {
                    const node = mutation.addedNodes[i];
                    if (node.nodeType === 1) { // Element node
                        if (node.classList && node.classList.contains('info-icon')) {
                            shouldSetupIcons = true;
                            break;
                        } else if (node.querySelectorAll) {
                            const icons = node.querySelectorAll('.info-icon');
                            if (icons.length > 0) {
                                shouldSetupIcons = true;
                                break;
                            }
                        }
                    }
                }
            }
        });

        // If new info icons were added, set them up
        if (shouldSetupIcons) {
            console.log('Enhanced accessibility: New info icons detected, setting up');
            setupInfoIcons();
        }
    });

    // Observe changes to the entire document body
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });

    console.log('Enhanced accessibility: Info icon observer set up');
}



// Reset all accessibility settings function - ADDED THIS FUNCTION
function resetAllAccessibilitySettings() {
    console.log("Resetting all accessibility settings");

    // Reset all localStorage items related to accessibility
    localStorage.removeItem('textSize');
    localStorage.removeItem('highContrast');
    localStorage.removeItem('contrastTheme');
    localStorage.removeItem('contrastBgColor');
    localStorage.removeItem('contrastTextColor');
    localStorage.removeItem('contrastLinkColor');
    localStorage.removeItem('focusHighlightEnabled');
    localStorage.removeItem('linksUnderlined');
    localStorage.removeItem('readingGuide');
    localStorage.removeItem('readingGuideColor');
    localStorage.removeItem('readingGuideHeight');
    localStorage.removeItem('readingGuideOpacity');
    localStorage.removeItem('readingGuideBorderStyle');
    localStorage.removeItem('dyslexiaFont');
    localStorage.removeItem('largeCursorEnabled');
    localStorage.removeItem('cursorSize');
    localStorage.removeItem('cursorColor');
    localStorage.removeItem('wordSpacing');
    localStorage.removeItem('letterSpacing');
    localStorage.removeItem('lineHeight');

    // Remove all accessibility classes from body
    document.body.classList.remove(
        'high-contrast',
        'theme-white-black',
        'theme-custom',
        'focus-highlight',
        'links-underlined',
        'dyslexia-font',
        'cursor-large',
        'cursor-small',
        'cursor-medium'
    );

    // Reset styles
    document.body.style.fontSize = '';
    document.body.style.wordSpacing = '';
    document.body.style.letterSpacing = '';
    document.body.style.lineHeight = '';

    // Reset reading guide
    const readingGuide = document.getElementById('readingGuide');
    if (readingGuide) {
        readingGuide.style.display = 'none';
    }

    // Reset any toggles
    const toggles = document.querySelectorAll('input[type="checkbox"]');
    toggles.forEach(toggle => {
        toggle.checked = false;
    });

    // Reset any sliders to their default values
    const textSizeSlider = document.getElementById('textSizeSlider');
    if (textSizeSlider) textSizeSlider.value = 100;

    const wordSpacingSlider = document.getElementById('wordSpacingSlider');
    if (wordSpacingSlider) wordSpacingSlider.value = 0;

    const letterSpacingSlider = document.getElementById('letterSpacingSlider');
    if (letterSpacingSlider) letterSpacingSlider.value = 0;

    const lineHeightSlider = document.getElementById('lineHeightSlider');
    if (lineHeightSlider) lineHeightSlider.value = 1.5;

    const readingGuideHeightSlider = document.getElementById('readingGuideHeightSlider');
    if (readingGuideHeightSlider) readingGuideHeightSlider.value = 14;

    // Update display values
    const textSizeValue = document.getElementById('textSizeValue');
    if (textSizeValue) textSizeValue.textContent = '100%';

    const wordSpacingValue = document.getElementById('wordSpacingValue');
    if (wordSpacingValue) wordSpacingValue.textContent = '0px';

    const letterSpacingValue = document.getElementById('letterSpacingValue');
    if (letterSpacingValue) letterSpacingValue.textContent = '0px';

    const lineHeightValue = document.getElementById('lineHeightValue');
    if (lineHeightValue) lineHeightValue.textContent = '1.5';

    // --- ADDED: Explicitly update Font Size Value Display ---
    const fontSizeValue = document.getElementById('fontSizeValue');
    if (fontSizeValue) fontSizeValue.textContent = '100%';
    // --- END ADDED --- 

    // --- MODIFIED: Reset specific button groups visually --- 
    const panel = document.getElementById('accessibilityPanel');
    if (panel) {
        // Reset Contrast Theme buttons
        const themeButtons = panel.querySelectorAll('.contrast-theme-btn');
        themeButtons.forEach(btn => btn.classList.remove('active'));
        const defaultThemeBtn = panel.querySelector('.contrast-theme-btn[data-theme="black-white"]');
        if (defaultThemeBtn) defaultThemeBtn.classList.add('active');
        const customColorsDiv = panel.querySelector('.custom-contrast-colors');
        if (customColorsDiv) customColorsDiv.style.display = 'none'; // Hide custom colors

        // Reset Reading Guide Border buttons
        const borderButtons = panel.querySelectorAll('.border-style-btn');
        borderButtons.forEach(btn => btn.classList.remove('active'));
        const defaultBorderBtn = panel.querySelector('.border-style-btn[data-style="solid"]');
        if (defaultBorderBtn) defaultBorderBtn.classList.add('active');

        // Reset Cursor Size buttons
        const cursorSizeButtons = panel.querySelectorAll('.cursor-size-btn');
        cursorSizeButtons.forEach(btn => btn.classList.remove('active'));
        // No default active state for cursor size unless large cursor is enabled

    } else {
        console.warn("ResetAll: Could not find accessibility panel to reset button groups.");
    }
    // --- END MODIFICATION ---

    // Show confirmation
    showTooltip('All accessibility settings have been reset', 3000);
}

// --- ADDED: Function to move reading guide with mouse ---
function moveReadingGuide(e) {
    const readingGuide = document.getElementById('readingGuide');
    // --- ADDED: Null check and visibility check --- 
    if (readingGuide && readingGuide.style.display === 'block') { // Only move if visible
        try {
            const guideHeight = parseInt(readingGuide.style.height || '14', 10); // Get current height or default, ensure base 10
            // Position the guide centered vertically on the mouse cursor, spanning full width
            readingGuide.style.top = (e.clientY - (guideHeight / 2)) + 'px';
            readingGuide.style.left = '0';
            readingGuide.style.width = '100%';
        } catch (error) {
            console.error("Error calculating reading guide position:", error);
        }
    }
}
// --- END ADDED FUNCTION ---

// Add proper mouse tracking for reading guide
// --- MODIFIED: Added global flag and removed toggle change listener ---
function setupReadingGuideTracking() {
    const readingGuide = document.getElementById('readingGuide');
    const readingGuideToggle = document.getElementById('readingGuideToggle'); // Keep toggle reference for checking state

    if (!readingGuide || !readingGuideToggle) {
        console.warn("Reading Guide elements not found for tracking setup.");
        return;
    }

    const isEnabled = readingGuideToggle.checked; // Check current state

    if (isEnabled) {
        // Add listener only if it's not already attached
        if (!window.readingGuideMouseListenerAttached) {
            document.addEventListener('mousemove', moveReadingGuide);
            window.readingGuideMouseListenerAttached = true;
            console.log("Reading guide mousemove listener ADDED.");
        } else {
            console.log("Reading guide mousemove listener already attached.");
        }
    } else {
        // Remove listener only if it is currently attached
        if (window.readingGuideMouseListenerAttached) {
            document.removeEventListener('mousemove', moveReadingGuide);
            window.readingGuideMouseListenerAttached = false;
            console.log("Reading guide mousemove listener REMOVED.");
        } else {
            console.log("Reading guide mousemove listener already removed or never attached.");
        }
    }

    // The change listener for the toggle itself should be attached ONCE,
    // likely in enhanceReadingGuideOptions or initEnhancedAccessibility,
    // NOT repeatedly here.
    // Initialize toggle visual state from localStorage (if needed, though ideally done elsewhere too)
    const savedState = localStorage.getItem('readingGuide') === 'true';
    if (readingGuideToggle.checked !== savedState) {
        console.warn("Syncing toggle visual state in setupReadingGuideTracking.");
        readingGuideToggle.checked = savedState; // Sync visual
        // Guide display style should be handled by applySavedReadingGuideSettings called by the toggle change handler
    }
}
// --- END MODIFICATION ---

// --- ADDED: Ensure dyslexia font toggle handler saves state ---
// Function to handle dyslexia font toggle
function handleDyslexiaFontToggle(isEnabled) {
    if (isEnabled) {
        document.body.classList.add('dyslexia-font');
        localStorage.setItem('dyslexiaFont', 'true'); // SAVE STATE
        showTooltip('Dyslexia-Friendly Font Enabled', 2000);
    } else {
        document.body.classList.remove('dyslexia-font');
        localStorage.setItem('dyslexiaFont', 'false'); // SAVE STATE
        showTooltip('Dyslexia-Friendly Font Disabled', 2000);
    }
}
// --- END ADDED ---

// --- ADDED: Initialize toggle state from localStorage ---
const highContrastToggle = document.getElementById('highContrastToggle');
if (highContrastToggle) {
    // Initialize state from localStorage (already done by applySavedAccessibilitySettings)
    const savedHighContrast = localStorage.getItem('highContrastEnabled') === 'true';
    highContrastToggle.checked = savedHighContrast;
    // Add change event listener
    highContrastToggle.addEventListener('change', function () {
        // --- ADDED: Save state when toggled ---
        localStorage.setItem('highContrastEnabled', this.checked ? 'true' : 'false');
        // --- END ADDED ---
        handleHighContrastToggle(this.checked);
    });
}
// --- END ADDED ---

// --- NEW Function to Update Panel Controls ---
function updatePanelControlsFromStorage() {
    console.log("Updating panel controls from localStorage...");
    const panel = document.getElementById('accessibilityPanel');
    if (!panel) {
        console.warn("Panel not found, cannot update controls.");
        return;
    }

    // Find panel elements 
    const fontSizeSlider = panel.querySelector('#fontSizeSlider');
    const fontSizeValue = panel.querySelector('#fontSizeValue');
    const highContrastToggle = panel.querySelector('#highContrastToggle');
    const contrastThemeSelector = panel.querySelector('#contrastThemeSelector');
    const focusHighlightToggle = panel.querySelector('#focusHighlightToggle');
    const linksUnderlineToggle = panel.querySelector('#linksUnderlineToggle');
    const wordSpacingSlider = panel.querySelector('#wordSpacingSlider');
    const wordSpacingValue = panel.querySelector('#wordSpacingValue');
    const dyslexiaFontToggle = panel.querySelector('#dyslexiaFontToggle');
    const letterSpacingSlider = panel.querySelector('#letterSpacingSlider');
    const letterSpacingValue = panel.querySelector('#letterSpacingValue');
    const lineHeightSlider = panel.querySelector('#lineHeightSlider');
    const lineHeightValue = panel.querySelector('#lineHeightValue');
    const largeCursorToggle = panel.querySelector('#largeCursorToggle');
    const cursorSizeSelector = panel.querySelector('#cursorSizeSelector');
    const cursorColorPicker = panel.querySelector('#cursorColorPicker');
    const cursorColorValue = panel.querySelector('#cursorColorValue');
    const readingGuideToggle = panel.querySelector('#readingGuideToggle');
    const readingGuideColorPicker = panel.querySelector('#readingGuideColor');
    const readingGuideColorValue = panel.querySelector('#readingGuideColorValue');
    const readingGuideHeightSlider = panel.querySelector('#readingGuideHeightSlider');
    const readingGuideHeightValue = panel.querySelector('#readingGuideHeightValue');
    const readingGuideOpacitySlider = panel.querySelector('#readingGuideOpacitySlider');
    const readingGuideOpacityValue = panel.querySelector('#readingGuideOpacityValue');
    const readingGuideBorderStyleSelector = panel.querySelector('#readingGuideBorderStyle');

    // --- Update controls based on localStorage values ---

    // Font Size
    const savedFontSize = localStorage.getItem('fontSize') || '100';
    if (fontSizeSlider) fontSizeSlider.value = savedFontSize;
    if (fontSizeValue) fontSizeValue.textContent = savedFontSize + '%';

    // High Contrast & Theme
    const highContrastEnabled = localStorage.getItem('highContrastEnabled') === 'true';
    const savedTheme = localStorage.getItem('contrastTheme') || 'black-white';
    if (highContrastToggle) highContrastToggle.checked = highContrastEnabled;
    if (contrastThemeSelector) contrastThemeSelector.value = savedTheme;

    // Focus Highlight
    const focusHighlightEnabled = localStorage.getItem('focusHighlightEnabled') === 'true';
    if (focusHighlightToggle) focusHighlightToggle.checked = focusHighlightEnabled;

    // Links Underline
    const linksUnderlined = localStorage.getItem('linksUnderlined') === 'true';
    if (linksUnderlineToggle) linksUnderlineToggle.checked = linksUnderlined;

    // Text Spacing (Word)
    const savedWordSpacing = localStorage.getItem('wordSpacing') || '0';
    if (wordSpacingSlider) wordSpacingSlider.value = savedWordSpacing;
    if (wordSpacingValue) wordSpacingValue.textContent = savedWordSpacing + 'em';

    // Dyslexia Font
    const dyslexiaFontEnabled = localStorage.getItem('dyslexiaFont') === 'true';
    if (dyslexiaFontToggle) dyslexiaFontToggle.checked = dyslexiaFontEnabled;

    // Letter Spacing
    const savedLetterSpacing = localStorage.getItem('letterSpacing') || '0';
    if (letterSpacingSlider) letterSpacingSlider.value = savedLetterSpacing;
    if (letterSpacingValue) letterSpacingValue.textContent = savedLetterSpacing + 'px';

    // Line Height
    const savedLineHeight = localStorage.getItem('lineHeight') || '1.5';
    if (lineHeightSlider) lineHeightSlider.value = savedLineHeight;
    if (lineHeightValue) lineHeightValue.textContent = savedLineHeight;

    // Custom Cursor
    const largeCursorEnabled = localStorage.getItem('largeCursorEnabled') === 'true';
    const savedCursorSize = localStorage.getItem('cursorSize') || 'medium';
    const savedCursorColor = localStorage.getItem('cursorColor') || '#000000'; // Default black
    if (largeCursorToggle) largeCursorToggle.checked = largeCursorEnabled;
    if (cursorSizeSelector) cursorSizeSelector.value = savedCursorSize;
    if (cursorColorPicker) cursorColorPicker.value = savedCursorColor;
    if (cursorColorValue) cursorColorValue.textContent = savedCursorColor;

    // Reading Guide
    const readingGuideEnabled = localStorage.getItem('readingGuide') === 'true';
    const savedGuideColor = localStorage.getItem('readingGuideColor') || '#FFFF96';
    const savedGuideHeight = localStorage.getItem('readingGuideHeight') || '14';
    const savedGuideOpacity = localStorage.getItem('readingGuideOpacity') || '80';
    const savedGuideBorder = localStorage.getItem('readingGuideBorderStyle') || 'solid';
    if (readingGuideToggle) readingGuideToggle.checked = readingGuideEnabled;
    if (readingGuideColorPicker) readingGuideColorPicker.value = savedGuideColor;
    if (readingGuideColorValue) readingGuideColorValue.textContent = savedGuideColor;
    if (readingGuideHeightSlider) readingGuideHeightSlider.value = savedGuideHeight;
    if (readingGuideHeightValue) readingGuideHeightValue.textContent = savedGuideHeight + 'px';
    if (readingGuideOpacitySlider) readingGuideOpacitySlider.value = savedGuideOpacity;
    if (readingGuideOpacityValue) readingGuideOpacityValue.textContent = savedGuideOpacity + '%';
    if (readingGuideBorderStyleSelector) readingGuideBorderStyleSelector.value = savedGuideBorder;

    console.log("Panel controls updated.");
}
// --- END NEW Function ---

// Final initialization check to ensure dark mode is consistently applied
document.addEventListener('DOMContentLoaded', function () {
    // Double-check dark mode toggle state
    const savedMode = localStorage.getItem('darkMode');
    const isDarkMode = savedMode === 'true';
    const toggle = document.getElementById('dark-mode-toggle');

    // Ensure HTML and body classes are consistent with localStorage
    if (isDarkMode) {
        document.documentElement.classList.add('dark-mode');
        document.body.classList.add('dark-mode');
    } else {
        document.documentElement.classList.remove('dark-mode');
        document.body.classList.remove('dark-mode');
    }

    // Update emoji if needed
    if (toggle && typeof updateDarkModeToggleEmoji === 'function') {
        updateDarkModeToggleEmoji(isDarkMode, false);
    }

    console.log("Final dark mode consistency check complete.");
});

// --- ADDED: Footer Enhancement Initialization ---
// --- ADDED: Footer Enhancement Initialization ---
function initFooterEnhancements() {
    // 1. Content Updates (Run EVERY time to handle HTML re-checks/updates)
    console.log("Updating Footer Content (Date/Visitor Count)...");

    // Update Year Dynamically
    const yearSpan = document.getElementById('currentYear');
    if (yearSpan) {
        yearSpan.textContent = new Date().getFullYear();
    }

    // Dynamic Upcoming Events Dates (Relative to System Date)
    const eventParams = [
        { offset: 5, selector: '.footer-links a[href*="#event1"] .event-date, .event-item[data-event-url*="annual-day"] .event-date' },
        { offset: 12, selector: '.footer-links a[href*="#event2"] .event-date, .event-item[data-event-url*="science-fair"] .event-date' },
        { offset: 25, selector: '.footer-links a[href*="#event3"] .event-date, .event-item[data-event-url*="parent-meeting"] .event-date' }
    ];

    eventParams.forEach(item => {
        const els = document.querySelectorAll(item.selector);
        els.forEach(el => {
            const date = new Date();
            date.setDate(date.getDate() + item.offset);
            el.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
    });

    // Dynamic Footer Address (Replace Generic City)
    const footerAddress = document.querySelector('.site-footer address, footer address');
    if (footerAddress && !footerAddress.hasAttribute('data-dynamic-updated')) {
        footerAddress.innerHTML = `
            Suprapa High School Road,<br>
            Cooch Behar, West Bengal 736101<br>
            <i class="fas fa-phone"></i> <a href="tel:+919876543210">+91-9876543210</a><br>
            <i class="fas fa-envelope"></i> <a href="mailto:info@suprapahighschool.com">info@suprapahighschool.com</a>
         `;
        footerAddress.setAttribute('data-dynamic-updated', 'true');
    }

    // Update Last Updated Date
    const lastUpdatedSpan = document.getElementById('lastUpdated');
    if (lastUpdatedSpan) {
        // Dynamic date as requested
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        lastUpdatedSpan.textContent = `Last Updated: ${now.toLocaleDateString('en-US', options)}`;
    }

    // Visitor Counter Logic
    const visitorCountSpan = document.getElementById('visitorCount');
    if (visitorCountSpan) {
        try {
            // Start at 100, increment by 1 on each load locally
            let count = localStorage.getItem('visitorCountSHS');
            if (!count) {
                count = 100;
            } else {
                count = parseInt(count) + 1;
            }
            visitorCountSpan.textContent = count.toLocaleString();
            localStorage.setItem('visitorCountSHS', count);
        } catch (e) {
            console.error("Local storage access denied or error:", e);
            visitorCountSpan.textContent = "100+"; // Fallback
        }
    }
    const onlineCountSpan = document.getElementById('onlineCount');
    if (onlineCountSpan) {
        // Simulate online users (very basic)
        onlineCountSpan.textContent = Math.floor(Math.random() * 5) + 1;
    }

    // 2. Event Listeners & One-Time Setup (Guard Clause)
    if (document.body.dataset.footerEnhancementsInitialized === 'true') {
        console.log("Footer Event Listeners already attached. Skipping.");
        return;
    }
    document.body.dataset.footerEnhancementsInitialized = 'true';

    console.log("Initializing Footer Event Listeners...");

    // Back to top button functionality
    const backToTopButton = document.getElementById('backToTopBtn') || document.querySelector('.back-to-top');
    if (backToTopButton) {
        backToTopButton.addEventListener('click', (e) => {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // --- Initialize Translate Button Tooltip --- 
    initTranslateButtonTooltip();
    // --- End Initialize ---

    // Cookie Consent Logic
    const cookieConsent = document.getElementById('cookieConsent');
    const acceptCookiesBtn = document.getElementById('acceptCookies');
    if (cookieConsent && acceptCookiesBtn) {
        if (!localStorage.getItem('cookiesAcceptedSHS')) {
            cookieConsent.classList.add('show');
        }
        acceptCookiesBtn.addEventListener('click', () => {
            localStorage.setItem('cookiesAcceptedSHS', 'true');
            cookieConsent.classList.remove('show');
        });
    }

    // Initialize Newsletter Signup (Handles both Header and Footer forms)
    // Initialize Newsletter Signup (Delegated Event Listener for Robustness)
    // This handles both .newsletter-signup and .newsletter-signup-footer
    document.body.addEventListener('submit', function (e) {
        if (e.target && (e.target.matches('.newsletter-signup') || e.target.matches('.newsletter-signup-footer'))) {
            e.preventDefault();
            e.stopImmediatePropagation(); // Prevent other listeners from firing if any

            const form = e.target;
            const emailInput = form.querySelector('input[type="email"]');

            if (emailInput && emailInput.value) {
                const email = emailInput.value.trim().toLowerCase();
                const domain = email.split('@')[1];
                const allowedDomains = ['gmail.com', 'yahoo.com', 'outlook.com', 'hotmail.com', 'microsoft.com', 'proton.me', 'icloud.com'];

                if (domain && allowedDomains.includes(domain)) {
                    // Feedback UI
                    const submitBtn = form.querySelector('button');
                    const originalText = submitBtn ? submitBtn.textContent : 'Subscribe';

                    if (submitBtn) {
                        submitBtn.textContent = 'Subscribing...';
                        submitBtn.disabled = true;
                        submitBtn.style.cursor = 'wait';
                    }

                    // Simulate API delay
                    setTimeout(() => {
                        if (submitBtn) {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                            submitBtn.style.cursor = 'pointer';
                        }

                        // Use the existing showTooltip function if available, otherwise alert
                        if (typeof showTooltip === 'function') {
                            showTooltip(`Thank you for subscribing ${email}`, 4000);
                        } else {
                            alert(`Thank you for subscribing ${email}`);
                        }
                        emailInput.value = ''; // Clear input
                    }, 1500);

                } else {
                    // Invalid domain or format
                    if (typeof showTooltip === 'function') {
                        showTooltip('Please enter a valid email address.', 3000);
                    } else {
                        alert('Please enter a valid email address.');
                    }
                }
            } else {
                if (typeof showTooltip === 'function') {
                    showTooltip('Please enter a valid email address.', 3000);
                } else {
                    alert('Please enter a valid email address.');
                }
            }
        }
    }, true); // Use capture phase to ensure we catch it first if needed

    console.log("Newsletter event delegation attached.");

    console.log("Footer Enhancements Initialized.");
}

// Make sure enhancements run on load
document.addEventListener('DOMContentLoaded', function () {
    // Check if it's already called by the main accessibility init
    if (typeof initFooterEnhancements === 'function') {
        initFooterEnhancements();
    }
});

// --- ADDED: Translate Button Info Tooltip --- 
function initTranslateButtonTooltip() {
    const translateBtn = document.getElementById('translateInfoBtn');
    if (translateBtn) {
        translateBtn.addEventListener('click', function () {
            const message = 'How to Translate: Most browsers (Chrome, Edge, Firefox) let you right-click and choose "Translate to [Your Language]". On mobile, look for translate options in the browser menu (⋮). You can also use browser extensions or online tools.';
            showTooltip(message, 7000, 'info'); // Show for 7 seconds, type 'info'
        });
        console.log("Translate button tooltip initialized.");
    } else {
        // Only log warning if we expect this button on most pages
        // console.warn('Translate info button #translateInfoBtn not found during init.');
    }
}
// --- END ADDED ---

// --- Social Media Feeds --- 
function initSocialMediaFeeds() {
    const socialFeedContainer = document.querySelector('.social-feed-container');
    if (!socialFeedContainer) return;

    // Placeholder for social media feed integration
    // console.log('Social media feeds would be loaded here');

    socialFeedContainer.innerHTML = '<div class="loading">Loading social media feeds...</div>';

    // Simulate API call delay
    setTimeout(() => {
        const mockSocialPosts = [
            {
                platform: 'facebook',
                content: 'Congratulations to our students for their excellent performance in the district science competition!',
                date: '2 days ago',
                likes: 45
            },
            {
                platform: 'twitter',
                content: 'Registration for the upcoming summer camp is now open. Limited seats available!',
                date: '5 hours ago',
                likes: 23
            },
            {
                platform: 'instagram',
                content: 'Glimpses from our annual sports day celebration. Swipe to see more photos!',
                date: 'Yesterday',
                likes: 89
            }
        ];

        // SVGs for Icons - Simplified and Cleaned Paths
        const icons = {
            'facebook': '<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 320 512" fill="currentColor"><path d="M80 299.3 V 512 H 196 V 299.3 h 86.5 l 18 -97.8 H 196 V 166.9 c 0 -51.7 20.3 -71.5 72.7 -71.5 c 16.3 0 29.4 .4 37 1.2 V 7.9 C 291.4 4 256.4 0 236.2 0 C 129.3 0 80 50.5 80 159.4 v 42.1 H 14 v 97.8 H 80 z"/></svg>',
            'twitter': '<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="currentColor"><path d="M459.37 151.716c.325 4.548 .325 9.097 .325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447 .974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498 .974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.214 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>',
            'instagram': '<svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="currentColor"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg>'
        };

        // Render mock social posts
        socialFeedContainer.innerHTML = '';
        mockSocialPosts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.className = `social-post ${post.platform}`;
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="platform-icon ${post.platform}" style="width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; margin-right:10px;">${icons[post.platform]}</div>
                    <div>
                         <span class="social-platform-name">${post.platform}</span>
                         <span class="post-date" style="font-size:0.85em; color:#777;">${post.date}</span>
                    </div>
                </div>
                <div class="post-content social-content-text">
                    ${post.content}
                </div>
                <div class="post-footer" style="display:flex; justify-content:flex-end;">
                    <div class="post-likes" style="color:#e53e3e; font-size:0.9em;">❤️ ${post.likes} likes</div>
                </div>
            `;
            socialFeedContainer.appendChild(postElement);
        });
    }, 1200);
}
// --- END Social Media Feeds ---

// --- ADDED: Function to specifically apply saved reading guide settings ---
function applySavedReadingGuideSettings() {
    const readingGuide = document.getElementById('readingGuide');
    if (!readingGuide) {
        console.warn("applySavedReadingGuideSettings: Reading guide element not found.");
        return;
    }

    const savedGuideEnabled = localStorage.getItem('readingGuide') === 'true';
    const savedOpacity = localStorage.getItem('readingGuideOpacity') || '70'; // Consistent default
    const savedBorderStyle = localStorage.getItem('readingGuideBorderStyle') || 'solid';
    const savedGuideHeight = localStorage.getItem('readingGuideHeight') || '14';
    const savedGuideColor = localStorage.getItem('readingGuideColor') || '#FFFF96';

    console.log(`Applying saved reading guide settings: Enabled=${savedGuideEnabled}, Opacity=${savedOpacity}%, Border=${savedBorderStyle}, Height=${savedGuideHeight}px, Color=${savedGuideColor}`);

    if (savedGuideEnabled) {
        readingGuide.style.display = 'block';
        readingGuide.style.height = savedGuideHeight + 'px';

        // --- ADDED: Check function existence before calling helpers --- 
        if (typeof applyReadingGuideColor === 'function') {
            applyReadingGuideColor(savedGuideColor); // Apply color (handles opacity)
        } else { console.warn("applyReadingGuideColor function not found."); }

        if (typeof setReadingGuideBorder === 'function') {
            setReadingGuideBorder(savedBorderStyle); // Apply border
        } else { console.warn("setReadingGuideBorder function not found."); }
        // --- END ADDED --- 

        // --- MODIFIED: Call setup function to manage listener state --- 
        // Ensure tracking is active by calling the setup function
        if (typeof setupReadingGuideTracking === 'function') {
            setupReadingGuideTracking();
        } else {
            console.warn("setupReadingGuideTracking function not found when enabling guide.");
        }
        // --- END MODIFIED --- 

    } else {
        readingGuide.style.display = 'none';

        // --- MODIFIED: Call setup function to manage listener state --- 
        // Ensure tracking is inactive by calling the setup function
        if (typeof setupReadingGuideTracking === 'function') {
            setupReadingGuideTracking();
        } else {
            console.warn("setupReadingGuideTracking function not found when disabling guide.");
        }
        // --- END MODIFIED --- 
    }
}
// --- END ADDED ---

// ... existing code ...
const readingGuideToggle = document.getElementById('readingGuideToggle');
const readingGuideOptions = document.getElementById('readingGuideOptions');
const readingGuide = document.getElementById('readingGuide');

if (!readingGuideToggle || !readingGuideOptions || !readingGuide) {
    console.warn("Reading guide elements not found. Skipping enhancement.");
}

// Initial state based on localStorage (if available)
const isEnabled = localStorage.getItem('readingGuide') === 'true';
readingGuideToggle.checked = isEnabled;
readingGuideOptions.style.display = isEnabled ? 'block' : 'none';
if (isEnabled) {
    if (readingGuide) readingGuide.style.display = 'block';
    // --- ADDED: Apply saved opacity/border immediately on enable ---
    applySavedReadingGuideSettings();
    // --- END ADDED ---
    if (typeof setupReadingGuideTracking === 'function') {
        console.log("Setting up reading guide tracking on initial enable.");
        setupReadingGuideTracking();
    }
} else {
    if (readingGuide) readingGuide.style.display = 'none';
}


readingGuideToggle.addEventListener('change', function () {
    const enabled = this.checked;
    readingGuideOptions.style.display = enabled ? 'block' : 'none';
    if (readingGuide) readingGuide.style.display = enabled ? 'block' : 'none';
    localStorage.setItem('readingGuide', enabled); // Save state
    console.log(`Reading guide ${enabled ? 'enabled' : 'disabled'} and state saved.`);

    if (enabled) {
        // --- ADDED: Apply saved/default settings when toggled on ---
        applySavedReadingGuideSettings();
        // --- END ADDED ---
        if (typeof setupReadingGuideTracking === 'function') {
            console.log("Setting up reading guide tracking on toggle enable.");
            setupReadingGuideTracking();
        } else {
            console.warn("setupReadingGuideTracking function not found.");
        }
    } else {
        // Optional: Deactivate tracking if needed when disabled
        console.log("Reading guide disabled. Tracking might be implicitly stopped.");
    }
    showTooltip(`Reading guide ${enabled ? 'enabled' : 'disabled'}`);
});

// Opacity Slider
// ... existing code ...
const opacitySlider = document.getElementById('readingGuideOpacity');
const opacityValueSpan = document.getElementById('readingGuideOpacityValue');

if (opacitySlider && opacityValueSpan) {
    // --- ADDED: Set initial slider value from localStorage ---
    const savedOpacity = localStorage.getItem('readingGuideOpacity') || '50';
    opacitySlider.value = savedOpacity;
    opacityValueSpan.textContent = `${savedOpacity}%`;
    // Apply initial opacity (already done by applySavedReadingGuideSettings)
    // --- END ADDED ---

    opacitySlider.addEventListener('input', function () {
        const opacityPercent = parseInt(this.value, 10);
        opacityValueSpan.textContent = `${opacityPercent}%`;
        setReadingGuideOpacity(opacityPercent);
        localStorage.setItem('readingGuideOpacity', opacityPercent); // Save opacity
        console.log(`Reading guide opacity set to ${opacityPercent}% and saved.`);
        showTooltip(`Reading guide opacity: ${opacityPercent}%`);
    });
} else {
    console.warn("Reading guide opacity controls not found.");
}

// Border Style Select
const borderStyleSelect = document.getElementById('readingGuideBorderStyle');

if (borderStyleSelect) {
    // --- ADDED: Set initial select value from localStorage ---
    const savedBorderStyle = localStorage.getItem('readingGuideBorderStyle') || 'solid';
    borderStyleSelect.value = savedBorderStyle;
    // Apply initial border style (already done by applySavedReadingGuideSettings)
    // --- END ADDED ---

    borderStyleSelect.addEventListener('change', function () {
        const borderStyle = this.value;
        setReadingGuideBorder(borderStyle);
        localStorage.setItem('readingGuideBorderStyle', borderStyle); // Save border style
        console.log(`Reading guide border style set to ${borderStyle} and saved.`);
        showTooltip(`Reading guide border: ${borderStyle}`);
    });
} else {
    console.warn("Reading guide border style select not found.");
}

// Function to set reading guide opacity
function setReadingGuideOpacity(opacityPercent) {
    const readingGuide = document.getElementById('readingGuide');
    if (readingGuide) {
        const opacityValue = opacityPercent / 100;
        // Use background-color with alpha for better compatibility
        // Assuming the guide uses background-color for its appearance
        // Get current background color (or default) and apply new alpha
        let currentColor = window.getComputedStyle(readingGuide).backgroundColor;
        if (!currentColor || currentColor === 'rgba(0, 0, 0, 0)' || currentColor === 'transparent') {
            // Default color if none is set or it's transparent
            // Let's try getting the color from localStorage if custom color is implemented
            const savedColor = localStorage.getItem('readingGuideColor') || 'rgba(100, 100, 255, 0.5)'; // Default blueish guide color
            currentColor = savedColor; // Use saved or default
        }

        // Parse the color and apply new alpha
        try {
            // Basic RGBA parsing (improve if handling hex, hsl etc.)
            let parts = currentColor.match(/(\d+(\.\d+)?)/g);
            if (parts && parts.length >= 3) {
                readingGuide.style.backgroundColor = `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${opacityValue})`;
            } else {
                // Fallback if parsing fails - apply default color with new opacity
                readingGuide.style.backgroundColor = `rgba(100, 100, 255, ${opacityValue})`;
                console.warn("Could not parse existing reading guide color, applied default with new opacity.");
            }
        } catch (e) {
            console.error("Error setting reading guide background color with opacity:", e);
            // Fallback
            readingGuide.style.backgroundColor = `rgba(100, 100, 255, ${opacityValue})`;
        }

        // Also save the opacity setting itself for persistence
        localStorage.setItem('readingGuideOpacity', opacityPercent);
        console.log(`Enhanced accessibility: Set reading guide opacity to ${opacityPercent}%`);
    } else {
        console.warn("Enhanced accessibility: Reading guide element not found for opacity change.");
    }
}

// Function to set reading guide border style
function setReadingGuideBorder(style) {
    const readingGuide = document.getElementById('readingGuide');
    if (readingGuide) {
        // Assuming border style applies to top/bottom borders primarily
        readingGuide.style.borderTopStyle = style;
        readingGuide.style.borderBottomStyle = style;
        // Example: Ensure there's a default border width and color if setting style
        if (style !== 'none') {
            if (!readingGuide.style.borderTopWidth || readingGuide.style.borderTopWidth === '0px') {
                readingGuide.style.borderTopWidth = '2px'; // Default width
            }
            if (!readingGuide.style.borderBottomWidth || readingGuide.style.borderBottomWidth === '0px') {
                readingGuide.style.borderBottomWidth = '2px'; // Default width
            }
            if (!readingGuide.style.borderTopColor || readingGuide.style.borderTopColor === 'transparent') {
                readingGuide.style.borderTopColor = 'blue'; // Default color
            }
            if (!readingGuide.style.borderBottomColor || readingGuide.style.borderBottomColor === 'transparent') {
                readingGuide.style.borderBottomColor = 'blue'; // Default color
            }
        }
        localStorage.setItem('readingGuideBorderStyle', style); // Save style
        console.log(`Enhanced accessibility: Set reading guide border style to ${style}`);
    } else {
        console.warn("Enhanced accessibility: Reading guide element not found for border style change.");
    }
}

// --- ADDED: Reading Guide Color Picker Logic ---
function enhanceReadingGuideColorPicker() {
    const colorPicker = document.getElementById('readingGuideColorPicker');
    const readingGuide = document.getElementById('readingGuide');

    if (!colorPicker || !readingGuide) {
        console.warn("Reading guide color picker or guide element not found. Skipping enhancement.");
        return;
    }

    // Load saved color or default
    const savedColor = localStorage.getItem('readingGuideColor') || '#6464FF'; // Default blueish color matching opacity function
    colorPicker.value = savedColor;
    // Apply initial color (respecting saved opacity)
    applyReadingGuideColor(savedColor);

    colorPicker.addEventListener('input', function () {
        const newColor = this.value;
        applyReadingGuideColor(newColor);
        localStorage.setItem('readingGuideColor', newColor); // Save color
        console.log(`Reading guide color set to ${newColor} and saved.`);
        showTooltip(`Reading guide color changed`);
    });
}

function applyReadingGuideColor(hexColor) {
    const readingGuide = document.getElementById('readingGuide');
    if (!readingGuide) return;

    const savedOpacityPercent = parseInt(localStorage.getItem('readingGuideOpacity') || '50', 10);
    const opacityValue = savedOpacityPercent / 100;

    // Convert hex to rgba
    let r = 0, g = 0, b = 0;
    if (hexColor.length === 7) {
        r = parseInt(hexColor.substring(1, 3), 16);
        g = parseInt(hexColor.substring(3, 5), 16);
        b = parseInt(hexColor.substring(5, 7), 16);
    } else if (hexColor.length === 4) { // Handle shorthand hex
        r = parseInt(hexColor.substring(1, 2) + hexColor.substring(1, 2), 16);
        g = parseInt(hexColor.substring(2, 3) + hexColor.substring(2, 3), 16);
        b = parseInt(hexColor.substring(3, 4) + hexColor.substring(3, 4), 16);
    } else {
        console.warn("Invalid hex color format for reading guide:", hexColor);
        // Optionally revert to default or do nothing
        return;
    }

    readingGuide.style.backgroundColor = `rgba(${r}, ${g}, ${b}, ${opacityValue})`;
}

// Function to update panel controls based on localStorage
function updatePanelControlsFromStorage() {
    console.log("Updating panel controls from localStorage...");
    const panel = document.getElementById('accessibilityPanel');
    if (!panel) {
        console.warn("Accessibility panel not found. Cannot update controls.");
        return;
    }
    const panelContent = panel.querySelector('.accessibility-panel-content');
    if (!panelContent) {
        console.warn("Accessibility panel content not found. Cannot update controls.");
        return;
    }

    try {
        // Font Size
        const fontSizeSlider = panelContent.querySelector('#fontSizeSlider');
        const fontSizeValue = panelContent.querySelector('#fontSizeValue');
        if (fontSizeSlider && fontSizeValue) {
            const savedFontSize = localStorage.getItem('fontSize') || '100';
            fontSizeSlider.value = savedFontSize;
            fontSizeValue.textContent = `${savedFontSize}%`;
        }

        // High Contrast & Theme
        const highContrastToggle = panelContent.querySelector('#highContrastToggle');
        const contrastThemeButtons = panelContent.querySelectorAll('.contrast-theme-btn');
        if (highContrastToggle) {
            highContrastToggle.checked = localStorage.getItem('highContrastEnabled') === 'true';
        }
        if (contrastThemeButtons.length > 0) {
            const savedContrastTheme = localStorage.getItem('contrastTheme') || 'black-white';
            const customColorsDiv = panelContent.querySelector('.custom-contrast-colors');
            contrastThemeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === savedContrastTheme) {
                    btn.classList.add('active');
                }
            });
            if (customColorsDiv) {
                customColorsDiv.style.display = savedContrastTheme === 'custom' ? 'block' : 'none';
            }
            // Update custom color picker values
            const bgColorPicker = panelContent.querySelector('#contrastBgColorPicker');
            const bgColorValue = panelContent.querySelector('#contrastBgColorValue');
            const textColorPicker = panelContent.querySelector('#contrastTextColorPicker');
            const textColorValue = panelContent.querySelector('#contrastTextColorValue');
            const linkColorPicker = panelContent.querySelector('#contrastLinkColorPicker');
            const linkColorValue = panelContent.querySelector('#contrastLinkColorValue');
            if (bgColorPicker && bgColorValue) {
                bgColorPicker.value = localStorage.getItem('contrastBgColor') || '#000000';
                bgColorValue.textContent = bgColorPicker.value;
            }
            if (textColorPicker && textColorValue) {
                textColorPicker.value = localStorage.getItem('contrastTextColor') || '#FFFFFF';
                textColorValue.textContent = textColorPicker.value;
            }
            if (linkColorPicker && linkColorValue) {
                linkColorPicker.value = localStorage.getItem('contrastLinkColor') || '#FFFF00';
                linkColorValue.textContent = linkColorPicker.value;
            }
        }


        // Reading Guide
        const readingGuideToggle = panelContent.querySelector('#readingGuideToggle');
        const opacitySlider = panelContent.querySelector('#readingGuideOpacitySlider');
        const opacityValueSpan = panelContent.querySelector('#readingGuideOpacityValue');
        const borderButtons = panelContent.querySelectorAll('.border-style-btn');
        const colorPicker = panelContent.querySelector('#readingGuideColor');
        const colorValueSpan = panelContent.querySelector('#readingGuideColorValue');
        const heightSlider = panelContent.querySelector('#readingGuideHeightSlider');
        const heightValueSpan = panelContent.querySelector('#readingGuideHeightValue');

        if (readingGuideToggle) readingGuideToggle.checked = localStorage.getItem('readingGuide') === 'true';

        if (opacitySlider && opacityValueSpan) {
            const savedOpacity = localStorage.getItem('readingGuideOpacity') || '70';
            opacitySlider.value = savedOpacity;
            opacityValueSpan.textContent = `${savedOpacity}%`;
        }

        if (borderButtons.length > 0) {
            const savedBorderStyle = localStorage.getItem('readingGuideBorderStyle') || 'solid';
            borderButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.style === savedBorderStyle) {
                    btn.classList.add('active');
                }
            });
        }

        if (colorPicker && colorValueSpan) {
            const savedColor = localStorage.getItem('readingGuideColor') || '#FFFF96';
            colorPicker.value = savedColor;
            colorValueSpan.textContent = savedColor;
        }
        if (heightSlider && heightValueSpan) {
            const savedHeight = localStorage.getItem('readingGuideHeight') || '14';
            heightSlider.value = savedHeight;
            heightValueSpan.textContent = `${savedHeight}px`;
        }

        // Large Cursor
        const largeCursorToggle = panelContent.querySelector('#largeCursorToggle');
        const cursorSizeButtons = panelContent.querySelectorAll('.cursor-size-btn');
        const cursorColorPicker = panelContent.querySelector('#cursorColorPicker');
        const cursorColorValue = panelContent.querySelector('#cursorColorValue');

        if (largeCursorToggle) largeCursorToggle.checked = localStorage.getItem('largeCursorEnabled') === 'true';

        if (cursorSizeButtons.length > 0) {
            const savedCursorSize = localStorage.getItem('cursorSize') || 'medium';
            cursorSizeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.size === savedCursorSize) {
                    btn.classList.add('active');
                }
            });
        }
        if (cursorColorPicker && cursorColorValue) {
            const savedCursorColor = localStorage.getItem('cursorColor') || '#85C0FF'; // Default blue
            cursorColorPicker.value = savedCursorColor;
            cursorColorValue.textContent = savedCursorColor;
        }

        // Other toggles
        const focusHighlightToggle = panelContent.querySelector('#focusHighlightToggle');
        if (focusHighlightToggle) focusHighlightToggle.checked = localStorage.getItem('focusHighlightEnabled') === 'true';

        const linksUnderlineToggle = panelContent.querySelector('#linksUnderlineToggle');
        if (linksUnderlineToggle) linksUnderlineToggle.checked = localStorage.getItem('linksUnderlined') === 'true';

        const dyslexiaFontToggle = panelContent.querySelector('#dyslexiaFontToggle');
        if (dyslexiaFontToggle) dyslexiaFontToggle.checked = localStorage.getItem('dyslexiaFont') === 'true';

        console.log("Panel controls updated from storage.");
    } catch (e) {
        console.error("Error updating panel controls from storage:", e);
    }
}
document.addEventListener('DOMContentLoaded', function () {
    const navbar = document.querySelector('.main-navbar'); // Adjust selector if needed
    if (!navbar) {
        console.warn("Main navbar not found for dropdown handling.");
        return;
    }

    const dropdownToggles = navbar.querySelectorAll('.dropdown > a.dropdown-toggle');
    const dropdownMenus = navbar.querySelectorAll('.dropdown-menu');
    let currentlyOpenDropdown = null;
    let hoverTimeout = null;

    function closeAllDropdowns(exceptThisOne = null) {
        navbar.querySelectorAll('.dropdown.open').forEach(openDropdown => {
            if (openDropdown !== exceptThisOne) {
                openDropdown.classList.remove('open');
                // Ensure related attributes are reset if Bootstrap is managing them
                const toggle = openDropdown.querySelector('.dropdown-toggle');
                if (toggle) {
                    toggle.setAttribute('aria-expanded', 'false');
                }
            }
        });
        currentlyOpenDropdown = exceptThisOne ? exceptThisOne.closest('.dropdown') : null;
    }

    // Function to handle opening/closing logic
    function toggleDropdown(dropdownElement, forceOpen = false, forceClose = false) {
        if (!dropdownElement) return;

        const isOpen = dropdownElement.classList.contains('open');

        if (forceClose) {
            if (isOpen) {
                dropdownElement.classList.remove('open');
                currentlyOpenDropdown = null;
                const toggle = dropdownElement.querySelector('.dropdown-toggle');
                if (toggle) toggle.setAttribute('aria-expanded', 'false');
            }
            return; // Stop here if forced close
        }

        if (forceOpen) {
            if (!isOpen) {
                closeAllDropdowns(dropdownElement); // Close others first
                dropdownElement.classList.add('open');
                currentlyOpenDropdown = dropdownElement;
                const toggle = dropdownElement.querySelector('.dropdown-toggle');
                if (toggle) toggle.setAttribute('aria-expanded', 'true');
            }
            return; // Stop here if forced open
        }

        // Default toggle behavior
        if (isOpen) {
            dropdownElement.classList.remove('open');
            currentlyOpenDropdown = null;
            const toggle = dropdownElement.querySelector('.dropdown-toggle');
            if (toggle) toggle.setAttribute('aria-expanded', 'false');
        } else {
            closeAllDropdowns(dropdownElement); // Close others first
            dropdownElement.classList.add('open');
            currentlyOpenDropdown = dropdownElement;
            const toggle = dropdownElement.querySelector('.dropdown-toggle');
            if (toggle) toggle.setAttribute('aria-expanded', 'true');
        }
    }

    // --- Event Listeners ---
    dropdownToggles.forEach(toggle => {
        const dropdownLi = toggle.closest('.dropdown');
        if (!dropdownLi) return;

        // --- Click Behavior (Mobile & Desktop) ---
        toggle.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent default link behavior
            event.stopPropagation(); // Prevent event bubbling

            console.log("Dropdown toggle clicked:", this.textContent);

            // Simple toggle on click for both mobile and desktop based on user request
            toggleDropdown(dropdownLi);

            /* // Old logic differentiating click behavior:
            if (window.innerWidth < 768) {
                // Mobile: Simple toggle
                toggleDropdown(dropdownLi);
            } else {
                // Desktop: Click makes it stay open, second click closes
                // If it's already open (likely from hover or previous click), close it.
                // Otherwise, force it open (and close others).
                if (dropdownLi.classList.contains('open')) {
                     toggleDropdown(dropdownLi, false, true); // Force close
                } else {
                    toggleDropdown(dropdownLi, true); // Force open
                }
            }
            */
        });

        // --- Hover Behavior (Desktop Only) --- DISABLED
        /*
        if (window.innerWidth >= 768) {
            dropdownLi.addEventListener('mouseenter', function() {
                 clearTimeout(hoverTimeout); // Clear any pending close timeout
                 // Temporarily add 'open' for hover effect (Bootstrap CSS might handle this visually)
                 // Do not use toggleDropdown here as it manages the persistent 'click' state.
                 // Instead, rely on CSS :hover or add a temporary class if needed.
                 // For Bootstrap v3, adding 'open' might be necessary for hover visibility.
                 // Let's try adding 'open' directly but ensure click logic overrides correctly.
 
                 // Option 1: Rely purely on CSS :hover (if theme supports it) - Preferred if possible
                 // No JS action needed here for visibility if CSS handles it.
 
                 // Option 2: Add 'open' class temporarily on hover, but be careful with clicks
                 // closeAllDropdowns(dropdownLi); // Close others if needed on hover
                 // if (!dropdownLi.classList.contains('open')) { // Only add if not already open via click
                 //    dropdownLi.classList.add('open');
                 // }
 
                 // Option 3: Refined - Add a distinct hover class
                 closeAllDropdowns(dropdownLi); // Close others first
                 if (!dropdownLi.classList.contains('open')) { // Only add hover class if not permanently open
                    dropdownLi.classList.add('hover-open');
                 }
            });
 
            dropdownLi.addEventListener('mouseleave', function() {
                 // Option 1: No action if CSS handles hover state removal.
 
                 // Option 2: Remove 'open' if it was added ONLY for hover
                 // hoverTimeout = setTimeout(() => {
                 //    // Only remove 'open' if it wasn't the result of a persistent click
                 //    // This requires more complex state tracking (e.g., a data attribute)
                 //    // For simplicity with Bootstrap 3, clicking might be the primary mechanism
                 //    if (currentlyOpenDropdown !== dropdownLi) { // Basic check: don't close if it's the 'clicked open' one
                 //       dropdownLi.classList.remove('open');
                 //    }
                 // }, 100); // Small delay
 
                  // Option 3: Remove the distinct hover class
                 hoverTimeout = setTimeout(() => {
                    dropdownLi.classList.remove('hover-open');
                 }, 100); // Small delay
            });
        }
        */
    });

    // Close dropdowns if clicking outside the navbar
    document.addEventListener('click', function (event) {
        if (!navbar.contains(event.target)) {
            closeAllDropdowns();
        }
    });

    // Close dropdowns on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeAllDropdowns();
        }
    });

    // Re-apply listeners on resize potentially (or adjust logic based on current size)
    // Basic resize check (could be improved with debouncing)
    window.addEventListener('resize', () => {
        // This is tricky. Re-adding listeners might cause duplicates.
        // Better to check window.innerWidth inside the handlers if behavior needs to change dynamically.
        // For now, the initial check on load determines hover behavior setup.
    });
}); 